<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SportsOnline Agenda Dinámica</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;400;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0;
        }
        h1, h2, .font-teko {
            font-family: 'Teko', sans-serif;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #2563eb;
        }

        /* Neon Glow Effects */
        .neon-text {
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.7);
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }

        /* Animation */
        @keyframes pulse-live {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .live-indicator {
            animation: pulse-live 2s infinite;
        }

        .tab-active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .tab-inactive {
            background-color: transparent;
            color: #94a3b8;
            border-color: #334155;
        }
        .tab-inactive:hover {
            border-color: #64748b;
            color: #cbd5e1;
        }

        /* Fullscreen Modal Styles */
        #videoModal {
            background-color: black;
        }
        
        .modal-header-overlay {
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
            transition: opacity 0.5s ease;
            opacity: 1;
        }

        .iframe-wrapper {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }
        .iframe-wrapper iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Hide scrollbar visually but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-slate-950">

    <!-- Header -->
    <header class="flex-none bg-slate-900 border-b border-slate-800 shadow-lg z-20">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-satellite-dish text-blue-500 text-3xl animate-pulse"></i>
                <div>
                    <h1 class="text-4xl font-bold tracking-wide text-white uppercase neon-text leading-none">Sports<span class="text-blue-500">Online</span></h1>
                    <p class="text-xs text-slate-400 tracking-widest uppercase">Agenda Premium</p>
                </div>
            </div>
            
            <!-- Search Bar -->
            <div class="hidden md:flex relative w-1/3">
                <input type="text" id="searchInput" placeholder="Buscar equipo, liga o evento..." 
                    class="w-full bg-slate-800 text-white border border-slate-700 rounded-full py-2 pl-10 pr-4 focus:outline-none focus:border-blue-500 transition-all">
                <i class="fa-solid fa-search absolute left-3 top-3 text-slate-500"></i>
            </div>

            <!-- Social / Info -->
            <div class="flex items-center gap-4">
                <div id="statusIndicator" class="flex items-center gap-2 text-xs font-mono text-slate-500">
                    <span class="w-2 h-2 rounded-full bg-yellow-500"></span> Cargando...
                </div>
                <a href="https://t.me/+dKQrC5sC0j80Yzk0" target="_blank" class="text-slate-300 hover:text-blue-400 transition-colors flex items-center gap-2 text-sm font-bold bg-slate-800 px-3 py-1 rounded-lg border border-slate-700">
                    <i class="fa-brands fa-telegram text-xl"></i> <span class="hidden sm:inline">TELEGRAM</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col overflow-hidden relative">
        
        <!-- Day Tabs -->
        <div class="flex-none bg-slate-900/95 backdrop-blur-sm border-b border-slate-800 sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-2 overflow-x-auto no-scrollbar">
                <div class="flex space-x-2 py-3" id="dayTabs">
                    <div class="px-4 text-slate-500">Cargando agenda...</div>
                </div>
            </div>
        </div>

        <!-- Events List -->
        <div class="flex-1 overflow-y-auto p-4 bg-gradient-to-b from-slate-950 to-slate-900">
            <div class="max-w-6xl mx-auto space-y-3" id="eventsContainer">
                <div class="flex flex-col justify-center items-center h-64 text-slate-500">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
                    <p>Conectando a fuentes oficiales...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Video Modal (Full Page Overlay) -->
    <div id="videoModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-header-overlay absolute top-0 left-0 w-full p-4 flex justify-between items-center z-50" id="modalHeader">
            <div class="flex items-center gap-2 bg-black/50 backdrop-blur-md px-3 py-1 rounded-full border border-white/10">
                <span class="w-3 h-3 bg-red-600 rounded-full live-indicator"></span>
                <span class="text-white font-bold tracking-wider text-sm shadow-black drop-shadow-md" id="modalTitle">EN VIVO</span>
            </div>
            <button onclick="closeModal()" class="text-white hover:text-red-400 bg-black/50 hover:bg-black/80 backdrop-blur-md px-4 py-2 rounded-lg border border-white/10 transition-all uppercase font-bold text-sm flex items-center gap-2">
                <i class="fa-solid fa-xmark"></i> <span class="hidden sm:inline">Cerrar</span>
            </button>
        </div>

        <div class="iframe-wrapper">
            <iframe id="playerFrame" src="" allowfullscreen allow="autoplay; encrypted-media" sandbox="allow-forms allow-pointer-lock allow-same-origin allow-scripts allow-top-navigation"></iframe>
        </div>
    </div>

    <script>
        // ======================
        // CONFIGURACIÓN
        // ======================
        const USE_PROXY = true;
        const proxy = (url) => USE_PROXY ? `https://api.codetabs.com/v1/proxy/?quest=${encodeURIComponent(url)}` : url;

        const SOURCES = [
            { url: 'https://golazoplay.com/agenda.json?v=1.0', lang: 'en' },
            { url: 'https://a.ftvhd.com/diaries.json', lang: 'es' }
        ];

        const dayMap = {
            monday: "LUNES",
            tuesday: "MARTES",
            wednesday: "MIERCOLES",
            thursday: "JUEVES",
            friday: "VIERNES",
            saturday: "SABADO",
            sunday: "DOMINGO"
        };

        let parsedSchedule = {};
        let allEvents = [];
        let currentDayFilter = '';

        // ======================
        // UTILIDADES
        // ======================
        function normalizeDay(day, lang) {
            let d = day.trim().toUpperCase();
            if (lang === 'en') {
                d = dayMap[day.toLowerCase()] || d;
            }
            if (d === "MIERCOLES") d = "MIÉRCOLES";
            if (d === "SABADO") d = "SÁBADO";
            return d;
        }

        // ======================
        // CARGA Y COMBINACIÓN
        // ======================
        async function fetchAndCombineSchedules() {
            const statusEl = document.getElementById('statusIndicator');
            statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-yellow-500"></span> Cargando...';
            statusEl.className = 'flex items-center gap-2 text-xs font-mono text-yellow-400';

            let combinedEvents = [];

            try {
                for (const source of SOURCES) {
                    const res = await fetch(proxy(source.url));
                    if (!res.ok) throw new Error(`Error al cargar ${source.url}: ${res.status}`);
                    const data = await res.json();

                    for (let [dayKey, events] of Object.entries(data)) {
                        if (!Array.isArray(events)) continue;

                        const normalizedDay = normalizeDay(dayKey, source.lang);

                        events.forEach(ev => {
                            let time, title, link;
                            if (source.lang === 'en') {
                                time = ev.hour;
                                title = ev.event;
                                link = ev.url;
                            } else {
                                time = ev.hora;
                                title = ev.partido;
                                link = ev.enlace;
                            }

                            if (time && title && link && typeof link === 'string' && link.startsWith('http')) {
                                combinedEvents.push({
                                    day: normalizedDay,
                                    time,
                                    title,
                                    link,
                                    id: Math.random().toString(36).substr(2, 9)
                                });
                            }
                        });
                    }
                }

                // Agrupar por día
                const schedule = {};
                combinedEvents.forEach(ev => {
                    if (!schedule[ev.day]) schedule[ev.day] = [];
                    schedule[ev.day].push(ev);
                });

                // Ordenar eventos por hora
                for (const day in schedule) {
                    schedule[day].sort((a, b) => {
                        const [h1, m1] = a.time.split(':').map(Number);
                        const [h2, m2] = b.time.split(':').map(Number);
                        return (h1 * 60 + m1) - (h2 * 60 + m2);
                    });
                }

                // Orden de días
                const dayOrder = ["LUNES", "MARTES", "MIÉRCOLES", "JUEVES", "VIERNES", "SÁBADO", "DOMINGO"];
                const sortedDays = Object.keys(schedule).sort((a, b) => dayOrder.indexOf(a) - dayOrder.indexOf(b));

                statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Online';
                statusEl.className = 'flex items-center gap-2 text-xs font-mono text-green-400';

                return { schedule, allEvents: combinedEvents, days: sortedDays };
            } catch (error) {
                console.error("Error:", error);
                statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> Error';
                statusEl.className = 'flex items-center gap-2 text-xs font-mono text-red-400';

                document.getElementById('eventsContainer').innerHTML = `
                    <div class="text-center mt-20 text-red-400">
                        <i class="fa-solid fa-triangle-exclamation text-4xl mb-4"></i>
                        <h2 class="text-2xl font-bold">Error al cargar las agendas</h2>
                        <p class="mt-2 text-slate-400">${error.message || 'No se pudieron combinar los datos.'}</p>
                        <button onclick="location.reload()" class="mt-6 bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded">Reintentar</button>
                    </div>
                `;
                return null;
            }
        }

        // ======================
        // RENDERIZADO
        // ======================
        function renderTabs(days) {
            const tabsContainer = document.getElementById('dayTabs');
            if (days.length === 0) {
                tabsContainer.innerHTML = '<div class="px-4 text-slate-500">Sin datos</div>';
                return;
            }

            tabsContainer.innerHTML = '';
            days.forEach((day, index) => {
                const btn = document.createElement('button');
                btn.className = `whitespace-nowrap px-6 py-2 rounded-full font-teko text-xl tracking-wider border-2 transition-all duration-300 ${index === 0 ? 'tab-active' : 'tab-inactive'}`;
                btn.innerText = day;
                btn.onclick = () => switchTab(day, btn);
                tabsContainer.appendChild(btn);
            });

            if (days.length > 0) switchTab(days[0], tabsContainer.firstChild);
        }

        function switchTab(day, btnElement) {
            currentDayFilter = day;
            const tabs = document.getElementById('dayTabs').children;
            for (let tab of tabs) {
                tab.classList.remove('tab-active');
                tab.classList.add('tab-inactive');
            }
            if (btnElement) {
                btnElement.classList.remove('tab-inactive');
                btnElement.classList.add('tab-active');
            }

            const dayEvents = parsedSchedule[day] || [];
            renderEvents(dayEvents);
        }

        function renderEvents(events) {
            const container = document.getElementById('eventsContainer');
            container.innerHTML = '';

            if (events.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 mt-10 text-xl">No hay eventos para este día.</div>';
                return;
            }

            events.forEach(event => {
                let iconClass = 'fa-futbol';
                const lowerTitle = event.title.toLowerCase();
                if (lowerTitle.includes('nba') || lowerTitle.includes('basketball') || lowerTitle.includes('baloncesto')) iconClass = 'fa-basketball';
                if (lowerTitle.includes('nfl') || lowerTitle.includes('fútbol americano')) iconClass = 'fa-football';
                if (lowerTitle.includes('tennis') || lowerTitle.includes('tenis')) iconClass = 'fa-table-tennis-paddle-ball';
                if (lowerTitle.includes('f1') || lowerTitle.includes('racing') || lowerTitle.includes('carrera')) iconClass = 'fa-flag-checkered';
                if (lowerTitle.includes('dardos') || lowerTitle.includes('darts')) iconClass = 'fa-bullseye';
                if (lowerTitle.includes('cricket')) iconClass = 'fa-baseball-bat-ball';

                let channelName = "STREAM";
                if (event.link.includes('br')) channelName = "BRASIL";
                if (event.link.includes('pt')) channelName = "PORTUGAL";
                if (event.link.includes('hd')) {
                    const match = event.link.match(/hd\d*/i);
                    if (match) channelName = match[0].toUpperCase();
                }

                const card = document.createElement('div');
                card.className = "flex flex-col md:flex-row bg-slate-800/50 border border-slate-700 rounded-xl p-4 items-center gap-4 card-hover transition-all duration-200 group";

                card.innerHTML = `
                    <div class="flex items-center gap-4 w-full md:w-auto">
                        <div class="bg-slate-900 rounded-lg p-3 text-center min-w-[80px] border border-slate-700 shadow-inner">
                            <div class="text-blue-400 font-teko text-2xl">${event.time}</div>
                            <div class="text-[10px] text-slate-500 uppercase tracking-widest">Hora</div>
                        </div>
                        <div class="md:hidden flex-grow font-bold text-slate-400 text-sm text-right">${channelName}</div>
                    </div>

                    <div class="flex-grow w-full text-center md:text-left border-l-0 md:border-l border-slate-700 md:pl-4 border-t md:border-t-0 pt-3 md:pt-0 mt-2 md:mt-0">
                        <h3 class="text-lg font-bold text-white group-hover:text-blue-400 transition-colors flex items-center md:justify-start justify-center gap-2">
                            <i class="fa-solid ${iconClass} text-slate-600 group-hover:text-blue-500"></i>
                            ${event.title}
                        </h3>
                        <p class="text-xs text-slate-500 mt-1 uppercase tracking-wider hidden md:block">
                            <span class="bg-slate-700 text-slate-300 px-1 rounded">${channelName}</span>
                        </p>
                    </div>

                    <button onclick="playChannel('${event.link.replace(/'/g, "\\'")}', '${event.title.replace(/'/g, "\\'")}')"
                            class="w-full md:w-auto bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg shadow-blue-600/30 transition-all flex items-center justify-center gap-2 group-hover:scale-105">
                        <i class="fa-solid fa-play"></i> VER AHORA
                    </button>
                `;
                container.appendChild(card);
            });
        }

        // ======================
        // REPRODUCTOR
        // ======================
        function playChannel(originalUrl, title) {
            const modal = document.getElementById('videoModal');
            const iframe = document.getElementById('playerFrame');
            const modalTitle = document.getElementById('modalTitle');
            const header = document.getElementById('modalHeader');

            // Puedes modificar este proxy si usas otro
            const finalUrl = `https://premiumgeny4k.blogspot.com/?get=${encodeURIComponent(originalUrl)}`;
            
            iframe.src = finalUrl;
            modalTitle.innerText = title;
            modal.classList.remove('hidden');

            // Intentar fullscreen
            if (modal.requestFullscreen) modal.requestFullscreen().catch(() => {});
            else if (modal.webkitRequestFullscreen) modal.webkitRequestFullscreen();

            // Ocultar header después de 3 segundos
            setTimeout(() => {
                if (!modal.classList.contains('hidden')) {
                    header.style.opacity = '0';
                }
            }, 3000);
        }

        function closeModal() {
            const modal = document.getElementById('videoModal');
            const iframe = document.getElementById('playerFrame');
            const header = document.getElementById('modalHeader');
            
            modal.classList.add('hidden');
            iframe.src = "";
            header.style.opacity = '1';

            if (document.fullscreenElement) {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
            }
        }

        // ======================
        // BÚSQUEDA
        // ======================
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase().trim();
            if (term === '') {
                if (currentDayFilter) {
                    switchTab(currentDayFilter, null);
                    const tabs = document.getElementById('dayTabs').children;
                    for (let tab of tabs) {
                        if (tab.innerText === currentDayFilter) {
                            tab.click();
                            break;
                        }
                    }
                }
                return;
            }

            const filtered = allEvents.filter(ev =>
                ev.title.toLowerCase().includes(term) ||
                ev.day.toLowerCase().includes(term)
            );
            renderEvents(filtered);

            // Desactivar todos los tabs visualmente
            const tabs = document.getElementById('dayTabs').children;
            for (let tab of tabs) {
                tab.classList.remove('tab-active');
                tab.classList.add('tab-inactive');
            }
        });

        // ======================
        // INICIO
        // ======================
        window.onload = async () => {
            const result = await fetchAndCombineSchedules();
            if (result) {
                parsedSchedule = result.schedule;
                allEvents = result.allEvents;
                renderTabs(result.days);
            }
        };

        // Cerrar modal con tecla Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
