<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor CineMax</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            DEFAULT: '#3b82f6',
                            light: '#60a5fa',
                            dark: '#2563eb',
                            glow: 'rgba(59, 130, 246, 0.5)'
                        }
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-glow': 'pulseGlow 3s infinite',
                        'shimmer': 'shimmer 2s infinite linear',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: 0, transform: 'translateY(40px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' },
                        },
                        pulseGlow: {
                            '0%, 100%': { boxShadow: '0 0 20px rgba(59, 130, 246, 0.2)' },
                            '50%': { boxShadow: '0 0 40px rgba(59, 130, 246, 0.6)' },
                        },
                        shimmer: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: white; overflow-x: hidden; }
        .glass-panel { background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .hidden-force { display: none !important; }
        
        /* Plyr Customization */
        :root { --plyr-color-main: #3b82f6; --plyr-video-background: #000; }
        .plyr--full-ui input[type=range] { color: var(--plyr-color-main); }
        
        /* Language Flags */
        .lang-flag { transition: all 0.3s ease; filter: grayscale(100%) opacity(0.6); transform: scale(0.9); border: 2px solid transparent; border-radius: 6px; }
        .lang-flag:hover, .lang-flag.active { filter: grayscale(0%) opacity(1); transform: scale(1.1); border-color: #3b82f6; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body class="relative min-h-screen font-sans selection:bg-brand selection:text-white">

    <div class="relative z-10 container mx-auto px-6 h-screen flex items-center justify-center">
        <div id="initial-loader" class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-brand mx-auto mb-4"></div>
            <h2 class="text-xl font-bold animate-pulse">Cargando Reproductor...</h2>
        </div>
    </div>

    <div id="player-modal" class="fixed inset-0 z-50 bg-[#050505] hidden flex flex-row transform-gpu overflow-hidden">
        
        <div id="player-bg-blur" class="absolute inset-0 bg-cover bg-center opacity-30 blur-[100px] z-0 pointer-events-none scale-110"></div>

        <div id="video-wrapper" class="relative w-full md:w-3/4 h-full bg-black/90 z-10 flex items-center justify-center shadow-[20px_0_50px_rgba(0,0,0,0.5)] border-r border-white/5 transition-all duration-500">
            
            <div class="absolute top-0 left-0 w-full p-4 flex justify-between z-20 pointer-events-none group-hover/video:opacity-100">
                <div class="pointer-events-auto flex gap-2 ml-auto">
                    <button onclick="toggleSidebar()" class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 border border-white/10 backdrop-blur-md flex items-center justify-center transition-all hover:scale-110" title="Lista de Servidores">
                        <i class="fas fa-list-ul"></i>
                    </button>
                </div>
            </div>
            
            <video id="player" class="w-full h-full object-contain" playsinline controls crossorigin></video>
            
            <div id="iframe-container" class="absolute inset-0 w-full h-full hidden-force bg-black"></div>
        </div>

        <div id="server-panel" class="relative w-full md:w-1/4 h-full glass-panel border-l-0 flex flex-col z-10 backdrop-blur-3xl bg-black/60 shadow-2xl transition-all duration-500">
            
            <div class="p-6 border-b border-white/5 bg-gradient-to-b from-white/5 to-transparent flex flex-col gap-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fas fa-server text-brand animate-pulse"></i> Fuentes
                    </h3>
                    <div class="text-[10px] bg-white/5 px-2 py-1 rounded text-gray-400">
                        <span id="server-count">0</span> Disp.
                    </div>
                </div>

                <div class="flex justify-center gap-3">
                    <button onclick="setLanguageFilter('latino')" class="lang-flag cursor-pointer" id="btn-latino">
                        <img src="https://embed69.org/static/lang/LAT.png" alt="Latino" class="w-8 h-auto" title="Audio Latino">
                    </button>
                    <button onclick="setLanguageFilter('castellano')" class="lang-flag cursor-pointer" id="btn-castellano">
                        <img src="https://embed69.org/static/lang/ESP.png" alt="Castellano" class="w-8 h-auto" title="Audio Castellano">
                    </button>
                    <button onclick="setLanguageFilter('subtitulado')" class="lang-flag cursor-pointer" id="btn-subtitulado">
                        <img src="https://embed69.org/static/lang/SUB.png" alt="Subtitulado" class="w-8 h-auto" title="Audio Subtitulado">
                    </button>
                </div>
            </div>
            
            <div id="server-list-container" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                <div class="text-center text-gray-500 mt-10 animate-pulse">Buscando enlaces...</div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const API_KEY = 'da8b836389708e0558de674492931977'; 
        const PROXY_URL = 'https://api.codetabs.com/v1/proxy/?quest=';
        // SI TIENES UN BLOG DE RESPALDO, CAMBIA ESTO. SI NO, DÉJALO ASÍ PARA USAR EL POR DEFECTO DEL SCRIPT ORIGINAL
        const TARGET_BLOG = 'https://darkstatonmovies1.blogspot.com'; 
        
        // --- VARIABLES ---
        let movieData = {
            tmdbId: null,
            imdbId: null,
            title: '',
            backdrop: '',
            type: 'movie', 
            season: 1,
            episode: 1
        };
        let playerInstance = null;
        let sourcesList = [];
        let currentLanguage = 'all'; 
        let isSidebarOpen = true;

        // --- DOM ---
        const videoElement = document.getElementById('player');
        const iframeContainer = document.getElementById('iframe-container');

        // --- INICIO ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const season = urlParams.get('season');
            const episode = urlParams.get('episode');

            if (id) {
                document.getElementById('initial-loader').style.display = 'none';
                document.getElementById('player-modal').classList.remove('hidden');
                
                if (season && episode) {
                    movieData.type = 'tv';
                    movieData.season = parseInt(season);
                    movieData.episode = parseInt(episode);
                    fetchTMDBTVData(id, movieData.season, movieData.episode);
                } else {
                    movieData.type = 'movie';
                    fetchTMDBData(id);
                }
            } else {
                document.getElementById('initial-loader').innerHTML = "<h2 class='text-red-500 text-xl font-bold'>Error: Falta ID</h2><p class='text-gray-400'>Usa ?id=123 en la URL</p>";
            }
        });

        // --- DATOS TMDB ---
        async function fetchTMDBData(id) {
            try {
                const response = await fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=${API_KEY}&language=es-MX&append_to_response=external_ids`);
                const data = await response.json();
                movieData.tmdbId = data.id;
                movieData.imdbId = data.external_ids ? data.external_ids.imdb_id : null;
                movieData.title = data.title;
                movieData.backdrop = data.backdrop_path ? `https://image.tmdb.org/t/p/original${data.backdrop_path}` : '';
                updateUI();
                startScraping();
            } catch (error) { console.error(error); }
        }

        async function fetchTMDBTVData(id, season, episode) {
            try {
                const showResp = await fetch(`https://api.themoviedb.org/3/tv/${id}?api_key=${API_KEY}&language=es-MX&append_to_response=external_ids`);
                const showData = await showResp.json();
                
                // Intentar obtener backdrop específico del episodio, si falla usar el de la serie
                const epResp = await fetch(`https://api.themoviedb.org/3/tv/${id}/season/${season}/episode/${episode}?api_key=${API_KEY}&language=es-MX`);
                const epData = await epResp.json();

                movieData.tmdbId = showData.id;
                movieData.imdbId = showData.external_ids ? showData.external_ids.imdb_id : null;
                movieData.title = `${showData.name} - S${season}E${episode}`;
                movieData.backdrop = epData.still_path ? `https://image.tmdb.org/t/p/original${epData.still_path}` : `https://image.tmdb.org/t/p/original${showData.backdrop_path}`;
                
                updateUI();
                startScraping();
            } catch (error) { console.error(error); }
        }

        function updateUI() {
            if (movieData.backdrop) {
                document.getElementById('player-bg-blur').style.backgroundImage = `url('${movieData.backdrop}')`;
            }
        }

        // --- SCRAPING (Lógica Original del Archivo) ---
        async function startScraping() {
            sourcesList = [];
            updateServerList();

            const promises = [];
            if (movieData.type === 'tv') {
                if (movieData.imdbId) promises.push(scrapeEmbed69Series(movieData.imdbId, movieData.season, movieData.episode));
            } else {
                promises.push(scrapeBlogFallback());
                if (movieData.imdbId) promises.push(scrapeEmbed69(movieData.imdbId));
                if (movieData.imdbId) promises.push(scrapeVerHDLink(movieData.imdbId));
            }
            
            await Promise.allSettled(promises);
            
            if (sourcesList.length > 0) {
                const first = sourcesList[0];
                playSource(first);
                // Auto-seleccionar filtro idioma
                const l = first.lang.toLowerCase();
                if(l.includes('lat')) setLanguageFilter('latino');
                else if(l.includes('cas') || l.includes('esp')) setLanguageFilter('castellano');
                else if(l.includes('sub')) setLanguageFilter('subtitulado');
            } else {
                document.getElementById('server-list-container').innerHTML = `<div class="text-center text-red-400 mt-10">No se encontraron videos :(</div>`;
            }
        }

        // --- SCRAPERS ---
        async function scrapeEmbed69Series(imdbId, season, episode) {
            try {
                const s = parseInt(season);
                const e = parseInt(episode).toString().padStart(2, '0');
                const slug = `${imdbId}-${s}x${e}`;
                const url = `https://embed69.org/f/${slug}/`;
                const res = await fetch(PROXY_URL + encodeURIComponent(url));
                const html = await res.text();
                const match = html.match(/let dataLink\s*=\s*(\[[\s\S]*?\]);/);
                if (match) processEmbed69Data(JSON.parse(match[1]), 'embed69-series');
            } catch (e) { console.warn("E69 Series Error", e); }
        }

        async function scrapeEmbed69(imdbId) {
            try {
                const url = `https://embed69.org/f/${imdbId}/`;
                const res = await fetch(PROXY_URL + encodeURIComponent(url));
                const html = await res.text();
                const match = html.match(/let dataLink\s*=\s*(\[[\s\S]*?\]);/);
                if (match) processEmbed69Data(JSON.parse(match[1]), 'embed69');
            } catch (e) { console.warn("E69 Error", e); }
        }

        function processEmbed69Data(dataLink, providerName) {
            dataLink.forEach(item => {
                let lang = 'Desconocido';
                if (item.video_language.includes('LAT')) lang = 'Latino';
                else if (item.video_language.includes('ESP') || item.video_language.includes('CAS')) lang = 'Castellano';
                else if (item.video_language.includes('SUB')) lang = 'Subtitulado';

                item.sortedEmbeds.forEach(embed => {
                    const lowerName = embed.servername.toLowerCase();
                    if (lowerName.includes('fichier') || lowerName.includes('uptobox')) return; 

                    const decoded = decodeJWT(embed.link);
                    if (decoded && decoded.link) {
                        const host = mapHostName(embed.servername);
                        const videoId = extractIdFromLink(decoded.link);
                        
                        let finalUrl = decoded.link;
                        // Usar Unlimplay si es compatible para mejorar visualización
                        if (host && videoId) {
                            finalUrl = `https://unlimplay.com/embed2/?host=${host}&id=${videoId}&poster=${encodeURIComponent(movieData.backdrop)}`;
                        }

                        addSource({
                            name: embed.servername,
                            lang: lang,
                            type: 'iframe',
                            url: finalUrl,
                            icon: 'fa-play-circle',
                            provider: providerName
                        });
                    }
                });
            });
        }

        async function scrapeVerHDLink(imdbId) {
            try {
                const targetUrl = `https://verhdlink.cam/movie/${imdbId}`;
                const res = await fetch(PROXY_URL + encodeURIComponent(targetUrl));
                const html = await res.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const mirrors = [...doc.querySelectorAll('ul._player-mirrors')];
                
                for(const ul of mirrors){
                    let lang = 'Latino';
                    if(ul.innerHTML.toLowerCase().includes('subtitulado')) lang = 'Subtitulado';
                    else if(ul.innerHTML.toLowerCase().includes('castellano')) lang = 'Castellano';

                    const droploadLi = [...ul.querySelectorAll('li[data-link]')].find(li => (li.getAttribute('data-link') || '').includes('dropload'));
                    if (droploadLi) {
                        const rawLink = droploadLi.getAttribute('data-link');
                        const match = rawLink.match(/embed-([a-zA-Z0-9_-]+)/) || rawLink.match(/dropload\.tv\/e\/([a-zA-Z0-9_-]+)/);
                        if (match && match[1]) {
                            addSource({
                                name: `Thunderbolt`,
                                lang: lang,
                                type: 'iframe',
                                url: `https://unlimplay.com/embed2/?host=dropload&id=${match[1]}&poster=${encodeURIComponent(movieData.backdrop)}`,
                                icon: 'fa-bolt',
                                provider: 'verhd' 
                            });
                        }
                    }
                }
            } catch (e) { console.warn("VerHD Error", e); }
        }

        async function scrapeBlogFallback() {
            try {
                if(!movieData.title) return;
                const keyword = normalizeStr(movieData.title.split(':')[0]);
                const searchUrl = `${TARGET_BLOG}/search?q=${encodeURIComponent(keyword)}`;
                const res = await fetch(PROXY_URL + encodeURIComponent(searchUrl));
                const text = await res.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const bestUrl = doc.querySelector('.cards-movie a')?.href;

                if (bestUrl) {
                    const mRes = await fetch(PROXY_URL + encodeURIComponent(bestUrl));
                    const mText = await mRes.text();
                    const mDoc = parser.parseFromString(mText, 'text/html');
                    const iframes = mDoc.querySelectorAll('iframe');
                    
                    iframes.forEach((iframe, i) => {
                         if (iframe.src.includes('videoUrl=')) {
                             const encoded = new URLSearchParams(iframe.src.split('?')[1]).get('videoUrl');
                             if(encoded) {
                                 addSource({
                                    name: `VIP Server ${i+1}`,
                                    lang: 'Latino',
                                    type: 'direct', // Asumimos direct si viene de este blog específico
                                    url: atob(encoded),
                                    icon: 'fa-star',
                                    provider: 'blog' 
                                 });
                             }
                         }
                    });
                }
            } catch (e) { console.warn("Blog Error", e); }
        }

        // --- GESTIÓN DE FUENTES ---
        function addSource(source) {
            if (!sourcesList.some(s => s.url === source.url)) {
                sourcesList.push(source);
                updateServerList(); 
            }
        }

        function updateServerList() {
            let displayList = sourcesList;
            if (currentLanguage !== 'all') {
                displayList = sourcesList.filter(s => s.lang.toLowerCase().includes(currentLanguage === 'castellano' ? 'castellano' : (currentLanguage === 'subtitulado' ? 'sub' : 'lat')));
            }

            const container = document.getElementById('server-list-container');
            document.getElementById('server-count').innerText = displayList.length;
            container.innerHTML = '';
            
            if (displayList.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 mt-10">No hay opciones en ${currentLanguage}</div>`;
                return;
            }

            displayList.forEach((src) => {
                const div = document.createElement('div');
                div.className = `flex items-center p-3 rounded-xl cursor-pointer transition-all duration-300 border border-white/5 bg-white/5 hover:border-brand/50 hover:bg-white/10 animate-fade-in-up`;
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-black/40 flex items-center justify-center text-brand font-bold mr-3">
                        <i class="fas ${src.icon} text-xs"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-xs font-bold text-gray-100 truncate">${src.name}</h4>
                        <span class="text-[9px] bg-black/30 px-1.5 py-0.5 rounded text-gray-400 uppercase font-semibold">${src.lang}</span>
                    </div>
                `;
                div.onclick = () => {
                    playSource(src);
                    Array.from(container.children).forEach(c => c.classList.remove('border-brand', 'bg-brand/10'));
                    div.classList.add('border-brand', 'bg-brand/10');
                };
                container.appendChild(div);
            });
        }

        function playSource(source) {
            const video = document.getElementById('player');
            const iframeCont = document.getElementById('iframe-container');

            if (playerInstance) playerInstance.stop();
            video.pause();
            iframeCont.innerHTML = ''; 

            if (source.type === 'direct' && (source.url.includes('.mp4') || source.url.includes('.m3u8'))) {
                iframeCont.classList.add('hidden-force');
                video.style.display = 'block';
                
                if (source.url.includes('.m3u8') && Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(source.url);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        initPlyr();
                        playerInstance.play();
                    });
                } else {
                    video.src = source.url;
                    initPlyr();
                    playerInstance.play();
                }
            } else {
                video.style.display = 'none';
                iframeCont.classList.remove('hidden-force');
                iframeCont.innerHTML = `<iframe src="${source.url}" class="w-full h-full border-0" allow="autoplay; encrypted-media; fullscreen"></iframe>`;
            }
        }

        function initPlyr() {
            if (playerInstance) playerInstance.destroy();
            playerInstance = new Plyr('#player', {
                controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'pip', 'fullscreen'],
                autoplay: true
            });
        }

        // --- ÚTILES ---
        function setLanguageFilter(lang) {
            currentLanguage = lang;
            document.querySelectorAll('.lang-flag').forEach(btn => btn.classList.remove('active'));
            if(lang !== 'all') document.getElementById(`btn-${lang}`).classList.add('active');
            updateServerList();
        }

        function toggleSidebar() {
            const panel = document.getElementById('server-panel');
            const videoWrap = document.getElementById('video-wrapper');
            isSidebarOpen = !isSidebarOpen;
            if(isSidebarOpen) {
                panel.classList.remove('hidden-force');
                videoWrap.classList.remove('w-full');
                videoWrap.classList.add('md:w-3/4');
            } else {
                panel.classList.add('hidden-force');
                videoWrap.classList.remove('md:w-3/4');
                videoWrap.classList.add('w-full');
            }
        }

        function base64UrlDecode(str) {
            str = str.replace(/-/g, '+').replace(/_/g, '/');
            return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
        }
        function decodeJWT(token) { try { return JSON.parse(base64UrlDecode(token.split('.')[1])); } catch { return null; } }
        function mapHostName(name) {
            if (name.toLowerCase().includes('voe')) return 'voe';
            if (name.toLowerCase().includes('streamwish')) return 'streamwish';
            if (name.toLowerCase().includes('dood')) return 'doodstream';
            if (name.toLowerCase().includes('filemoon')) return 'filemoon';
            if (name.toLowerCase().includes('vidhide')) return 'vidhide';
            return null;
        }
        function extractIdFromLink(link) {
            const patterns = [/\/e\/([a-zA-Z0-9]+)/, /filemoon\.sx\/d\/([a-zA-Z0-9]+)/, /voe\.sx\/([a-zA-Z0-9]+)/, /streamwish\.com\/([a-zA-Z0-9]+)/];
            for (let p of patterns) { const m = link.match(p); if (m) return m[1]; }
            return link.split('/').pop().replace('.html', '');
        }
        function normalizeStr(str) { return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase(); }
    </script>
</body>
</html>
