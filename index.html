<script>
  // === CONFIGURACIÓN ===
  const API_KEY = '936410eebae74f9895643e085cc4a740';
  const PROXY_URL = 'https://api.codetabs.com/v1/proxy?quest=';
  let movieData = { id: null, isSeries: false, title: '', backdrop: '' };

  // === INICIO ===
  document.addEventListener('DOMContentLoaded', async () => {
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    if (!id) return alert('Usa ?id=123');

    movieData.id = id;
    await fetchTMDBData(id);
    await startScraping();
  });

  // === TMDB ===
  async function fetchTMDBData(id) {
    try {
      const res = await fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=${API_KEY}&language=es-ES`);
      const data = await res.json();
      document.getElementById('movie-title').textContent = data.title;
      document.getElementById('movie-overview').textContent = data.overview;
      document.getElementById('backdrop-img').style.backgroundImage = 
        `url(https://image.tmdb.org/t/p/original${data.backdrop_path})`;
      movieData.title = data.title;
    } catch (err) {
      console.error('TMDB error:', err);
    }
  }

  // === SCRAPING (SOLO VERHD) ===
  async function startScraping() {
    document.getElementById('loading').textContent = 'Buscando en VerHDLink...';
    
    const url = `${PROXY_URL}https://verhdlink.cam/movie/${movieData.id}`;
    try {
      const res = await fetch(url);
      const html = await res.text();

      // Buscar data-link con servidores reales
      const match = html.match(/data-link\s*=\s*['"]([^'"]*(?:unlimplay|vidhide|filelions|streamlare)[^'"]*)['"]/i);
      
      if (match && match[1]) {
        const videoUrl = match[1];
        document.getElementById('loading').style.display = 'none';
        
        // Mostrar botón
        const btn = document.createElement('button');
        btn.className = 'server-btn';
        btn.textContent = 'Ver en VerHD';
        btn.onclick = () => playIframe(videoUrl);
        document.getElementById('server-list-container').innerHTML = '<strong>Fuentes:</strong><br>';
        document.getElementById('server-list-container').appendChild(btn);
        
      } else {
        document.getElementById('loading').textContent = '❌ No se encontró enlace de reproducción';
      }
    } catch (err) {
      console.error('Scraping error:', err);
      document.getElementById('loading').textContent = '❌ Error al conectar con VerHDLink';
    }
  }

  // === REPRODUCIR IFRAME ===
  function playIframe(url) {
    const iframe = document.getElementById('iframe-container');
    iframe.innerHTML = `<iframe src="${url}" width="100%" height="100%" frameborder="0" allowfullscreen allow="autoplay; encrypted-media"></iframe>`;
    iframe.style.display = 'block';
    document.getElementById('player').style.display = 'none';
    document.getElementById('loading').style.display = 'none';
  }
</script>
