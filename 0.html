<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JJMOVIES - Ultimate Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;600;800&family=Inter:wght@300;400;600;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { DEFAULT: '#3b82f6', light: '#60a5fa', dark: '#2563eb' }, // Tu Azul CineMax
                        netflixRed: '#E50914', // Rojo Netflix
                        netflixBlack: '#141414',
                        darkPanel: 'rgba(20, 20, 20, 0.95)'
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], logo: ['Bebas Neue', 'cursive'] },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.8s ease-out',
                        'slide-in-right': 'slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
                        slideInRight: { '0%': { opacity: 0, transform: 'translateX(20px)' }, '100%': { opacity: 1, transform: 'translateX(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* ESTILOS VISUALES (EST√âTICA INDSEX/NETFLIX) */
        body { background-color: #141414; color: white; overflow-x: hidden; font-family: 'Inter', sans-serif; }
        
        /* Scrollbars */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #111; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #3b82f6; }

        /* Tarjetas */
        .movie-card { transition: transform 0.3s, z-index 0.3s; z-index: 10; position: relative; aspect-ratio: 2/3; }
        .movie-card:hover { transform: scale(1.1); z-index: 50; box-shadow: 0 10px 20px rgba(0,0,0,0.8); }

        /* Reproductor CineMax Styles */
        .glass-panel {
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }
        .lang-flag { transition: all 0.2s; filter: grayscale(100%) opacity(0.6); transform: scale(0.9); }
        .lang-flag:hover, .lang-flag.active { filter: grayscale(0%) opacity(1); transform: scale(1.1); border: 2px solid #3b82f6; border-radius: 4px; }
        
        /* Plyr Theme Override (Azul CineMax) */
        :root { --plyr-color-main: #3b82f6; }

        /* Loader */
        .loader-ring { display: inline-block; width: 64px; height: 64px; }
        .loader-ring:after {
            content: " "; display: block; width: 46px; height: 46px; margin: 8px; border-radius: 50%;
            border: 5px solid #fff; border-color: #3b82f6 transparent #3b82f6 transparent;
            animation: ring 1.2s linear infinite;
        }
        @keyframes ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <nav id="navbar" class="fixed top-0 w-full z-40 px-4 md:px-12 py-4 bg-gradient-to-b from-black/90 to-transparent flex items-center justify-between transition-all duration-300">
        <div class="flex items-center gap-8">
            <a href="#" onclick="window.location.reload()" class="text-3xl md:text-4xl font-logo text-netflixRed tracking-widest drop-shadow-md cursor-pointer hover:scale-105 transition">JJMOVIES</a>
            <div class="hidden md:flex gap-6 text-sm font-medium text-gray-300">
                <a onclick="ui.showHome()" class="hover:text-white cursor-pointer font-bold transition">Inicio</a>
                <a onclick="ui.loadGenre(28, 'Acci√≥n')" class="hover:text-white cursor-pointer transition">Acci√≥n</a>
                <a onclick="ui.loadGenre(16, 'Infantil')" class="hover:text-white cursor-pointer transition">Infantil</a>
                <a onclick="ui.loadGenre(27, 'Terror')" class="hover:text-white cursor-pointer transition">Terror</a>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="relative bg-black/60 border border-white/30 rounded px-3 py-1 flex items-center focus-within:border-white transition-colors">
                <i class="fas fa-search text-gray-400 mr-2"></i>
                <input type="text" id="searchInput" placeholder="Pel√≠culas, Series..." class="bg-transparent border-none outline-none text-white text-sm w-32 md:w-64 transition-all" onkeyup="ui.handleSearch(this.value)">
            </div>
            <img src="https://upload.wikimedia.org/wikipedia/commons/0/0b/Netflix-avatar.png" class="w-8 h-8 rounded cursor-pointer border border-transparent hover:border-white transition">
        </div>
    </nav>

    <main id="main-view" class="min-h-screen pb-20">
        
        <header id="hero" class="relative h-[85vh] w-full bg-cover bg-center hidden group">
            <div class="absolute inset-0 bg-gradient-to-r from-black via-black/40 to-transparent"></div>
            <div class="absolute inset-0 bg-gradient-to-t from-[#141414] via-[#141414]/20 to-transparent"></div>
            
            <div class="absolute bottom-[20%] left-4 md:left-12 max-w-2xl space-y-5 z-10 animate-slide-up">
                <div class="flex items-center gap-2">
                     <span class="bg-netflixRed text-white text-[10px] font-bold px-2 py-1 rounded">TOP 10</span>
                     <span class="text-white text-sm font-bold shadow-black drop-shadow-md">N.¬∫ 1 en Pel√≠culas hoy</span>
                </div>
                <h1 id="hero-title" class="text-5xl md:text-7xl font-black font-logo leading-none drop-shadow-2xl text-white">CARGANDO...</h1>
                <p id="hero-desc" class="text-gray-200 text-sm md:text-lg line-clamp-3 drop-shadow-md max-w-xl"></p>
                <div class="flex gap-4 pt-4">
                    <button id="hero-play" class="bg-white text-black px-8 py-3 rounded font-bold hover:bg-gray-200 flex items-center gap-2 transition hover:scale-105 shadow-lg">
                        <i class="fas fa-play"></i> Reproducir
                    </button>
                    <button class="bg-gray-500/40 text-white px-8 py-3 rounded font-bold hover:bg-gray-500/30 flex items-center gap-2 backdrop-blur-md transition border border-white/10">
                        <i class="fas fa-info-circle"></i> M√°s Info
                    </button>
                </div>
            </div>
        </header>

        <div id="home-rows" class="relative z-20 -mt-32 space-y-12 pl-4 md:pl-12 pb-12 hidden"></div>

        <div id="grid-view" class="hidden pt-24 px-4 md:px-12 animate-fade-in">
            <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
                <h2 id="grid-title" class="text-2xl font-bold text-white">Resultados</h2>
                <button onclick="ui.showHome()" class="text-gray-400 hover:text-white transition"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="grid-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        </div>
    </main>

    <div id="player-modal" class="fixed inset-0 z-[100] bg-black hidden flex opacity-0 transition-opacity duration-500">
        
        <div id="video-wrapper" class="relative w-full md:w-3/4 h-full bg-black flex items-center justify-center transition-all duration-300">
            <div class="absolute top-0 left-0 w-full p-4 flex justify-between z-20 bg-gradient-to-b from-black/80 to-transparent pointer-events-none">
                <button onclick="playerCore.close()" class="pointer-events-auto w-10 h-10 rounded-full bg-white/10 hover:bg-red-600 hover:text-white border border-white/10 backdrop-blur-md flex items-center justify-center transition shadow-lg">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <button onclick="playerCore.toggleSidebar()" class="md:hidden pointer-events-auto w-10 h-10 rounded-full bg-white/10 hover:bg-brand/50 border border-white/10 backdrop-blur-md flex items-center justify-center transition">
                    <i class="fas fa-list"></i>
                </button>
            </div>

            <video id="player" class="w-full h-full object-contain" playsinline controls crossorigin></video>
            
            <div id="iframe-container" class="absolute inset-0 w-full h-full hidden bg-black"></div>
            
            <div id="loader-overlay" class="absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50">
                <div class="loader-ring"></div>
                <p id="loader-text" class="mt-6 text-brand font-bold tracking-[0.2em] animate-pulse text-sm">INICIANDO MOTOR CINEMAX...</p>
            </div>
        </div>

        <div id="server-panel" class="absolute right-0 h-full w-full md:w-1/4 glass-panel flex flex-col z-30 transform md:translate-x-0 translate-x-full transition-transform duration-300 shadow-2xl">
            
            <div class="p-6 border-b border-white/10 bg-gradient-to-b from-white/5 to-transparent">
                <h3 class="text-xl font-bold text-white flex items-center gap-2 mb-1">
                    <i class="fas fa-server text-brand animate-pulse"></i> Servidores
                </h3>
                <p id="server-count" class="text-xs text-gray-400 mb-4">Esperando selecci√≥n...</p>
                
                <div class="flex justify-center gap-3 mb-2">
                    <button onclick="playerCore.setLanguageFilter('latino')" class="lang-flag" id="btn-latino">
                        <img src="https://embed69.org/static/lang/LAT.png" class="w-8" title="Latino">
                    </button>
                    <button onclick="playerCore.setLanguageFilter('castellano')" class="lang-flag" id="btn-castellano">
                        <img src="https://embed69.org/static/lang/ESP.png" class="w-8" title="Castellano">
                    </button>
                    <button onclick="playerCore.setLanguageFilter('subtitulado')" class="lang-flag" id="btn-subtitulado">
                        <img src="https://embed69.org/static/lang/SUB.png" class="w-8" title="Subtitulado">
                    </button>
                </div>
            </div>

            <div id="series-controls" class="hidden p-4 bg-white/5 border-b border-white/10">
                <div class="flex gap-2 mb-2">
                    <select id="season-select" onchange="seriesCore.onSeasonChange(this.value)" class="bg-[#111] text-white text-xs p-2 rounded flex-1 outline-none border border-white/10"></select>
                    <select id="episode-select" class="bg-[#111] text-white text-xs p-2 rounded flex-1 outline-none border border-white/10"></select>
                </div>
                <button onclick="seriesCore.loadEpisode()" class="w-full bg-brand hover:bg-blue-600 text-white text-xs font-bold py-2 rounded transition shadow-lg flex items-center justify-center gap-2">
                    <i class="fas fa-play"></i> VER EPISODIO
                </button>
            </div>
            
            <div id="server-list-container" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scroll">
                </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN MAESTRA (DE TU C√ìDIGO ONLINE_VIEWER) ---
        const CONFIG = {
            API_KEY: 'da8b836389708e0558de674492931977', // KEY ORIGINAL DE TU ARCHIVO
            PROXY_URL: 'https://api.codetabs.com/v1/proxy/?quest=',
            TARGET_BLOG: 'https://darkstatonmovies1.blogspot.com',
            TMDB_BASE: 'https://api.themoviedb.org/3',
            IMG_BASE: 'https://image.tmdb.org/t/p/original',
            POSTER_BASE: 'https://image.tmdb.org/t/p/w500'
        };

        // --- VARIABLES GLOBALES ---
        let movieData = { tmdbId: null, imdbId: null, title: '', backdrop: '', type: 'movie', season: 1, episode: 1, totalSeasons: 1 };
        let playerInstance = null;
        let sourcesList = [];
        let currentLanguage = 'all';

        // =================================================================
        // M√ìDULO 1: INTERFAZ VISUAL (NETFLIX / INDSEX)
        // =================================================================
        const ui = {
            init: function() { this.loadHome(); },
            
            fetchTMDB: async function(url) {
                try {
                    const res = await fetch(`${CONFIG.TMDB_BASE}${url}&api_key=${CONFIG.API_KEY}&language=es-MX`);
                    return await res.json();
                } catch(e) { console.error(e); return null; }
            },

            loadHome: async function() {
                this.showHome();
                const trending = await this.fetchTMDB('/trending/all/day?');
                if(!trending || !trending.results) return;

                // Hero
                const heroItem = trending.results[0];
                const hero = document.getElementById('hero');
                hero.classList.remove('hidden');
                hero.style.backgroundImage = `url('${CONFIG.IMG_BASE}${heroItem.backdrop_path}')`;
                document.getElementById('hero-title').innerText = heroItem.title || heroItem.name;
                document.getElementById('hero-desc').innerText = heroItem.overview;
                document.getElementById('hero-play').onclick = () => playerCore.init(heroItem.id, heroItem.media_type || 'movie');

                // Rows
                const container = document.getElementById('home-rows');
                container.innerHTML = '';
                container.classList.remove('hidden');
                this.createRow(container, 'Tendencias Ahora', trending.results);
                
                const action = await this.fetchTMDB('/discover/movie?with_genres=28');
                this.createRow(container, 'Acci√≥n y Aventura', action.results);
                
                const comedy = await this.fetchTMDB('/discover/movie?with_genres=35');
                this.createRow(container, 'Comedias Populares', comedy.results);
            },

            createRow: function(container, title, items) {
                const div = document.createElement('div');
                div.innerHTML = `<h3 class="text-xl font-bold text-white mb-3 pl-2 border-l-4 border-netflixRed">${title}</h3>`;
                const slider = document.createElement('div');
                slider.className = 'flex gap-4 overflow-x-auto hide-scroll pb-4';
                
                items.forEach(m => {
                    if(m.poster_path) {
                        const img = document.createElement('img');
                        img.src = CONFIG.POSTER_BASE + m.poster_path;
                        img.className = 'w-32 md:w-44 rounded-md cursor-pointer movie-card object-cover shadow-lg';
                        img.onclick = () => playerCore.init(m.id, m.title ? 'movie' : 'tv');
                        slider.appendChild(img);
                    }
                });
                div.appendChild(slider);
                container.appendChild(div);
            },

            handleSearch: async function(q) {
                if(q.length < 3) return;
                this.showGrid();
                const res = await this.fetchTMDB(`/search/multi?query=${q}&include_adult=false`);
                this.renderGrid(res.results);
            },

            loadGenre: async function(id, name) {
                this.showGrid();
                document.getElementById('grid-title').innerText = name;
                const res = await this.fetchTMDB(`/discover/movie?with_genres=${id}`);
                this.renderGrid(res.results);
            },

            renderGrid: function(items) {
                const grid = document.getElementById('grid-container');
                grid.innerHTML = items.filter(i => i.poster_path).map(m => `
                    <div class="cursor-pointer group relative transition-transform hover:scale-105" onclick="playerCore.init(${m.id}, '${m.title ? 'movie' : 'tv'}')">
                        <img src="${CONFIG.POSTER_BASE}${m.poster_path}" class="w-full rounded-md shadow-lg">
                        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex items-center justify-center transition rounded-md">
                            <i class="fas fa-play-circle text-white text-4xl drop-shadow-lg"></i>
                        </div>
                    </div>
                `).join('');
            },

            showHome: function() {
                document.getElementById('home-rows').classList.remove('hidden');
                document.getElementById('hero').classList.remove('hidden');
                document.getElementById('grid-view').classList.add('hidden');
            },
            showGrid: function() {
                document.getElementById('home-rows').classList.add('hidden');
                document.getElementById('hero').classList.add('hidden');
                document.getElementById('grid-view').classList.remove('hidden');
            }
        };

        // =================================================================
        // M√ìDULO 2: PLAYER CORE (L√ìGICA EXACTA DE CINEMAX / ONLINE_VIEWER)
        // =================================================================
        const playerCore = {
            init: async function(tmdbId, type) {
                const modal = document.getElementById('player-modal');
                modal.classList.remove('hidden');
                requestAnimationFrame(() => modal.classList.remove('opacity-0'));
                
                this.setLoader(true, "OBTENIENDO METADATOS...");
                document.getElementById('server-list-container').innerHTML = '';
                
                // Reiniciar estado
                sourcesList = [];
                movieData = { tmdbId: tmdbId, type: type, season: 1, episode: 1 };

                // Fetch Detalles + IMDB ID
                const endpoint = type === 'movie' ? `/movie/${tmdbId}` : `/tv/${tmdbId}`;
                const data = await ui.fetchTMDB(`${endpoint}?append_to_response=external_ids`);
                
                if(!data) { alert("Error de conexi√≥n"); this.close(); return; }

                movieData.imdbId = data.external_ids?.imdb_id;
                movieData.title = data.title || data.name;
                movieData.backdrop = data.backdrop_path ? CONFIG.IMG_BASE + data.backdrop_path : '';
                
                if(type === 'tv') {
                    document.getElementById('series-controls').classList.remove('hidden');
                    movieData.totalSeasons = data.number_of_seasons;
                    seriesCore.populateSeasons();
                    seriesCore.populateEpisodes(1);
                } else {
                    document.getElementById('series-controls').classList.add('hidden');
                    this.startScraping();
                }
            },

            startScraping: async function() {
                if(!movieData.imdbId) { alert("ID IMDB no encontrado. No se pueden buscar enlaces."); return; }
                this.setLoader(true, "BUSCANDO ENLACES...");
                sourcesList = [];
                currentLanguage = 'all';
                
                const promises = [];
                
                // --- AQU√ç EST√Å LA L√ìGICA DE TU OTRO ARCHIVO INTEGRADA ---
                if(movieData.type === 'movie') {
                    promises.push(scraper.scrapeEmbed69(movieData.imdbId));
                    promises.push(scraper.scrapeVerHDLink(movieData.imdbId));
                    promises.push(scraper.scrapeBlogFallback(movieData.title));
                } else {
                    promises.push(scraper.scrapeEmbed69Series(movieData.imdbId, movieData.season, movieData.episode));
                }

                await Promise.allSettled(promises);
                this.setLoader(false);
                this.updateServerList();

                if(sourcesList.length === 0) {
                    document.getElementById('server-list-container').innerHTML = '<div class="text-center text-gray-500 mt-10">No se encontraron servidores.</div>';
                }
            },

            close: function() {
                const modal = document.getElementById('player-modal');
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    if(playerInstance) playerInstance.stop();
                    document.getElementById('iframe-container').innerHTML = '';
                    document.getElementById('player').style.display = 'none';
                }, 500);
            },

            setLoader: function(active, text) {
                const overlay = document.getElementById('loader-overlay');
                if(active) {
                    overlay.classList.remove('hidden');
                    document.getElementById('loader-text').innerText = text;
                } else {
                    overlay.classList.add('hidden');
                }
            },

            toggleSidebar: function() {
                document.getElementById('server-panel').classList.toggle('translate-x-full');
            },

            setLanguageFilter: function(lang) {
                currentLanguage = lang;
                document.querySelectorAll('.lang-flag').forEach(btn => btn.classList.remove('active'));
                if(lang !== 'all') document.getElementById(`btn-${lang}`).classList.add('active');
                this.updateServerList();
            },

            updateServerList: function() {
                const container = document.getElementById('server-list-container');
                container.innerHTML = '';
                document.getElementById('server-count').innerText = `${sourcesList.length} encontrados`;

                let filtered = sourcesList;
                if(currentLanguage !== 'all') {
                    filtered = sourcesList.filter(s => {
                        const l = s.lang.toLowerCase();
                        if(currentLanguage === 'latino') return l.includes('lat');
                        if(currentLanguage === 'castellano') return l.includes('cas') || l.includes('esp');
                        if(currentLanguage === 'subtitulado') return l.includes('sub');
                        return true;
                    });
                }

                filtered.forEach(src => {
                    const div = document.createElement('div');
                    let iconColor = 'text-brand';
                    let badge = '';
                    
                    if(src.provider === 'blog') { 
                        iconColor = 'text-yellow-400';
                        badge = '<i class="fas fa-crown text-yellow-400 text-xs" title="VIP"></i>';
                    }
                    if(src.provider === 'verhd') {
                        iconColor = 'text-cyan-400';
                        badge = '<i class="fas fa-bolt text-cyan-400 text-xs" title="ULTRA"></i>';
                    }

                    div.className = 'group relative flex items-center gap-3 p-3 bg-white/5 hover:bg-white/10 rounded-xl cursor-pointer border border-transparent hover:border-brand/50 transition-all overflow-hidden animate-slide-in-right';
                    div.innerHTML = `
                        <div class="w-10 h-10 rounded-full bg-black/40 flex items-center justify-center ${iconColor} font-bold shadow-lg group-hover:scale-110 transition">
                            <i class="fas ${src.icon}"></i>
                        </div>
                        <div class="flex-1 z-10">
                            <h4 class="text-xs font-bold text-gray-100 group-hover:text-white truncate">${src.name}</h4>
                            <div class="flex items-center justify-between mt-1">
                                <span class="text-[10px] bg-black/30 px-2 rounded text-gray-400 uppercase">${src.lang}</span>
                                ${badge}
                            </div>
                        </div>
                    `;
                    div.onclick = () => this.playSource(src);
                    container.appendChild(div);
                });
            },

            playSource: function(src) {
                const video = document.getElementById('player');
                const iframeCont = document.getElementById('iframe-container');

                if(playerInstance) playerInstance.stop();
                iframeCont.innerHTML = '';
                iframeCont.classList.add('hidden');
                video.style.display = 'block';

                if(src.type === 'direct' && (src.url.includes('.mp4') || src.url.includes('.m3u8'))) {
                     if (src.url.includes('.m3u8') && Hls.isSupported()) {
                        const hls = new Hls();
                        hls.loadSource(src.url);
                        hls.attachMedia(video);
                    } else {
                        video.src = src.url;
                    }
                    this.initPlyr();
                } else {
                    video.style.display = 'none';
                    iframeCont.classList.remove('hidden');
                    iframeCont.innerHTML = `<iframe src="${src.url}" class="w-full h-full border-0 animate-fade-in" allowfullscreen></iframe>`;
                }
            },

            initPlyr: function() {
                if(playerInstance) playerInstance.destroy();
                playerInstance = new Plyr('#player', {
                    controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen'],
                    autoplay: true
                });
                playerInstance.play();
            }
        };

        // --- M√ìDULO 3: SERIES CORE ---
        const seriesCore = {
            populateSeasons: function() {
                const sel = document.getElementById('season-select');
                sel.innerHTML = '';
                for(let i=1; i<=movieData.totalSeasons; i++) {
                    sel.innerHTML += `<option value="${i}">Temp ${i}</option>`;
                }
            },
            populateEpisodes: async function(season) {
                movieData.season = season;
                const data = await ui.fetchTMDB(`/tv/${movieData.tmdbId}/season/${season}?`);
                const sel = document.getElementById('episode-select');
                sel.innerHTML = '';
                data.episodes.forEach(ep => {
                    sel.innerHTML += `<option value="${ep.episode_number}">Ep. ${ep.episode_number} - ${ep.name.substring(0,15)}...</option>`;
                });
            },
            onSeasonChange: function(val) { this.populateEpisodes(val); },
            loadEpisode: function() {
                const ep = document.getElementById('episode-select').value;
                movieData.episode = ep;
                playerCore.startScraping();
            }
        };

        // =================================================================
        // M√ìDULO 4: SCRAPER ENGINE (COPIADO EXACTO DE TU ARCHIVO)
        // =================================================================
        const scraper = {
            base64UrlDecode: function(str) {
                str = str.replace(/-/g, '+').replace(/_/g, '/');
                return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
            },
            decodeJWT: function(token) {
                try { return JSON.parse(this.base64UrlDecode(token.split('.')[1])); } catch { return null; }
            },
            mapHostName: function(name) {
                name = name.toLowerCase();
                if (name.includes('voe')) return 'voe';
                if (name.includes('streamwish')) return 'streamwish';
                if (name.includes('dood')) return 'doodstream';
                if (name.includes('filemoon')) return 'filemoon';
                if (name.includes('vidhide')) return 'vidhide';
                return null;
            },
            extractId: function(link) {
                const patterns = [/\/e\/([a-zA-Z0-9]+)/, /filemoon\.sx\/d\/([a-zA-Z0-9]+)/, /voe\.sx\/([a-zA-Z0-9]+)/];
                for (let p of patterns) { const m = link.match(p); if (m && m[1]) return m[1]; }
                return link.split('/').pop().replace('.html','');
            },
            addSource: function(src) {
                if (!sourcesList.some(s => s.url === src.url)) sourcesList.push(src);
            },

            // --- Embed69 (Pel√≠culas y Series) ---
            scrapeEmbed69: async function(imdbId) {
                try {
                    const res = await fetch(CONFIG.PROXY_URL + encodeURIComponent(`https://embed69.org/f/${imdbId}/`));
                    const html = await res.text();
                    this.processEmbed69Data(html, 'embed69');
                } catch(e) {}
            },
            scrapeEmbed69Series: async function(imdbId, s, e) {
                try {
                    const slug = `${imdbId}-${s}x${e}`; 
                    // Intento 1: Formato standard
                    let res = await fetch(CONFIG.PROXY_URL + encodeURIComponent(`https://embed69.org/f/${slug}/`));
                    let html = await res.text();
                    if(!html.includes('dataLink')) {
                        // Intento 2: Formato con padding (1x01)
                        const slugPad = `${imdbId}-${s}x${String(e).padStart(2,'0')}`;
                        res = await fetch(CONFIG.PROXY_URL + encodeURIComponent(`https://embed69.org/f/${slugPad}/`));
                        html = await res.text();
                    }
                    this.processEmbed69Data(html, 'embed69-series');
                } catch(e) {}
            },
            processEmbed69Data: function(html, provider) {
                const match = html.match(/let dataLink\s*=\s*(\[[\s\S]*?\]);/);
                if (!match) return;
                const data = JSON.parse(match[1]);
                
                data.forEach(item => {
                    let lang = 'Latino';
                    if(item.video_language.includes('ESP') || item.video_language.includes('CAS')) lang = 'Castellano';
                    if(item.video_language.includes('SUB')) lang = 'Subtitulado';

                    item.sortedEmbeds.forEach(embed => {
                        const decoded = this.decodeJWT(embed.link);
                        if (decoded && decoded.link) {
                            const host = this.mapHostName(embed.servername);
                            const vidId = this.extractId(decoded.link);
                            let finalUrl = decoded.link;
                            
                            // TU L√ìGICA ANTI-ADS (Unlimplay)
                            if (host && vidId) {
                                finalUrl = `https://unlimplay.com/embed2/?host=${host}&id=${vidId}&poster=${encodeURIComponent(movieData.backdrop)}`;
                            }
                            
                            this.addSource({
                                name: embed.servername,
                                lang: lang,
                                type: 'iframe',
                                url: finalUrl,
                                icon: 'fa-globe',
                                provider: provider
                            });
                        }
                    });
                });
            },

            // --- VerHDLink (Solo Pelis) ---
            scrapeVerHDLink: async function(imdbId) {
                try {
                    const res = await fetch(CONFIG.PROXY_URL + encodeURIComponent(`https://verhdlink.cam/movie/${imdbId}`));
                    const html = await res.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    doc.querySelectorAll('ul._player-mirrors').forEach(ul => {
                        let lang = 'Latino';
                        if(ul.className.includes('subtitulado')) lang = 'Subtitulado';
                        if(ul.className.includes('castellano')) lang = 'Castellano';

                        ul.querySelectorAll('li[data-link]').forEach(li => {
                            const raw = li.getAttribute('data-link');
                            if(raw && raw.includes('dropload')) {
                                const id = raw.match(/dropload\.tv\/e\/([a-zA-Z0-9_-]+)/)?.[1];
                                if(id) {
                                    this.addSource({
                                        name: '‚ö° THUNDERBOLT',
                                        lang: lang,
                                        type: 'iframe',
                                        url: `https://unlimplay.com/embed2/?host=dropload&id=${id}&poster=${encodeURIComponent(movieData.backdrop)}`,
                                        icon: 'fa-bolt',
                                        provider: 'verhd'
                                    });
                                }
                            }
                        });
                    });
                } catch(e) {}
            },

            // --- Blog (VIP) ---
            scrapeBlogFallback: async function(title) {
                try {
                    if(!title) return;
                    const query = encodeURIComponent(title.split(':')[0].toLowerCase());
                    const res = await fetch(CONFIG.PROXY_URL + encodeURIComponent(`${CONFIG.TARGET_BLOG}/search?q=${query}`));
                    const html = await res.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    const card = Array.from(doc.querySelectorAll('.cards-movie')).find(c => c.textContent.toLowerCase().includes(title.split(':')[0].toLowerCase()));
                    if(card) {
                        const link = card.querySelector('a').href;
                        const postRes = await fetch(CONFIG.PROXY_URL + encodeURIComponent(link));
                        const postHtml = await postRes.text();
                        const postDoc = parser.parseFromString(postHtml, 'text/html');
                        
                        postDoc.querySelectorAll('iframe').forEach((iframe, i) => {
                             if(iframe.src.includes('videoUrl=')) {
                                 const encoded = new URLSearchParams(iframe.src.split('?')[1]).get('videoUrl');
                                 if(encoded) {
                                     this.addSource({
                                         name: `üíé DIAMOND [VIP] ${i+1}`,
                                         lang: 'Latino',
                                         type: 'direct', 
                                         url: atob(encoded),
                                         icon: 'fa-star',
                                         provider: 'blog'
                                     });
                                 }
                             }
                        });
                    }
                } catch(e) {}
            }
        };

        // INICIAR
        window.addEventListener('load', () => ui.init());
    </script>
</body>
</html>
