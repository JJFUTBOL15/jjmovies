<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMax Premium Ultra</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Plyr CSS & JS -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    
    <!-- HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            DEFAULT: '#3b82f6',
                            light: '#60a5fa',
                            dark: '#2563eb',
                            glow: 'rgba(59, 130, 246, 0.5)'
                        }
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'scale-in': 'scaleIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-in-right': 'slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-glow': 'pulseGlow 3s infinite',
                        'slow-zoom': 'slowZoom 20s infinite alternate',
                        'shimmer': 'shimmer 2s infinite linear',
                    },
                    keyframes: {
                        fadeInUp: { '0%': { opacity: 0, transform: 'translateY(40px)' }, '100%': { opacity: 1, transform: 'translateY(0)' } },
                        scaleIn: { '0%': { opacity: 0, transform: 'scale(0.95)' }, '100%': { opacity: 1, transform: 'scale(1)' } },
                        slideInRight: { '0%': { opacity: 0, transform: 'translateX(20px)' }, '100%': { opacity: 1, transform: 'translateX(0)' } },
                        pulseGlow: { '0%, 100%': { boxShadow: '0 0 20px rgba(59, 130, 246, 0.2)' }, '50%': { boxShadow: '0 0 40px rgba(59, 130, 246, 0.6)' } },
                        slowZoom: { '0%': { transform: 'scale(1)' }, '100%': { transform: 'scale(1.1)' } },
                        shimmer: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(100%)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: white; overflow-x: hidden; font-family: 'Outfit', sans-serif; }
        .glass-panel { background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        .glass-strong { background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(24px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .hidden-force { display: none !important; }
        :root { --plyr-color-main: #3b82f6; --plyr-video-background: #000; }
        .plyr--full-ui input[type=range] { color: var(--plyr-color-main); }
        .plyr__control--overlaid { background: rgba(59, 130, 246, 0.9); }
        .plyr--video .plyr__controls { background: linear-gradient(rgba(0,0,0,0), rgba(0,0,0,0.8)); }
        .lang-flag { transition: all 0.3s ease; filter: grayscale(100%) opacity(0.6); transform: scale(0.9); border: 2px solid transparent; border-radius: 6px; }
        .lang-flag:hover { filter: grayscale(0%) opacity(1); transform: scale(1.05); }
        .lang-flag.active { filter: grayscale(0%) opacity(1); transform: scale(1.1); border-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }
    </style>
</head>
<body class="relative min-h-screen">

    <!-- Navbar -->
    <nav id="navbar" class="fixed top-0 w-full z-40 px-8 py-6 flex justify-between items-center">
        <div class="text-3xl font-extrabold tracking-tighter cursor-default group">
            Cine<span class="text-brand group-hover:text-white transition-colors duration-300">Max</span>
            <div class="h-1 w-0 bg-brand group-hover:w-full transition-all duration-300 rounded-full"></div>
        </div>
        <div id="status-msg" class="text-sm font-semibold text-brand animate-pulse tracking-wide"></div>
    </nav>

    <!-- Background -->
    <div class="fixed inset-0 overflow-hidden z-0 pointer-events-none">
        <div id="backdrop-img" class="absolute inset-0 bg-cover bg-center bg-no-repeat transition-opacity duration-1000 opacity-0 animate-slow-zoom"></div>
        <div class="absolute inset-0 bg-gradient-to-t from-[#050505] via-[#050505]/80 to-transparent"></div>
    </div>

    <!-- Content -->
    <div class="relative z-10 container mx-auto px-6 h-screen flex items-center">
        <div id="movie-info" class="max-w-3xl flex flex-col items-start gap-8">
            <h1 id="movie-title" class="text-5xl md:text-8xl font-black leading-none tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-white via-gray-200 to-gray-500 drop-shadow-2xl opacity-0 animate-fade-in-up delay-200">
                Cargando...
            </h1>
            <h2 id="episode-title" class="text-xl md:text-2xl text-gray-400 font-light mt-2 opacity-0 animate-fade-in-up delay-300 hidden-force"></h2>
            <p id="movie-overview" class="text-gray-300 text-lg md:text-xl leading-relaxed max-w-2xl opacity-0 animate-fade-in-up delay-400">
                Esperando datos...
            </p>
            <div class="opacity-0 animate-fade-in-up delay-500">
                <button onclick="startScraping()" class="px-10 py-5 bg-brand hover:bg-white rounded-full font-bold text-white hover:text-brand transition-all duration-500 shadow-[0_0_30px_rgba(59,130,246,0.4)] hover:shadow-[0_0_60px_rgba(59,130,246,0.8)] hover:scale-105 flex items-center gap-4">
                    <i class="fas fa-play text-xl"></i> 
                    <span class="tracking-wider">REPRODUCIR AHORA</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Player Modal -->
    <div id="player-modal" class="fixed inset-0 z-50 bg-[#050505] hidden flex flex-row overflow-hidden">
        <div id="video-wrapper" class="relative w-full md:w-3/4 h-full bg-black flex items-center justify-center">
            <button onclick="closePlayer()" class="absolute top-4 left-4 z-20 w-10 h-10 rounded-full bg-white/10 hover:bg-red-500/20 flex items-center justify-center">
                <i class="fas fa-arrow-left"></i>
            </button>
            <video id="player" class="w-full h-full" playsinline controls crossorigin></video>
            <div id="iframe-container" class="absolute inset-0 hidden"></div>
        </div>

        <div id="server-panel" class="w-full md:w-1/4 h-full glass-panel flex flex-col">
            <div class="p-6 border-b border-white/5 flex justify-between items-center">
                <h3 class="text-xl font-bold"><i class="fas fa-server text-brand"></i> Fuentes</h3>
                <div class="text-xs bg-white/5 px-2 py-1 rounded"><span id="server-count">0</span> Disp.</div>
            </div>
            <div class="flex justify-center gap-3 p-4">
                <button onclick="setLanguageFilter('latino')" class="lang-flag" id="btn-latino"><img src="https://flagcdn.com/h24/mx.png" alt="Latino" title="Latino"></button>
                <button onclick="setLanguageFilter('castellano')" class="lang-flag" id="btn-castellano"><img src="https://flagcdn.com/h24/es.png" alt="Castellano" title="Castellano"></button>
                <button onclick="setLanguageFilter('subtitulado')" class="lang-flag" id="btn-subtitulado"><img src="https://flagcdn.com/h24/us.png" alt="Sub" title="Subtitulado"></button>
            </div>
            <div id="server-list-container" class="flex-1 overflow-y-auto p-4 space-y-3">Esperando selección...</div>
        </div>
    </div>

    <!-- Loader -->
    <div id="loader-overlay" class="fixed inset-0 z-60 bg-black/95 hidden flex flex-col items-center justify-center">
        <div class="w-24 h-24 border-4 border-t-brand rounded-full animate-spin"></div>
        <p id="loader-text" class="mt-8 text-white font-bold text-sm uppercase">Buscando enlaces...</p>
    </div>

    <script>
        const API_KEY = 'da8b836389708e0558de674492931977';
        const PROXY_URL = 'https://api.codetabs.com/v1/proxy/?quest=';

        let movieData = { tmdbId: null, imdbId: null, title: '', backdrop: '', type: 'movie', season: 1, episode: 1 };
        let sourcesList = [];
        let currentLanguage = 'all';
        let playerInstance = null;

        const statusMsg = document.getElementById('status-msg');
        const iframeContainer = document.getElementById('iframe-container');
        const videoElement = document.getElementById('player');

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const season = params.get('season');
            const episode = params.get('episode');

            if (id) {
                if (season && episode) {
                    movieData.type = 'tv';
                    movieData.season = parseInt(season);
                    movieData.episode = parseInt(episode);
                    fetchTMDBTV(id);
                } else {
                    fetchTMDBMovie(id);
                }
            } else {
                document.getElementById('movie-title').textContent = "CineMax";
                document.getElementById('movie-overview').textContent = "Agrega ?id=XXXX al enlace";
            }
        });

        async function fetchTMDBMovie(id) {
            const res = await fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=${API_KEY}&language=es-MX&append_to_response=external_ids`);
            const data = await res.json();
            movieData.tmdbId = data.id;
            movieData.imdbId = data.external_ids?.imdb_id;
            movieData.title = data.title;
            movieData.backdrop = data.backdrop_path ? `https://image.tmdb.org/t/p/original${data.backdrop_path}` : '';
            updateUI(data);
        }

        async function fetchTMDBTV(id) {
            const show = await fetch(`https://api.themoviedb.org/3/tv/${id}?api_key=${API_KEY}&language=es-MX&append_to_response=external_ids`).then(r => r.json());
            movieData.imdbId = show.external_ids?.imdb_id;
            movieData.title = show.name;
            movieData.backdrop = show.backdrop_path ? `https://image.tmdb.org/t/p/original${show.backdrop_path}` : '';
            updateUI(show);
        }

        function updateUI(data) {
            document.getElementById('movie-title').textContent = data.title || data.name;
            document.getElementById('movie-overview').textContent = data.overview || "Sin descripción.";
            if (movieData.backdrop) {
                document.getElementById('backdrop-img').style.backgroundImage = `url('${movieData.backdrop}')`;
                document.getElementById('backdrop-img').classList.remove('opacity-0');
            }
            document.querySelectorAll('.animate-fade-in-up').forEach(el => el.classList.remove('opacity-0'));
        }

        async function startScraping() {
            openPlayerUI();
            setLoading(true, "Buscando enlaces potentes 2025...");
            sourcesList = [];

            const promises = [];
            const titleNorm = encodeURIComponent(movieData.title);

            promises.push(scrapeCinecalidad(titleNorm));
            promises.push(scrapeCuevana(titleNorm));
            promises.push(scrapePelisplus(titleNorm));
            promises.push(scrapeGnula(titleNorm));
            promises.push(scrapeEmbed69());

            await Promise.allSettled(promises);
            setLoading(false);

            updateServerList();
            if (sourcesList.length > 0) playSource(sourcesList[0]);
            else alert("No se encontraron enlaces hoy. Prueba con otra película.");
        }

        async function scrapeCinecalidad(title) {
            try {
                const res = await fetch(PROXY_URL + `https://cinecalidad.rs/buscar/${title}`);
                const html = await res.text();
                const link = html.match(/href="(https:\/\/cinecalidad\.rs\/[^"]*?)"/);
                if (link) {
                    const page = await fetch(PROXY_URL + link[1]);
                    const pageHtml = await page.text();
                    const iframes = pageHtml.match(/src="(https:\/\/[^"]+?(streamtape|filemoon|voe)[^"]*)"/g) || [];
                    iframes.forEach(i => addSource({name: "CineCalidad HD", lang: "Latino", url: i.match(/src="([^"]*)"/)[1], provider: "cinecalidad"}));
                }
            } catch (e) {}
        }

        async function scrapeCuevana(title) {
            try {
                const res = await fetch(PROXY_URL + `https://cuevana3.ch/buscar/${title}`);
                const html = await res.text();
                const links = html.match(/href="(https:\/\/cuevana3\.ch\/[^"]*?)"/g) || [];
                for (let l of links) {
                    const page = await fetch(PROXY_URL + l.match(/href="([^"]*)"/)[1]);
                    const pageHtml = await page.text();
                    const players = pageHtml.match(/src="(https:\/\/[^"]+?(streamtape|voe|filemoon)[^"]*)"/g) || [];
                    players.forEach(p => addSource({name: "Cuevana Pro", lang: "Latino", url: p.match(/src="([^"]*)"/)[1], provider: "cuevana"}));
                }
            } catch (e) {}
        }

        async function scrapePelisplus(title) {
            try {
                const res = await fetch(PROXY_URL + `https://pelisplus.soy/buscar/${title}`);
                const html = await res.text();
                const iframes = html.match(/data-src="(https:\/\/[^"]+?(streamtape|voe|filemoon)[^"]*)"/g) || [];
                iframes.forEach(i => addSource({name: "PelisPlus", lang: "Latino", url: i.match(/data-src="([^"]*)"/)[1], provider: "pelisplus"}));
            } catch (e) {}
        }

        async function scrapeGnula(title) {
            try {
                const res = await fetch(PROXY_URL + `https://gnula.nu/?s=${title}`);
                const html = await res.text();
                const iframe = html.match(/src="(https:\/\/gnula\.nu\/wp-content[^"]*player[^"]*)"/);
                if (iframe) addSource({name: "Gnula Player", lang: "Latino", url: iframe[1], provider: "gnula"});
            } catch (e) {}
        }

        async function scrapeEmbed69() {
            if (!movieData.imdbId) return;
            try {
                const url = movieData.type === 'tv' ? `https://embed69.org/f/${movieData.imdbId}-${movieData.season}x${String(movieData.episode).padStart(2, '0')}/` : `https://embed69.org/f/${movieData.imdbId}/`;
                const res = await fetch(PROXY_URL + url);
                const html = await res.text();
                const match = html.match(/let dataLink\s*=\s*(\[[\s\S]*?\]);/);
                if (match) {
                    const data = JSON.parse(match[1]);
                    data.forEach(item => {
                        const lang = /LAT/i.test(item.video_language) ? "Latino" : /ESP|CAS/i.test(item.video_language) ? "Castellano" : "Subtitulado";
                        item.sortedEmbeds.forEach(embed => {
                            const decoded = decodeJWT(embed.link);
                            if (decoded?.link) addSource({name: embed.servername, lang, url: decoded.link, provider: "embed69"});
                        });
                    });
                }
            } catch (e) {}
        }

        function decodeJWT(t) {
            try {
                const p = t.split('.')[1];
                return JSON.parse(atob(p.replace(/-/g, '+').replace(/_/g, '/')));
            } catch { return null; }
        }

        function addSource(source) {
            if (!sourcesList.some(s => s.url === source.url)) sourcesList.push(source);
        }

        function updateServerList() {
            sourcesList.sort((a, b) => {
                const order = {cinecalidad: 0, cuevana: 1, pelisplus: 2, gnula: 3, embed69: 4};
                return (order[a.provider] || 5) - (order[b.provider] || 5);
            });

            document.getElementById('server-count').textContent = sourcesList.length;
            const container = document.getElementById('server-list-container');
            container.innerHTML = '';
            sourcesList.forEach((s, i) => {
                const div = document.createElement('div');
                div.className = 'p-3 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 cursor-pointer transition-all';
                div.innerHTML = `<div class="font-bold">${s.name}</div><div class="text-xs text-gray-400">${s.lang}</div>`;
                div.onclick = () => playSource(s);
                container.appendChild(div);
            });
        }

        function playSource(source) {
            iframeContainer.innerHTML = `<iframe src="${source.url}" class="w-full h-full border-0" allowfullscreen></iframe>`;
            iframeContainer.classList.remove('hidden');
            videoElement.classList.add('hidden');
        }

        function openPlayerUI() {
            document.getElementById('player-modal').classList.remove('hidden');
        }

        function closePlayer() {
            document.getElementById('player-modal').classList.add('hidden');
            iframeContainer.innerHTML = '';
        }

        function setLoading(active, text = "Cargando...") {
            const overlay = document.getElementById('loader-overlay');
            const txt = document.getElementById('loader-text');
            if (active) {
                overlay.classList.remove('hidden');
                txt.textContent = text;
            } else {
                overlay.classList.add('hidden');
            }
        }

        function setLanguageFilter(lang) {
            currentLanguage = lang;
            // Aquí puedes filtrar la lista si quieres (opcional)
        }
    </script>
</body>
</html>
