<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JJMOVIES - Ultra Premium</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;600;800&family=Inter:wght@300;400;600;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        netflixRed: '#E50914',
                        netflixDark: '#141414',
                        brandBlue: '#3b82f6', // Azul de tu otro código
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.8s ease-out',
                        'pulse-slow': 'pulse 3s infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #141414;
            color: white;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* Tipografía Logo */
        .font-logo { font-family: 'Bebas Neue', cursive; letter-spacing: 2px; }

        /* Scrollbars Ocultos pero funcionales */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Scrollbar personalizado para la lista de servidores */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #111; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #E50914; }

        /* Efectos Hover Cards */
        .movie-card { transition: transform 0.3s, z-index 0.3s; z-index: 10; position: relative; }
        .movie-card:hover { transform: scale(1.1); z-index: 50; box-shadow: 0 10px 20px rgba(0,0,0,0.8); }

        /* Navbar Gradiente */
        .nav-gradient { background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%); }
        .nav-solid { background-color: #141414; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }

        /* Estilos del Reproductor (Glassmorphism del otro código) */
        .glass-panel {
            background: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Plyr Colors Overrides */
        :root { --plyr-color-main: #E50914; } /* Rojo Netflix en el player */
        
        /* Flags */
        .lang-flag.active { filter: brightness(1.2); transform: scale(1.1); border: 2px solid white; border-radius: 4px; }
        .lang-flag { transition: all 0.2s; opacity: 0.6; filter: grayscale(1); }
        .lang-flag:hover { opacity: 1; filter: grayscale(0); }

        /* Loader */
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(255,255,255,0.1);
            border-top-color: #E50914;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="selection:bg-red-600 selection:text-white">

    <nav id="navbar" class="fixed top-0 w-full z-50 px-4 md:px-12 py-4 transition-all duration-300 nav-gradient flex items-center justify-between">
        <div class="flex items-center gap-8">
            <a href="#" onclick="app.loadHome()" class="text-3xl md:text-4xl font-logo text-netflixRed cursor-pointer drop-shadow-md">JJMOVIES</a>
            
            <div class="hidden md:flex gap-6 text-sm font-medium text-gray-300">
                <a onclick="app.loadHome()" class="hover:text-white cursor-pointer font-bold">Inicio</a>
                <a onclick="app.loadGenre(28, 'Acción')" class="hover:text-white cursor-pointer">Acción</a>
                <a onclick="app.loadGenre(16, 'Animación')" class="hover:text-white cursor-pointer">Infantil</a>
                <a onclick="app.loadGenre(27, 'Terror')" class="hover:text-white cursor-pointer">Terror</a>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="hidden md:flex items-center bg-black/60 border border-white/30 rounded px-3 py-1 focus-within:border-white w-64 transition-all">
                <i class="fas fa-search text-gray-400 mr-2"></i>
                <input type="text" id="searchInput" placeholder="Títulos, personas..." class="bg-transparent border-none outline-none text-sm text-white w-full" onkeyup="app.handleSearch(this.value)">
            </div>
            <i class="fas fa-search md:hidden text-white text-xl cursor-pointer" onclick="document.getElementById('mobile-search').classList.toggle('hidden')"></i>
            <img src="https://upload.wikimedia.org/wikipedia/commons/0/0b/Netflix-avatar.png" class="w-8 h-8 rounded cursor-pointer border border-transparent hover:border-white">
        </div>
    </nav>

    <div id="mobile-search" class="fixed top-0 left-0 w-full bg-[#141414] p-4 z-[60] hidden border-b border-gray-800 flex items-center gap-3">
        <i class="fas fa-arrow-left text-white text-xl" onclick="document.getElementById('mobile-search').classList.add('hidden')"></i>
        <input type="text" class="w-full bg-[#333] text-white p-2 rounded outline-none" placeholder="Buscar..." onkeyup="app.handleSearch(this.value)">
    </div>

    <main class="min-h-screen pb-20">
        
        <header id="hero" class="relative h-[80vh] w-full bg-cover bg-center hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-black via-black/50 to-transparent"></div>
            <div class="absolute inset-0 bg-gradient-to-t from-[#141414] via-transparent to-transparent"></div>
            
            <div class="absolute bottom-[20%] left-4 md:left-12 max-w-2xl space-y-4 animate-slide-up">
                <div class="flex items-center gap-2">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/08/Netflix_2015_N_logo.svg/1200px-Netflix_2015_N_logo.svg.png" class="w-5">
                    <span class="text-xs font-bold tracking-widest text-gray-300 uppercase">Película / Serie</span>
                </div>
                <h1 id="hero-title" class="text-5xl md:text-7xl font-black leading-none drop-shadow-lg font-logo">TITULO</h1>
                <p id="hero-desc" class="text-white text-base md:text-lg line-clamp-3 drop-shadow-md text-gray-200"></p>
                
                <div class="flex gap-4 pt-4">
                    <button id="hero-play-btn" class="bg-white text-black px-8 py-3 rounded font-bold hover:bg-gray-200 flex items-center gap-2 transition hover:scale-105">
                        <i class="fas fa-play"></i> Reproducir
                    </button>
                    <button id="hero-info-btn" class="bg-gray-500/40 text-white px-8 py-3 rounded font-bold hover:bg-gray-500/30 flex items-center gap-2 backdrop-blur-md transition">
                        <i class="fas fa-info-circle"></i> Más información
                    </button>
                </div>
            </div>
        </header>

        <div id="home-rows" class="relative z-10 -mt-32 pl-4 md:pl-12 pb-12 space-y-10 hidden">
            </div>

        <div id="grid-view" class="hidden pt-24 px-4 md:px-12">
            <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
                <h2 id="grid-title" class="text-2xl font-bold text-white">Resultados</h2>
                <i class="fas fa-times text-2xl cursor-pointer hover:text-red-500" onclick="app.loadHome()"></i>
            </div>
            <div id="grid-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        </div>

        <div id="global-loader" class="fixed inset-0 bg-[#141414] z-[100] flex items-center justify-center">
            <div class="spinner"></div>
        </div>
    </main>

    <div id="player-modal" class="fixed inset-0 z-[200] bg-black hidden flex opacity-0 transition-opacity duration-500">
        
        <div id="video-wrapper" class="relative w-full md:w-3/4 h-full bg-black flex items-center justify-center transition-all duration-300">
            <div class="absolute top-4 left-4 z-20 flex gap-4">
                <button onclick="player.close()" class="bg-black/50 hover:bg-red-600 text-white w-10 h-10 rounded-full flex items-center justify-center backdrop-blur transition border border-white/10">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <button onclick="player.toggleSidebar()" class="md:hidden bg-black/50 text-white w-10 h-10 rounded-full flex items-center justify-center backdrop-blur border border-white/10">
                    <i class="fas fa-list"></i>
                </button>
            </div>

            <video id="plyr-player" class="w-full h-full" playsinline controls></video>
            <div id="iframe-fallback" class="absolute inset-0 w-full h-full hidden bg-black"></div>
        </div>

        <div id="server-sidebar" class="absolute right-0 top-0 h-full w-full md:w-1/4 glass-panel flex flex-col z-30 transform translate-x-full md:translate-x-0 transition-transform duration-300">
            
            <div class="p-6 border-b border-white/10 bg-black/40">
                <h3 class="text-xl font-bold text-white mb-1 flex items-center gap-2">
                    <i class="fas fa-server text-netflixRed"></i> Servidores
                </h3>
                <p id="server-status" class="text-xs text-gray-400">Buscando enlaces...</p>
                
                <div class="flex justify-center gap-4 mt-4">
                    <img src="https://embed69.org/static/lang/LAT.png" class="w-8 cursor-pointer lang-flag active" onclick="player.filterLang('Latino', this)" title="Latino">
                    <img src="https://embed69.org/static/lang/ESP.png" class="w-8 cursor-pointer lang-flag" onclick="player.filterLang('Castellano', this)" title="Castellano">
                    <img src="https://embed69.org/static/lang/SUB.png" class="w-8 cursor-pointer lang-flag" onclick="player.filterLang('Subtitulado', this)" title="Subtitulado">
                </div>
            </div>

            <div id="server-list" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scroll">
                <div class="text-center mt-10 text-gray-500 animate-pulse">
                    <i class="fas fa-satellite-dish text-4xl mb-2"></i>
                    <p>Escaneando la red...</p>
                </div>
            </div>

            <div id="season-selector" class="p-4 border-t border-white/10 bg-black/60 hidden">
                <div class="flex gap-2 mb-2">
                    <select id="sel-season" class="bg-[#333] text-white text-xs p-2 rounded flex-1 outline-none"></select>
                    <select id="sel-episode" class="bg-[#333] text-white text-xs p-2 rounded flex-1 outline-none"></select>
                </div>
                <button onclick="player.loadEpisode()" class="w-full bg-netflixRed hover:bg-red-700 text-white py-2 rounded text-xs font-bold transition">
                    CAMBIAR EPISODIO
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTES ---
        const CONFIG = {
            apiKey: 'da8b836389708e0558de674492931977', // Tu API Key
            baseUrl: 'https://api.themoviedb.org/3',
            imgBase: 'https://image.tmdb.org/t/p/original',
            posterBase: 'https://image.tmdb.org/t/p/w500',
            proxy: 'https://api.codetabs.com/v1/proxy/?quest=',
            targetBlog: 'https://darkstatonmovies1.blogspot.com'
        };

        // --- ESTADO DE LA APP ---
        const state = {
            currentMovie: null, // Datos de TMDB
            sources: [], // Lista de servidores encontrados
            filter: 'Latino', // Filtro actual
            plyr: null, // Instancia del player
            isSidebarOpen: false
        };

        // --- APP PRINCIPAL (UI) ---
        const app = {
            init: function() {
                this.loadHome();
                // Scroll effect
                window.addEventListener('scroll', () => {
                    const nav = document.getElementById('navbar');
                    if(window.scrollY > 50) { nav.classList.add('nav-solid'); nav.classList.remove('nav-gradient'); }
                    else { nav.classList.add('nav-gradient'); nav.classList.remove('nav-solid'); }
                });
            },

            fetch: async function(endpoint) {
                try {
                    const res = await fetch(`${CONFIG.baseUrl}${endpoint}&api_key=${CONFIG.apiKey}&language=es-MX`);
                    return await res.json();
                } catch(e) { console.error(e); return null; }
            },

            loadHome: async function() {
                this.toggleView('home');
                const loader = document.getElementById('global-loader');
                
                // Cargar Tendencias
                const trending = await this.fetch('/trending/all/day?');
                if(!trending || !trending.results) return;

                // Configurar Hero
                const heroItem = trending.results[0];
                const heroBg = document.getElementById('hero');
                heroBg.style.backgroundImage = `url('${CONFIG.imgBase}${heroItem.backdrop_path}')`;
                document.getElementById('hero-title').innerText = heroItem.title || heroItem.name;
                document.getElementById('hero-desc').innerText = heroItem.overview;
                document.getElementById('hero').classList.remove('hidden');
                
                // Configurar botones Hero
                document.getElementById('hero-play-btn').onclick = () => player.open(heroItem.id, heroItem.media_type || 'movie');

                // Renderizar Filas
                const container = document.getElementById('home-rows');
                container.innerHTML = '';
                this.createRow(container, "Tendencias Ahora", trending.results);
                
                const action = await this.fetch('/discover/movie?with_genres=28');
                this.createRow(container, "Pura Adrenalina", action.results);
                
                const comedy = await this.fetch('/discover/movie?with_genres=35');
                this.createRow(container, "Comedias", comedy.results);

                loader.style.display = 'none';
            },

            createRow: function(container, title, items) {
                const section = document.createElement('div');
                section.innerHTML = `
                    <h3 class="text-white font-bold text-lg md:text-xl mb-4 hover:text-netflixRed cursor-pointer flex items-center gap-2 group">
                        ${title} <i class="fas fa-chevron-right text-xs opacity-0 group-hover:opacity-100 transition"></i>
                    </h3>
                    <div class="flex gap-3 overflow-x-auto hide-scroll pb-4">
                        ${items.map(m => m.poster_path ? `
                            <div class="relative flex-shrink-0 w-32 md:w-44 cursor-pointer movie-card rounded-md overflow-hidden" 
                                 onclick="player.open(${m.id}, '${m.title ? 'movie' : 'tv'}')">
                                <img src="${CONFIG.posterBase}${m.poster_path}" class="w-full h-full object-cover">
                            </div>
                        ` : '').join('')}
                    </div>
                `;
                container.appendChild(section);
            },

            handleSearch: async function(query) {
                if(query.length < 3) return;
                this.toggleView('grid');
                document.getElementById('grid-title').innerText = `Buscando: ${query}`;
                
                const res = await this.fetch(`/search/multi?query=${query}`);
                this.renderGrid(res.results);
            },

            loadGenre: async function(id, name) {
                this.toggleView('grid');
                document.getElementById('grid-title').innerText = name;
                const res = await this.fetch(`/discover/movie?with_genres=${id}`);
                this.renderGrid(res.results);
            },

            renderGrid: function(items) {
                const grid = document.getElementById('grid-container');
                grid.innerHTML = items.filter(i => i.poster_path).map(m => `
                    <div class="cursor-pointer relative group" onclick="player.open(${m.id}, '${m.title ? 'movie' : 'tv'}')">
                        <img src="${CONFIG.posterBase}${m.poster_path}" class="w-full rounded-md shadow-lg transition duration-300 group-hover:scale-105">
                        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex items-center justify-center transition rounded-md">
                            <i class="fas fa-play-circle text-4xl text-netflixRed"></i>
                        </div>
                    </div>
                `).join('');
            },

            toggleView: function(view) {
                const home = document.getElementById('home-rows');
                const hero = document.getElementById('hero');
                const grid = document.getElementById('grid-view');
                
                if(view === 'home') {
                    home.classList.remove('hidden'); hero.classList.remove('hidden'); grid.classList.add('hidden');
                } else {
                    home.classList.add('hidden'); hero.classList.add('hidden'); grid.classList.remove('hidden');
                }
            }
        };

        // --- MOTOR DE SCRAPING (Extracción de Enlaces) ---
        // Aquí está la magia del otro archivo, adaptada.
        const scraper = {
            searchLinks: async function(tmdbId, type, season = 1, episode = 1) {
                state.sources = [];
                player.updateListUI();
                
                // Obtener ID IMDB primero
                const endpoint = type === 'movie' ? `/movie/${tmdbId}` : `/tv/${tmdbId}`;
                const meta = await app.fetch(`${endpoint}?append_to_response=external_ids`);
                const imdbId = meta.external_ids?.imdb_id;
                
                if(!imdbId) {
                    this.addSource({ name: 'Error: No IMDB ID', url: '', lang: 'Error' });
                    return;
                }

                state.currentMovie = { ...meta, type, season, episode, imdbId };

                // Iniciar escaneo paralelo
                const promises = [];
                
                if(type === 'movie') {
                    promises.push(this.scrapeEmbed69(imdbId));
                    promises.push(this.scrapeVerHD(imdbId));
                    promises.push(this.scrapeBlog(meta.title));
                } else {
                    promises.push(this.scrapeEmbed69Series(imdbId, season, episode));
                }

                await Promise.allSettled(promises);
                
                if(state.sources.length === 0) {
                    document.getElementById('server-list').innerHTML = '<div class="text-center mt-10">No se encontraron enlaces :(</div>';
                }
            },

            // Fuente 1: Embed69
            scrapeEmbed69: async function(imdbId) {
                try {
                    const url = `https://embed69.org/f/${imdbId}/`;
                    const html = await this.getHtml(url);
                    this.parseEmbed69(html, 'Embed69');
                } catch(e) { console.log('Embed69 Error', e); }
            },

            scrapeEmbed69Series: async function(imdbId, s, e) {
                try {
                    const slug = `${imdbId}-${s}x${e}`; // Formato tt12345-1x1
                    // A veces necesita padding 1x01
                    const slugPad = `${imdbId}-${s}x${String(e).padStart(2,'0')}`;
                    
                    let html = await this.getHtml(`https://embed69.org/f/${slugPad}/`);
                    if(!html.includes('dataLink')) html = await this.getHtml(`https://embed69.org/f/${slug}/`);
                    
                    this.parseEmbed69(html, 'Embed69 TV');
                } catch(e) { console.log('Embed69 TV Error', e); }
            },

            parseEmbed69: function(html, sourceName) {
                const match = html.match(/let dataLink\s*=\s*(\[[\s\S]*?\]);/);
                if(match) {
                    const data = JSON.parse(match[1]);
                    data.forEach(item => {
                        let lang = 'Subtitulado';
                        if(item.video_language.includes('LAT')) lang = 'Latino';
                        if(item.video_language.includes('ESP') || item.video_language.includes('CAS')) lang = 'Castellano';
                        
                        item.sortedEmbeds.forEach(embed => {
                            const link = this.decodeJWT(embed.link);
                            if(link) this.addSource({
                                name: embed.servername + ` [${sourceName}]`,
                                url: link,
                                lang: lang,
                                type: 'iframe'
                            });
                        });
                    });
                }
            },

            // Fuente 2: VerHDLink
            scrapeVerHD: async function(imdbId) {
                try {
                    const html = await this.getHtml(`https://verhdlink.cam/movie/${imdbId}`);
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    doc.querySelectorAll('ul._player-mirrors').forEach(ul => {
                        let lang = 'Latino';
                        if(ul.className.includes('subtitulado')) lang = 'Subtitulado';
                        if(ul.className.includes('castellano')) lang = 'Castellano';
                        
                        ul.querySelectorAll('li').forEach(li => {
                            const raw = li.getAttribute('data-link');
                            // Extraer ID de Dropload o similares
                            if(raw && raw.includes('dropload')) {
                                const id = raw.split('/').pop();
                                this.addSource({
                                    name: 'Ultra Fast (VerHD)',
                                    url: `https://dropload.io/e/${id}`, 
                                    lang: lang,
                                    type: 'iframe'
                                });
                            }
                        });
                    });
                } catch(e) {}
            },

            // Fuente 3: Blogspot (Fallback)
            scrapeBlog: async function(title) {
                // Lógica simplificada para el ejemplo, busca en el blog configurado
                try {
                    const query = encodeURIComponent(title.split(':')[0]); // Solo primera parte del titulo
                    const html = await this.getHtml(`${CONFIG.targetBlog}/search?q=${query}`);
                    // Parsing básico... (depende de la estructura del blog)
                } catch(e) {}
            },

            // Utilidades
            getHtml: async function(url) {
                const res = await fetch(CONFIG.proxy + encodeURIComponent(url));
                return await res.text();
            },

            decodeJWT: function(token) {
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                    return JSON.parse(jsonPayload).link;
                } catch(e) { return null; }
            },

            addSource: function(src) {
                // Evitar duplicados
                if(!state.sources.some(s => s.url === src.url)) {
                    state.sources.push(src);
                    player.updateListUI();
                }
            }
        };

        // --- CONTROLADOR DEL REPRODUCTOR (UI) ---
        const player = {
            open: function(tmdbId, type) {
                // Mostrar Modal
                const modal = document.getElementById('player-modal');
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
                
                // Resetear estado
                document.getElementById('server-list').innerHTML = '<div class="text-center mt-10"><div class="spinner mx-auto mb-4"></div>Buscando...</div>';
                
                // Si es serie, mostrar selectores
                const seasonSel = document.getElementById('season-selector');
                if(type === 'tv') {
                    seasonSel.classList.remove('hidden');
                    this.setupSeriesUI(tmdbId);
                } else {
                    seasonSel.classList.add('hidden');
                    scraper.searchLinks(tmdbId, 'movie');
                }
            },

            close: function() {
                const modal = document.getElementById('player-modal');
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    if(state.plyr) state.plyr.stop();
                    document.getElementById('iframe-fallback').innerHTML = '';
                }, 500);
            },

            updateListUI: function() {
                const list = document.getElementById('server-list');
                const filtered = state.sources.filter(s => s.lang === state.filter);
                
                document.getElementById('server-status').innerText = `${state.sources.length} encontrados | ${filtered.length} filtrados`;

                list.innerHTML = filtered.map(s => `
                    <div onclick="player.play('${s.url}', '${s.type}')" 
                         class="bg-[#222] p-3 rounded flex items-center justify-between cursor-pointer hover:bg-[#333] hover:border-l-4 hover:border-blue-500 transition-all border border-transparent">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-blue-900/50 flex items-center justify-center text-blue-400">
                                <i class="fas fa-play text-xs"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-gray-200">${s.name}</h4>
                                <span class="text-xs text-gray-500">${s.lang}</span>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-600"></i>
                    </div>
                `).join('');
                
                if(filtered.length === 0 && state.sources.length > 0) {
                    list.innerHTML = '<div class="text-center text-gray-500 mt-4">No hay servidores en este idioma. Prueba otro.</div>';
                }
            },

            filterLang: function(lang, btn) {
                state.filter = lang;
                document.querySelectorAll('.lang-flag').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                this.updateListUI();
            },

            play: function(url, type) {
                const videoEl = document.getElementById('plyr-player');
                const iframeDiv = document.getElementById('iframe-fallback');
                
                // Limpiar anterior
                if(state.plyr) state.plyr.destroy();
                iframeDiv.classList.add('hidden');
                iframeDiv.innerHTML = '';
                videoEl.style.display = 'block';

                // Si es M3U8 o MP4 directo
                if(url.includes('.m3u8') || url.includes('.mp4')) {
                    if (Hls.isSupported() && url.includes('.m3u8')) {
                        const hls = new Hls();
                        hls.loadSource(url);
                        hls.attachMedia(videoEl);
                    } else {
                        videoEl.src = url;
                    }
                    state.plyr = new Plyr(videoEl, { autoplay: true, controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen'] });
                } else {
                    // Si es Iframe (Embed normal)
                    videoEl.style.display = 'none';
                    iframeDiv.classList.remove('hidden');
                    iframeDiv.innerHTML = `<iframe src="${url}" class="w-full h-full border-0" allowfullscreen></iframe>`;
                }
            },

            setupSeriesUI: async function(id) {
                const data = await app.fetch(`/tv/${id}?`);
                const sSelect = document.getElementById('sel-season');
                sSelect.innerHTML = '';
                
                for(let i=1; i<=data.number_of_seasons; i++) {
                    sSelect.innerHTML += `<option value="${i}">Temporada ${i}</option>`;
                }
                
                // Llenar episodios de la temp 1 por defecto
                this.updateEpisodes(id, 1);
                
                sSelect.onchange = (e) => this.updateEpisodes(id, e.target.value);
            },

            updateEpisodes: async function(id, season) {
                const data = await app.fetch(`/tv/${id}/season/${season}?`);
                const eSelect = document.getElementById('sel-episode');
                eSelect.innerHTML = '';
                
                data.episodes.forEach(ep => {
                    eSelect.innerHTML += `<option value="${ep.episode_number}">Ep. ${ep.episode_number} - ${ep.name}</option>`;
                });
            },

            loadEpisode: function() {
                const s = document.getElementById('sel-season').value;
                const e = document.getElementById('sel-episode').value;
                const m = state.currentMovie;
                
                document.getElementById('server-list').innerHTML = '<div class="text-center mt-10"><div class="spinner mx-auto"></div>Buscando S'+s+' E'+e+'...</div>';
                scraper.searchLinks(m.id, 'tv', s, e);
            },

            toggleSidebar: function() {
                const sb = document.getElementById('server-sidebar');
                state.isSidebarOpen = !state.isSidebarOpen;
                if(state.isSidebarOpen) {
                    sb.classList.remove('translate-x-full');
                } else {
                    sb.classList.add('translate-x-full');
                }
            }
        };

        // Iniciar
        window.addEventListener('load', () => app.init());

    </script>
</body>
</html>
