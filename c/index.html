/* global luxon, jQuery */
$ = jQuery;

// ============================================================
// ✅ URLS BASE
// ============================================================
const AGENDA_URL = "https://pltvhd.com/diaries.json";
const IMG_BASE   = "https://cdn.pltvhd.com";

// ============================================================
// DOM listo
// ============================================================
document.addEventListener("DOMContentLoaded", function () {
  obtenerAgenda();

  $(document).on("click", ".submenu-item", function (event) {
    event.stopPropagation();
  });

  $(document).on("click", ".toggle-submenu", function () {
    const $submenuElement = $(this).closest("li").find("ul");
    if (!$submenuElement.is(":visible")) {
      $(".toggle-submenu").not(this).closest("li").find("ul").slideUp();
      $submenuElement.slideDown();
    } else {
      $submenuElement.slideUp();
    }
  });

  setInterval(upgrade, 60000);
  window.scrollTo({ top: 0, behavior: "smooth" });
});

// ============================================================
// Refresco automático
// ============================================================
function upgrade() {
  const menuElement = document.getElementById("menu");
  const titleAgendaElement = document.getElementById("title-agenda");
  refrescarAgenda(menuElement, titleAgendaElement);
  console.info("♻️ Agenda actualizada automáticamente");
}

// ============================================================
// Utilidades
// ============================================================
function convertToUserTimeZone(utcHour) {
  const DateTime   = luxon.DateTime;
  const utcDate    = DateTime.fromISO(utcHour, { zone: "America/Lima" });
  return utcDate.toLocal().toFormat("HH:mm");
}

// Evita desfases: construye Date local a partir de YYYY-MM-DD
function formatLocalISODateToEs(dateStr) {
  const [y, m, d] = (dateStr || "").split("-").map(Number);
  if (!y || !m || !d) return null;
  const dt = new Date(y, m - 1, d);
  return dt.toLocaleDateString("es-ES", { year: "numeric", month: "long", day: "numeric" });
}

function formatTodayEs() {
  return new Date().toLocaleDateString("es-ES", { year: "numeric", month: "long", day: "numeric" });
}

// Toma la fecha más frecuente en el JSON (por si llegan varios días)
function extractDiaryDate(result) {
  const arr = (result && result.data) ? result.data : [];
  const dates = arr.map(it => it?.attributes?.date_diary).filter(Boolean);
  if (dates.length === 0) return null;
  const counts = Object.create(null);
  let best = dates[0], max = 0;
  for (const d of dates) {
    counts[d] = (counts[d] || 0) + 1;
    if (counts[d] > max) { max = counts[d]; best = d; }
  }
  return best; // YYYY-MM-DD
}

function setAgendaTitle(result, titleAgendaElement) {
  const dd   = extractDiaryDate(result);
  const text = dd ? formatLocalISODateToEs(dd) : formatTodayEs();
  if (titleAgendaElement) titleAgendaElement.innerHTML = "Agenda - " + (text || formatTodayEs());
}

// ============================================================
// Refrescar (NO limpia bruscamente el DOM)
// ============================================================
async function refrescarAgenda(menuElement, titleAgendaElement) {
  // fallback si no te los pasan
  menuElement       = menuElement       || document.getElementById("menu");
  titleAgendaElement= titleAgendaElement|| document.getElementById("title-agenda");

  try {
    const response = await fetch(AGENDA_URL, { cache: "no-store" });
    const result   = await response.json();
    renderAgenda(result, menuElement, titleAgendaElement);
  } catch (error) {
    console.error("Error al refrescar agenda:", error);
  }
}

// ============================================================
// Carga inicial
// ============================================================
async function obtenerAgenda() {
  const menuElement        = document.getElementById("menu");
  const titleAgendaElement = document.getElementById("title-agenda");

  try {
    const response = await fetch(AGENDA_URL, { cache: "no-store" });
    const result   = await response.json();
    renderAgenda(result, menuElement, titleAgendaElement);
  } catch (error) {
    console.error("❌ Error al cargar la agenda:", error);
  }
}

// ============================================================
// Renderizar HTML de la agenda
// ============================================================
function renderAgenda(result, menuElement, titleAgendaElement) {
  if (!result || !result.data) {
    if (titleAgendaElement) titleAgendaElement.innerHTML = "Agenda - Sin datos";
    if (menuElement) menuElement.innerHTML = "";
    return;
  }

  // Título desde JSON (fecha más frecuente) con fallback
  setAgendaTitle(result, titleAgendaElement);

  // Ordenar por fecha + hora (siempre que existan ambas)
  const data = (result.data || []).slice().sort((a, b) => {
    const A = (a?.attributes?.date_diary || "") + " " + (a?.attributes?.diary_hour || "");
    const B = (b?.attributes?.date_diary || "") + " " + (b?.attributes?.diary_hour || "");
    return A.localeCompare(B);
  });

  // Construcción del HTML
  let html = "";
  data.forEach((value) => {
    const attr   = value.attributes || {};
    const embeds = (attr.embeds && attr.embeds.data) || [];

    let imageUrl = `${IMG_BASE}/uploads/sin_imagen_d36205f0e8.png`;
    const flag   = attr.country?.data?.attributes?.image?.data?.attributes?.url;
    if (flag) imageUrl = `${IMG_BASE}${flag}`;

    html += `
      <li class="toggle-submenu" style="padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; list-style: none;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <div style="display: flex; align-items: center;">
            <time datetime="${attr.diary_hour || ""}" style="width: 3rem; text-align: center; font-weight: 700; font-size: 15px; font-family: Arial, Helvetica, sans-serif;">
              ${attr.diary_hour ? convertToUserTimeZone(attr.diary_hour) : "--:--"}
            </time>
            <img loading="lazy" src="${imageUrl}" alt="bandera" style="margin-left: 0.5rem; object-fit: cover; height: 1.5rem; width: 1.5rem;">
            <span style="flex: 1; margin-left: 1rem; text-align: left; font-weight: 700; color: #2d3748; font-family: Arial, Helvetica, sans-serif; font-size: 15px;">
              ${attr.diary_description || "Evento sin título"}
            </span>
          </div>
        </div>
        <ul style="margin-left: 1rem; border-radius: 0.5rem; display: none;">
          ${embeds.map((embed) => {
            if (!embed || !embed.attributes) return "";
            const urlComplete = embed.attributes.embed_iframe || "/star-plus";
            return `
              <div class="submenu" style="padding-top: 8px;">
                <a href="${urlComplete}" class="submenu-item" style="font-size: 0.875rem; color: #4a5568; text-decoration: none; transition: color 0.3s;">
                  <li style="padding: 0.5rem 0; width: 100%; display: flex; align-items: center; list-style: none;">
                    <img src="https://img.icons8.com/?size=10&id=59862&format=png&color=000000" style="margin-right: 0.5rem;" alt="play">
                    <span style="font-family: Arial, Helvetica, sans-serif; font-size: 15px;">
                      ${embed.attributes.embed_name || "Ver enlace"}
                    </span>
                  </li>
                </a>
              </div>`;
          }).join("")}
        </ul>
      </li>`;
  });

  if (menuElement) menuElement.innerHTML = html;
}
