<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>JJFUTBOL ULTRA FAST</title>
  
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root { --accent: #D4AF37; --bg: #000; --card: #121212; --border: #222; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: #fff; font-family: 'Roboto', sans-serif; margin: 0; padding: 0; }
    .hidden { display: none !important; }

    header { padding: 15px; text-align: center; background: #000; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 50; }
    .logo { font-family: 'Poppins'; font-size: 22px; font-weight: 800; color: #fff; margin: 0; }
    .logo span { color: var(--accent); }

    .container { max-width: 800px; margin: 0 auto; padding: 10px; padding-bottom: 80px; }

    /* BUSCADOR */
    .search-box { position: relative; margin-bottom: 15px; }
    .search-box input { width: 100%; background: #1a1a1a; border: 1px solid var(--accent); padding: 12px 15px 12px 40px; border-radius: 10px; color: white; outline: none; font-size: 14px; }
    .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--accent); }

    /* LISTA */
    #menu { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
    .card.active { border-color: var(--accent); }
    .card-header { padding: 12px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .time { background: #000; border: 1px solid #333; padding: 4px 8px; border-radius: 5px; font-weight: 700; color: var(--accent); font-size: 12px; min-width: 50px; text-align: center; }
    .info { flex: 1; display: flex; align-items: center; margin: 0 10px; overflow: hidden; }
    .flag { width: 22px; height: 22px; border-radius: 50%; margin-right: 8px; }
    .name { font-size: 13px; font-weight: 700; color: #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .channels { display: none; padding: 0 12px 12px; border-top: 1px solid var(--border); background: #080808; }
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
    .btn-ch { background: #222; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 8px; font-size: 11px; font-weight: 700; text-align: center; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .btn-ch:active { background: var(--accent); color: #000; }

    /* PLAYER LIMPIO */
    #player-view { background: #000; position: fixed; inset: 0; z-index: 100; display: flex; flex-direction: column; }
    .player-header { padding: 10px; display: flex; justify-content: space-between; align-items: center; background: #111; }
    .btn-back { background: #222; border: none; color: #fff; padding: 8px 15px; border-radius: 20px; font-size: 12px; cursor: pointer; font-weight: 700; }
    .video-box { flex: 1; position: relative; background: #000; display: flex; align-items: center; }
    .iframe-wrap { width: 100%; aspect-ratio: 16/9; position: relative; }
    iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: none; z-index: 1; }
    
    /* BOTÓN DESBLOQUEAR ÚNICO */
    .unlock { position: absolute; top: 10px; right: 10px; z-index: 50; background: rgba(0,0,0,0.7); border: 1px solid #ff4444; color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; cursor: pointer; }
    .shield { position: absolute; inset: 0; z-index: 10; background: transparent; }

    .loading { text-align: center; padding: 50px; color: #444; font-size: 14px; }
  </style>
</head>
<body>

  <header id="header">
    <div class="logo">JJFUTBOL <span>PREMIUM</span></div>
  </header>

  <div id="agenda-view" class="container">
    <div class="search-box">
      <i class="fas fa-search search-icon"></i>
      <input type="text" id="search" placeholder="Buscar partido o liga...">
    </div>
    <ul id="menu"></ul>
    <div id="loader" class="loading"><i class="fas fa-circle-notch fa-spin"></i></div>
  </div>

  <div id="player-view" class="hidden">
    <div class="player-header">
      <button class="btn-back" onclick="cerrarPlayer()"><i class="fas fa-arrow-left"></i> REGRESAR</button>
      <button class="unlock" onclick="desbloquear()"><i class="fas fa-unlock"></i> DESBLOQUEAR</button>
    </div>
    <div class="video-box">
      <div class="iframe-wrap">
        <div class="shield" onclick="this.style.display='none'"></div>
        <iframe id="viewer" allowfullscreen allow="autoplay"></iframe>
      </div>
    </div>
  </div>

  <script>
    // --- DOBLE FUENTE CONFIG ---
    const SOURCES = [
      { name: "G", url: "https://goolhd.com/agenda.json?v=1.07", img: "https://img.goolhd.com" },
      { name: "P", url: "https://pltvhd.com/diaries.json", img: "https://cdn.pltvhd.com" }
    ];
    // Usamos corsproxy.io por ser el más veloz para estos JSON
    const PROXY = "https://corsproxy.io/?"; 
    const EMBED = "https://www.jjfutbol.lat/f/embed/eventos.html?r=";

    async function cargarAgenda() {
      const menu = document.getElementById("menu");
      const loader = document.getElementById("loader");
      
      // Lanzar ambas peticiones al mismo tiempo (Paralelismo)
      const promesas = SOURCES.map(s => 
        fetch(PROXY + encodeURIComponent(s.url) + "&t=" + Date.now())
        .then(r => r.json())
        .then(d => (d.data || []).map(item => ({...item, _img: s.img})))
        .catch(() => [])
      );

      const resultados = await Promise.all(promesas);
      const eventos = resultados.flat(); // Unir sin eliminar duplicados

      if(!eventos.length) {
        loader.innerHTML = "Error al conectar. Reintenta.";
        return;
      }

      // Ordenar por hora
      eventos.sort((a,b) => (a.attributes.diary_hour || "").localeCompare(b.attributes.diary_hour || ""));

      let html = "";
      eventos.forEach(ev => {
        const at = ev.attributes;
        const hr = at.diary_hour ? at.diary_hour.substring(0,5) : "--:--";
        
        // Fix hora "Invalid"
        let horaFinal = hr;
        try {
          const dt = luxon.DateTime.fromFormat(hr, "HH:mm", {zone: "America/Lima"});
          if(dt.isValid) horaFinal = dt.toLocal().toFormat("HH:mm");
        } catch(e) {}

        const img = at.country?.data?.attributes?.image?.data?.attributes?.url ? ev._img + at.country.data.attributes.image.data.attributes.url : "";

        let btns = "";
        (at.embeds?.data || []).forEach(em => {
          let r = "";
          const ifr = em.attributes.embed_iframe || "";
          if(ifr.includes("?r=")) r = ifr.split("?r=")[1].split("&")[0];
          else if(ifr.startsWith("http")) r = btoa(ifr);
          if(r) btns += `<div class="btn-ch" onclick="abrirPlayer('${r}')"><i class="fas fa-play"></i> ${em.attributes.embed_name}</div>`;
        });

        html += `
          <li class="card">
            <div class="card-header">
              <div class="time">${horaFinal}</div>
              <div class="info">
                ${img ? `<img class="flag" src="${img}">` : ''}
                <span class="name">${at.diary_description}</span>
              </div>
              <i class="fas fa-chevron-down" style="color:#444;font-size:12px"></i>
            </div>
            <div class="channels">
              <div class="btn-grid">${btns || '<div style="font-size:10px;color:#555">Próximamente</div>'}</div>
            </div>
          </li>`;
      });
      menu.innerHTML = html;
      loader.style.display = "none";
    }

    let currentR = "";
    function abrirPlayer(r) {
      currentR = r;
      document.getElementById("agenda-view").classList.add("hidden");
      document.getElementById("header").classList.add("hidden");
      document.getElementById("player-view").classList.remove("hidden");
      const v = document.getElementById("viewer");
      v.setAttribute('sandbox', 'allow-forms allow-scripts allow-same-origin allow-pointer-lock allow-presentation');
      v.src = EMBED + r;
    }

    function cerrarPlayer() {
      document.getElementById("viewer").src = "";
      document.getElementById("player-view").classList.add("hidden");
      document.getElementById("agenda-view").classList.remove("hidden");
      document.getElementById("header").classList.remove("hidden");
    }

    function desbloquear() {
      const v = document.getElementById("viewer");
      v.removeAttribute('sandbox');
      v.src = EMBED + currentR;
    }

    // Buscador instantáneo
    document.getElementById("search").addEventListener("keyup", function() {
      const v = this.value.toLowerCase();
      document.querySelectorAll(".card").forEach(c => {
        c.style.display = c.innerText.toLowerCase().includes(v) ? "block" : "none";
      });
    });

    // Acordeon
    $(document).on("click", ".card-header", function() {
      const card = $(this).closest(".card");
      $(".card").not(card).removeClass("active").find(".channels").slideUp(200);
      card.toggleClass("active").find(".channels").slideToggle(200);
    });

    cargarAgenda();
  </script>
</body>
</html>
