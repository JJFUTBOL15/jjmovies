<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JJMOVIES V2.0 - BLUE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            DEFAULT: '#3b82f6',
                            light: '#60a5fa',
                            dark: '#2563eb',
                            glow: 'rgba(59, 130, 246, 0.5)'
                        }
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-glow': 'pulseGlow 3s infinite',
                        'slow-zoom': 'slowZoom 20s infinite alternate',
                        'shimmer': 'shimmer 2s infinite linear',
                    },
                    keyframes: {
                        fadeInUp: { '0%': { opacity: 0, transform: 'translateY(40px)' }, '100%': { opacity: 1, transform: 'translateY(0)' } },
                        pulseGlow: { '0%, 100%': { boxShadow: '0 0 20px rgba(59, 130, 246, 0.2)' }, '50%': { boxShadow: '0 0 40px rgba(59, 130, 246, 0.6)' } },
                        slowZoom: { '0%': { transform: 'scale(1)' }, '100%': { transform: 'scale(1.1)' } },
                        shimmer: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(100%)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: white; overflow-x: hidden; }
        .glass-panel { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        .glass-strong { background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(24px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .hidden-force { display: none !important; }
        .transition-width { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Plyr Colors */
        :root { --plyr-color-main: #3b82f6; --plyr-video-background: #000; --plyr-menu-background: rgba(20, 20, 20, 0.95); --plyr-menu-color: #fff; }
        
        /* Language Flags */
        .lang-flag { transition: all 0.3s ease; filter: grayscale(100%) opacity(0.6); transform: scale(0.9); border: 2px solid transparent; border-radius: 6px; }
        .lang-flag:hover { filter: grayscale(0%) opacity(1); transform: scale(1.05); }
        .lang-flag.active { filter: grayscale(0%) opacity(1); transform: scale(1.1); border-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }

        /* Click Shield (Anti-Ad) */
        .click-shield { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; cursor: pointer; background: transparent; }
    </style>
</head>
<body class="relative min-h-screen font-sans selection:bg-brand selection:text-white">

    <nav id="navbar" class="fixed top-0 w-full z-40 transition-all duration-500 px-8 py-6 flex justify-between items-center opacity-0 animate-fade-in-up">
        <div class="text-3xl font-extrabold tracking-tighter cursor-default group">
            JJ<span class="text-brand group-hover:text-white transition-colors duration-300">MOVIES</span>
            <div class="h-1 w-0 bg-brand group-hover:w-full transition-all duration-300 rounded-full"></div>
        </div>
        <div id="status-msg" class="text-sm font-semibold text-brand animate-pulse tracking-wide"></div>
    </nav>

    <div class="fixed inset-0 overflow-hidden z-0 pointer-events-none">
        <div id="backdrop-img" class="absolute inset-0 bg-cover bg-center bg-no-repeat transition-opacity duration-1000 opacity-0 animate-slow-zoom"></div>
        <div class="absolute inset-0 bg-gradient-to-t from-[#050505] via-[#050505]/80 to-transparent"></div>
        <div class="absolute inset-0 bg-gradient-to-r from-[#050505] via-[#050505]/50 to-transparent"></div>
    </div>

    <div class="relative z-10 container mx-auto px-6 h-screen flex items-center">
        <div id="movie-info" class="max-w-3xl flex flex-col items-start gap-6 md:gap-8">
            <div class="flex items-center gap-4 text-xs font-bold tracking-[0.2em] text-gray-400 uppercase opacity-0 animate-fade-in-up delay-100">
                <span id="movie-year" class="bg-white/5 border border-white/10 px-3 py-1 rounded-md backdrop-blur-sm">----</span>
                <span id="movie-runtime" class="flex items-center gap-1"><i class="far fa-clock"></i> -- min</span>
                <span id="movie-rating" class="text-yellow-400 flex items-center gap-1 drop-shadow-lg"></span>
            </div>

            <div class="w-full">
                <h1 id="movie-title" class="text-5xl md:text-8xl font-black leading-none tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-white via-gray-200 to-gray-500 drop-shadow-2xl opacity-0 animate-fade-in-up delay-200">Cargando...</h1>
                <h2 id="episode-title" class="text-xl md:text-2xl text-gray-400 font-light mt-2 opacity-0 animate-fade-in-up delay-300 hidden-force"></h2>
            </div>

            <div id="movie-genres" class="text-brand-light font-medium text-lg flex gap-3 opacity-0 animate-fade-in-up delay-300"></div>

            <div id="series-controls" class="hidden-force w-full flex flex-wrap items-center gap-4 opacity-0 animate-fade-in-up delay-400">
                <div class="flex items-center bg-white/5 backdrop-blur-md rounded-xl border border-white/10 p-1 shadow-lg">
                    <select id="season-select" onchange="onSeasonChange(this.value)" class="bg-transparent text-white font-bold px-3 py-2 outline-none cursor-pointer hover:text-brand transition-colors text-sm uppercase tracking-wide"></select>
                    <div class="h-6 w-[1px] bg-white/10 mx-1"></div>
                    <select id="episode-select" onchange="onEpisodeChange(this.value)" class="bg-transparent text-white font-bold px-3 py-2 outline-none cursor-pointer hover:text-brand transition-colors text-sm uppercase tracking-wide"></select>
                </div>
                <button onclick="nextEpisode()" class="flex items-center gap-2 px-5 py-2.5 bg-brand hover:bg-brand-dark rounded-xl text-white font-bold transition-all shadow-[0_0_15px_rgba(59,130,246,0.4)] hover:shadow-[0_0_25px_rgba(59,130,246,0.6)]">Siguiente <i class="fas fa-step-forward text-xs"></i></button>
            </div>

            <p id="movie-overview" class="text-gray-300 text-lg md:text-xl leading-relaxed line-clamp-3 md:line-clamp-4 max-w-2xl opacity-0 animate-fade-in-up delay-400 drop-shadow-md">Esperando datos...</p>

            <div class="opacity-0 animate-fade-in-up delay-500">
                <button onclick="startScraping()" class="group relative px-10 py-5 bg-brand hover:bg-white rounded-full font-bold text-white hover:text-brand transition-all duration-500 shadow-[0_0_30px_rgba(59,130,246,0.4)] hover:shadow-[0_0_60px_rgba(59,130,246,0.8)] hover:scale-105 flex items-center gap-4 overflow-hidden border border-brand">
                    <span class="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite]"></span>
                    <i class="fas fa-play text-xl group-hover:scale-125 transition-transform duration-300"></i> 
                    <span class="tracking-wider">REPRODUCIR</span>
                </button>
            </div>
        </div>
    </div>

    <div id="player-modal" class="fixed inset-0 z-50 bg-[#050505] hidden opacity-0 transition-all duration-700 scale-95 flex flex-row transform-gpu overflow-hidden">
        <div id="player-bg-blur" class="absolute inset-0 bg-cover bg-center opacity-30 blur-[100px] z-0 pointer-events-none scale-110"></div>

        <div id="video-wrapper" class="relative w-full md:w-3/4 h-full bg-black/90 z-10 flex items-center justify-center shadow-[20px_0_50px_rgba(0,0,0,0.5)] border-r border-white/5 transition-width duration-500 ease-in-out">
            <div class="absolute top-0 left-0 w-full p-4 flex justify-between z-20 pointer-events-none bg-gradient-to-b from-black/80 to-transparent transition-opacity duration-300 group-hover/video:opacity-100">
                <button onclick="closePlayer()" class="pointer-events-auto w-10 h-10 rounded-full bg-white/10 hover:bg-red-500/20 hover:text-red-500 border border-white/10 backdrop-blur-md flex items-center justify-center transition-all duration-300 hover:scale-110"><i class="fas fa-arrow-left text-white"></i></button>
                <div class="flex gap-2 pointer-events-auto">
                    <button onclick="toggleFullscreen()" class="w-10 h-10 rounded-full bg-white/10 hover:bg-brand/20 hover:text-brand border border-white/10 backdrop-blur-md flex items-center justify-center transition-all duration-300 hover:scale-110"><i class="fas fa-expand"></i></button>
                    <button onclick="toggleSidebar()" class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 border border-white/10 backdrop-blur-md flex items-center justify-center transition-all duration-300 hover:scale-110"><i class="fas fa-list-ul"></i></button>
                </div>
            </div>
            
            <video id="player" class="w-full h-full object-contain" playsinline controls crossorigin></video>
            
            <div id="iframe-container" class="relative w-full h-full hidden-force bg-black">
                <div id="click-shield" class="click-shield hidden" onclick="removeShield()"></div>
                <div id="iframe-target" class="w-full h-full"></div>
            </div>
        </div>

        <div id="server-panel" class="relative w-full md:w-1/4 h-full glass-panel border-l-0 flex flex-col z-10 backdrop-blur-3xl bg-black/60 shadow-2xl transition-transform-smooth duration-500 ease-in-out">
            <div class="p-6 border-b border-white/5 bg-gradient-to-b from-white/5 to-transparent flex flex-col gap-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2"><i class="fas fa-server text-brand animate-pulse"></i> Fuentes</h3>
                    <div class="text-[10px] bg-white/5 px-2 py-1 rounded text-gray-400"><span id="server-count">0</span> Disp.</div>
                </div>
                <div class="flex justify-center gap-3">
                    <button onclick="setLanguageFilter('latino')" class="lang-flag cursor-pointer" id="btn-latino"><img src="https://embed69.org/static/lang/LAT.png" alt="Latino" class="w-8 h-auto"></button>
                    <button onclick="setLanguageFilter('castellano')" class="lang-flag cursor-pointer" id="btn-castellano"><img src="https://embed69.org/static/lang/ESP.png" alt="Castellano" class="w-8 h-auto"></button>
                    <button onclick="setLanguageFilter('subtitulado')" class="lang-flag cursor-pointer" id="btn-subtitulado"><img src="https://embed69.org/static/lang/SUB.png" alt="Subtitulado" class="w-8 h-auto"></button>
                </div>
            </div>
            <div id="server-list-container" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                <div class="text-center text-gray-500 mt-10 animate-pulse">Esperando selecci√≥n...</div>
            </div>
        </div>
    </div>

    <div id="loader-overlay" class="fixed inset-0 z-[60] bg-black/95 backdrop-blur-xl hidden flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="relative w-24 h-24">
            <div class="absolute inset-0 border-4 border-white/10 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-t-brand rounded-full animate-spin shadow-[0_0_20px_rgba(59,130,246,0.6)]"></div>
            <div class="absolute inset-0 flex items-center justify-center"><i class="fas fa-rocket text-brand text-xl animate-pulse"></i></div>
        </div>
        <p id="loader-text" class="mt-8 text-white font-bold tracking-[0.3em] text-sm animate-pulse uppercase drop-shadow-lg text-center px-4">BUSCANDO ENLACES...</p>
    </div>

    <script>
        const API_KEY = 'da8b836389708e0558de674492931977'; 
        const PROXY_URL = 'https://api.codetabs.com/v1/proxy/?quest=';
        const TARGET_BLOG = 'https://darkstatonmovies1.blogspot.com';
        
        let movieData = { tmdbId: null, imdbId: null, title: '', backdrop: '', type: 'movie', season: 1, episode: 1, totalSeasons: 1, episodesInSeason: [] };
        let playerInstance = null;
        let sourcesList = [];
        let currentLanguage = 'all'; 
        let isSidebarOpen = true;

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const season = urlParams.get('season');
            const episode = urlParams.get('episode');

            window.addEventListener('scroll', () => {
                const nav = document.getElementById('navbar');
                if (window.scrollY > 50) nav.classList.add('glass-strong');
                else nav.classList.remove('glass-strong');
            });

            if (id) {
                if (season && episode) {
                    movieData.type = 'tv';
                    movieData.season = parseInt(season);
                    movieData.episode = parseInt(episode);
                    fetchTMDBTVData(id, movieData.season, movieData.episode);
                } else {
                    movieData.type = 'movie';
                    fetchTMDBData(id);
                }
            } else {
                updateStatus("‚ö†Ô∏è ID no encontrado.");
                document.getElementById('movie-title').innerHTML = "JJ<span class='text-brand'>MOVIES</span>";
                document.getElementById('movie-overview').textContent = "Usa ?id=123 (Cine) o ?id=123&season=1&episode=1 (Series).";
                const bgEl = document.getElementById('backdrop-img');
                bgEl.style.backgroundImage = "url('https://image.tmdb.org/t/p/original/t5zCBSB5xMDKcDqe91qahCOUYVV.jpg')";
                bgEl.classList.remove('opacity-0');
                document.querySelectorAll('.animate-fade-in-up').forEach(el => el.classList.remove('opacity-0'));
            }
        });

        // --- TMDB FETCH ---
        async function fetchTMDBData(id) {
            try {
                const response = await fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=${API_KEY}&language=es-MX&append_to_response=external_ids`);
                const data = await response.json();
                if (data.status_code === 34) { updateStatus("Pel√≠cula no encontrada."); return; }
                movieData.tmdbId = data.id;
                movieData.imdbId = data.external_ids ? data.external_ids.imdb_id : null;
                movieData.title = data.title;
                movieData.backdrop = data.backdrop_path ? `https://image.tmdb.org/t/p/original${data.backdrop_path}` : '';
                updateUI(data);
                document.getElementById('series-controls').classList.add('hidden-force');
            } catch (error) { console.error(error); updateStatus("Error de conexi√≥n."); }
        }

        async function fetchTMDBTVData(id, season, episode) {
            try {
                const showResp = await fetch(`https://api.themoviedb.org/3/tv/${id}?api_key=${API_KEY}&language=es-MX&append_to_response=external_ids`);
                const showData = await showResp.json();
                const seasonResp = await fetch(`https://api.themoviedb.org/3/tv/${id}/season/${season}?api_key=${API_KEY}&language=es-MX`);
                const seasonData = await seasonResp.json();

                movieData.tmdbId = showData.id;
                movieData.imdbId = showData.external_ids ? showData.external_ids.imdb_id : null;
                movieData.totalSeasons = showData.number_of_seasons;
                movieData.episodesInSeason = seasonData.episodes || [];
                
                const currentEpData = movieData.episodesInSeason.find(e => e.episode_number == episode) || {};
                movieData.title = showData.name;
                movieData.backdrop = currentEpData.still_path ? `https://image.tmdb.org/t/p/original${currentEpData.still_path}` : `https://image.tmdb.org/t/p/original${showData.backdrop_path}`;

                const displayData = {
                    title: showData.name,
                    overview: currentEpData.overview || showData.overview || "Sin descripci√≥n.",
                    vote_average: currentEpData.vote_average || showData.vote_average,
                    release_date: currentEpData.air_date || showData.first_air_date,
                    runtime: currentEpData.runtime || (showData.episode_run_time ? showData.episode_run_time[0] : 0),
                    genres: showData.genres
                };

                updateUI(displayData);
                const epTitleEl = document.getElementById('episode-title');
                epTitleEl.innerText = `S${season} E${episode}: "${currentEpData.name || 'Cap√≠tulo ' + episode}"`;
                epTitleEl.classList.remove('hidden-force');
                renderSeriesControls();
            } catch (error) { console.error(error); updateStatus("Error de conexi√≥n (Serie)."); }
        }

        function updateUI(data) {
            document.getElementById('movie-title').textContent = data.title;
            document.getElementById('movie-overview').textContent = data.overview;
            document.getElementById('movie-rating').innerHTML = `<i class="fas fa-star text-sm mr-2"></i> ${data.vote_average ? data.vote_average.toFixed(1) : 'N/A'}`;
            document.getElementById('movie-year').textContent = data.release_date?.split('-')[0] || 'N/A';
            document.getElementById('movie-runtime').innerHTML = `<i class="far fa-clock mr-2"></i> ${data.runtime} min`;
            if(data.genres?.length) {
                document.getElementById('movie-genres').innerHTML = data.genres.slice(0, 3).map(g => 
                    `<span class="bg-white/5 border border-white/10 px-3 py-1 rounded-full text-xs uppercase tracking-wider hover:bg-brand hover:border-brand transition-colors cursor-default">${g.name}</span>`
                ).join('');
            }
            if (movieData.backdrop) {
                const bgEl = document.getElementById('backdrop-img');
                bgEl.style.backgroundImage = `url('${movieData.backdrop}')`;
                bgEl.classList.remove('opacity-0');
                document.getElementById('player-bg-blur').style.backgroundImage = `url('${movieData.backdrop}')`;
            }
            document.querySelectorAll('.animate-fade-in-up').forEach(el => el.classList.remove('opacity-0'));
        }

        function renderSeriesControls() {
            const controls = document.getElementById('series-controls');
            controls.classList.remove('hidden-force');
            const seasonSelect = document.getElementById('season-select');
            seasonSelect.innerHTML = '';
            for (let i = 1; i <= movieData.totalSeasons; i++) {
                const opt = document.createElement('option');
                opt.value = i; opt.text = `Temporada ${i}`;
                if (i == movieData.season) opt.selected = true;
                seasonSelect.appendChild(opt);
            }
            const epSelect = document.getElementById('episode-select');
            epSelect.innerHTML = '';
            const count = movieData.episodesInSeason.length > 0 ? movieData.episodesInSeason.length : 24; 
            if (movieData.episodesInSeason.length > 0) {
                movieData.episodesInSeason.forEach(ep => {
                    const opt = document.createElement('option');
                    opt.value = ep.episode_number;
                    opt.text = `Ep. ${ep.episode_number} - ${ep.name ? ep.name.substring(0, 20) : ''}`;
                    if (ep.episode_number == movieData.episode) opt.selected = true;
                    epSelect.appendChild(opt);
                });
            } else {
                for (let i = 1; i <= count; i++) {
                    const opt = document.createElement('option');
                    opt.value = i; opt.text = `Episodio ${i}`;
                    if (i == movieData.episode) opt.selected = true;
                    epSelect.appendChild(opt);
                }
            }
        }

        function onSeasonChange(newSeason) { window.location.href = `?id=${movieData.tmdbId}&season=${newSeason}&episode=1`; }
        function onEpisodeChange(newEpisode) { window.location.href = `?id=${movieData.tmdbId}&season=${movieData.season}&episode=${newEpisode}`; }
        function nextEpisode() { onEpisodeChange(movieData.episode + 1); }

        // --- SCRAPING ---
        async function startScraping() {
            if (!movieData.tmdbId) return;
            openPlayerUI();
            setLoading(true, `BUSCANDO ENLACES...`);
            sourcesList = [];
            currentLanguage = 'all'; 
            document.querySelectorAll('.lang-flag').forEach(btn => btn.classList.remove('active'));
            updateServerList();

            const promises = [];
            
            // 1. New Servers (Direct)
            addDirectSources();

            // 2. Original Scrapers
            if (movieData.type === 'tv') {
                if (movieData.imdbId) promises.push(scrapeEmbed69Series(movieData.imdbId, movieData.season, movieData.episode));
            } else {
                promises.push(scrapeBlogFallback());
                if (movieData.imdbId) promises.push(scrapeEmbed69(movieData.imdbId));
                if (movieData.imdbId) promises.push(scrapeVerHDLink(movieData.imdbId));
            }
            
            await Promise.allSettled(promises);
            setLoading(false);

            if (sourcesList.length === 0) {
                alert("No se encontraron servidores disponibles.");
                closePlayer();
            } else {
                const first = sourcesList[0];
                if(first) {
                    playSource(first);
                    const l = first.lang.toLowerCase();
                    if(l.includes('lat')) setLanguageFilter('latino');
                    else if(l.includes('cas') || l.includes('esp')) setLanguageFilter('castellano');
                    else if(l.includes('sub')) setLanguageFilter('subtitulado');
                }
            }
        }

        function addDirectSources() {
            // VidSrc
            let vidsrc = movieData.type === 'movie' ? `https://vidsrc.cc/v2/embed/movie/${movieData.tmdbId}` : `https://vidsrc.cc/v2/embed/tv/${movieData.tmdbId}/${movieData.season}/${movieData.episode}`;
            addSource({ name: "VidSrc Cloud", lang: "Subtitulado", type: "iframe", url: vidsrc, icon: "fa-cloud", provider: "vidsrc", shield: true }); // shield: true activa la trampa de ads

            // UEmbed
            let uembed = `https://uembed.xyz/?id=${movieData.tmdbId}`;
            if (movieData.type === 'tv') uembed += `&season=${movieData.season}&episode=${movieData.episode}`;
            addSource({ name: "UEmbed Player", lang: "Subtitulado", type: "iframe", url: uembed, icon: "fa-play-circle", provider: "uembed", shield: true });

            // EmbedMaster
            let emaster = movieData.type === 'movie' ? `https://embedmaster.com/embed/movie/${movieData.tmdbId}` : `https://embedmaster.com/embed/tv/${movieData.tmdbId}/${movieData.season}/${movieData.episode}`;
            addSource({ name: "EmbedMaster", lang: "Subtitulado", type: "iframe", url: emaster, icon: "fa-server", provider: "embedmaster", shield: true });

            // 2Embed
            let twoembed = `https://www.2embed.cc/embed/${movieData.tmdbId}`;
            if (movieData.type === 'tv') twoembed += `&s=${movieData.season}&e=${movieData.episode}`;
            addSource({ name: "2Embed", lang: "Subtitulado", type: "iframe", url: twoembed, icon: "fa-hdd", provider: "2embed", shield: true });
        }

        async function scrapeEmbed69(imdbId) {
            try {
                const url = `https://embed69.org/f/${imdbId}/`;
                const res = await fetch(PROXY_URL + encodeURIComponent(url));
                const html = await res.text();
                const match = html.match(/let dataLink\s*=\s*(\[[\s\S]*?\]);/);
                if (match) processEmbed69Data(JSON.parse(match[1]), 'embed69');
            } catch (e) {}
        }

        async function scrapeEmbed69Series(imdbId, season, episode) {
            try {
                const slug = `${imdbId}-${season}x${String(episode).padStart(2, '0')}`;
                const res = await fetch(PROXY_URL + encodeURIComponent(`https://embed69.org/f/${slug}/`));
                const html = await res.text();
                const match = html.match(/let dataLink\s*=\s*(\[[\s\S]*?\]);/);
                if (match) processEmbed69Data(JSON.parse(match[1]), 'embed69-series');
            } catch (e) {}
        }

        function processEmbed69Data(dataLink, providerName) {
            dataLink.forEach(item => {
                let lang = 'Subtitulado';
                if (item.video_language.includes('LAT')) lang = 'Latino';
                else if (item.video_language.includes('ESP') || item.video_language.includes('CAS')) lang = 'Castellano';

                item.sortedEmbeds.forEach(embed => {
                    const decoded = decodeJWT(embed.link);
                    if (decoded && decoded.link) {
                        const host = mapHostName(embed.servername);
                        const videoId = extractIdFromLink(decoded.link);
                        // Convert to Unlimplay (CLEAN) if possible
                        if (host && videoId) {
                            addSource({
                                name: `${embed.servername} [Limpio]`,
                                lang: lang,
                                type: 'iframe',
                                url: `https://unlimplay.com/embed2/?host=${host}&id=${videoId}&poster=${encodeURIComponent(movieData.backdrop)}`,
                                icon: 'fa-film',
                                provider: providerName,
                                clean: true
                            });
                        } else {
                            addSource({ name: embed.servername, lang: lang, type: 'iframe', url: decoded.link, icon: 'fa-globe', provider: providerName, shield: true });
                        }
                    }
                });
            });
        }

        async function scrapeVerHDLink(imdbId) {
            try {
                const res = await fetch(PROXY_URL + encodeURIComponent(`https://verhdlink.cam/movie/${imdbId}`));
                const html = await res.text();
                const matches = html.matchAll(/dropload\.tv\/e\/([a-zA-Z0-9_-]+)/g);
                for(const m of matches) {
                    addSource({
                        name: "‚ö° THUNDERBOLT [Ultra]",
                        lang: "Latino",
                        type: "iframe",
                        url: `https://unlimplay.com/embed2/?host=dropload&id=${m[1]}`,
                        icon: "fa-bolt",
                        provider: "verhd",
                        clean: true
                    });
                }
            } catch (e) {}
        }

        async function scrapeBlogFallback() {
            try {
                if(!movieData.title) return;
                const keyword = movieData.title.split(':')[0].toLowerCase();
                const res = await fetch(PROXY_URL + encodeURIComponent(`${TARGET_BLOG}/search?q=${keyword}`));
                const text = await res.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const card = doc.querySelector('.cards-movie a'); 
                if(card) {
                    const mRes = await fetch(PROXY_URL + encodeURIComponent(card.href));
                    const mText = await mRes.text();
                    const mDoc = parser.parseFromString(mText, 'text/html');
                    const iframes = mDoc.querySelectorAll('iframe');
                    iframes.forEach((iframe, i) => {
                        if(iframe.src.includes('videoUrl=')) {
                            const url = atob(new URLSearchParams(iframe.src.split('?')[1]).get('videoUrl'));
                            addSource({ name: `üíé DIAMOND [VIP] ${i+1}`, lang: 'Latino', type: 'direct', url: url, icon: 'fa-gem', provider: 'blog', clean: true });
                        }
                    });
                }
            } catch(e) {}
        }

        function addSource(source) {
            if (!sourcesList.some(s => s.url === source.url)) {
                sourcesList.push(source);
                updateServerList();
            }
        }

        function updateServerList() {
            let displayList = sourcesList;
            if (currentLanguage !== 'all') {
                displayList = sourcesList.filter(s => {
                    const l = s.lang.toLowerCase();
                    if(currentLanguage === 'latino') return l.includes('lat');
                    if(currentLanguage === 'castellano') return l.includes('cas') || l.includes('esp');
                    if(currentLanguage === 'subtitulado') return l.includes('sub');
                    return true;
                });
            }
            
            // Sort: Blog > VerHD > Embed69 > New Servers
            displayList.sort((a,b) => {
                const p = (prov) => {
                    if(prov==='blog') return 0;
                    if(prov==='verhd') return 1;
                    if(prov.includes('embed69')) return 2;
                    return 3;
                }
                return p(a.provider) - p(b.provider);
            });

            document.getElementById('server-count').innerText = displayList.length;
            const container = document.getElementById('server-list-container');
            container.innerHTML = '';
            
            if (displayList.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 mt-10">No hay opciones</div>`;
                return;
            }

            displayList.forEach((src, idx) => {
                const div = document.createElement('div');
                let borderColor = 'border-white/5 bg-white/5';
                let iconColor = 'text-brand';
                let badge = '';

                if (src.provider === 'blog') { 
                    borderColor = 'border-yellow-500/20 bg-yellow-500/5';
                    iconColor = 'text-yellow-400';
                    badge = '<span class="text-[9px] text-yellow-500 font-extrabold tracking-widest flex items-center gap-1"><i class="fas fa-crown"></i> VIP</span>';
                } else if (src.clean) {
                    badge = '<span class="text-[9px] text-green-500 font-extrabold tracking-widest flex items-center gap-1"><i class="fas fa-shield-alt"></i> CLEAN</span>';
                }

                const animationDelay = idx * 50; 
                div.className = `group relative overflow-hidden flex items-center p-3 rounded-xl cursor-pointer transition-all duration-300 border hover:border-brand/50 hover:bg-white/10 opacity-0 animate-slide-in-right ${borderColor}`;
                div.style.animationDelay = `${animationDelay}ms`;
                
                div.innerHTML = `
                    <div class="absolute inset-0 bg-gradient-to-r from-brand/0 via-brand/10 to-brand/0 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                    <div class="w-10 h-10 rounded-full bg-black/40 flex items-center justify-center ${iconColor} font-bold mr-3 group-hover:bg-brand group-hover:text-white transition-all duration-300 shadow-lg group-hover:scale-110">
                        <i class="fas ${src.icon} text-sm"></i>
                    </div>
                    <div class="flex-1 z-10">
                        <h4 class="text-xs font-bold text-gray-100 group-hover:text-white transition-colors truncate max-w-[150px]">${src.name}</h4>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="text-[9px] bg-black/30 px-1.5 py-0.5 rounded text-gray-400 uppercase tracking-wider font-semibold group-hover:text-brand-light transition-colors">${src.lang}</span>
                            ${badge}
                        </div>
                    </div>
                `;
                div.onclick = () => {
                    playSource(src);
                    Array.from(container.children).forEach(c => c.classList.remove('border-brand', 'bg-white/10', 'shadow-[0_0_15px_rgba(59,130,246,0.2)]'));
                    div.classList.add('border-brand', 'bg-white/10', 'shadow-[0_0_15px_rgba(59,130,246,0.2)]');
                };
                container.appendChild(div);
            });
        }

        function playSource(source) {
            const video = document.getElementById('player');
            const iframeCont = document.getElementById('iframe-container');
            const iframeTarget = document.getElementById('iframe-target');
            const shield = document.getElementById('click-shield');

            if (playerInstance) playerInstance.stop();
            video.pause();
            video.removeAttribute('src'); 
            video.load(); 
            video.style.display = 'none';
            iframeCont.classList.add('hidden-force');
            iframeTarget.innerHTML = ''; 

            if (source.type === 'direct') {
                video.style.display = 'block';
                video.src = source.url;
                initPlyr();
                playerInstance.play();
            } else {
                iframeCont.classList.remove('hidden-force');
                
                // IRON DOME (ANTI-AD LOGIC)
                if (source.shield) {
                    shield.classList.remove('hidden'); // Activar trampa
                } else {
                    shield.classList.add('hidden'); // Servidor limpio, sin trampa
                }

                setTimeout(() => {
                    iframeTarget.innerHTML = `<iframe src="${source.url}" class="w-full h-full border-0 animate-fade-in-up" allow="autoplay; encrypted-media"></iframe>`;
                }, 50);
            }
        }

        function removeShield() {
            document.getElementById('click-shield').classList.add('hidden');
            console.log("JJMOVIES: Publicidad interceptada.");
        }

        function initPlyr() {
            if (playerInstance) playerInstance.destroy();
            playerInstance = new Plyr('#player', {
                controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'pip'],
                settings: ['quality', 'speed'],
                autoplay: true
            });
        }

        // --- UTILS (Decoding & Helpers) ---
        function base64UrlDecode(str) { str = str.replace(/-/g, '+').replace(/_/g, '/'); return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); }
        function decodeJWT(token) { try { const payload = token.split('.')[1]; return JSON.parse(base64UrlDecode(payload)); } catch { return null; } }
        function mapHostName(name) { name = name.toLowerCase(); if (name.includes('voe')) return 'voe'; if (name.includes('streamwish')) return 'streamwish'; if (name.includes('dood')) return 'doodstream'; if (name.includes('filemoon')) return 'filemoon'; if (name.includes('vidhide')) return 'vidhide'; return null; }
        function extractIdFromLink(link) { const patterns = [/\/e\/([a-zA-Z0-9]+)/, /filemoon\.sx\/d\/([a-zA-Z0-9]+)/, /voe\.sx\/([a-zA-Z0-9]+)/, /streamwish\.com\/([a-zA-Z0-9]+)/, /dood\.to\/e\/([a-zA-Z0-9]+)/, /vidhide\.\w+\/([a-zA-Z0-9]+)/]; for (let p of patterns) { const m = link.match(p); if (m && m[1]) return m[1]; } return null; }
        function normalizeStr(str) { return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase(); }
        function toRoman(num) { const lookup = {M:1000,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1}; let roman = '', i; for (i in lookup) { while (num >= lookup[i]) { roman += i; num -= lookup[i]; } } return roman; }
        function updateStatus(msg) { statusMsg.textContent = msg; setTimeout(() => statusMsg.textContent = '', 4000); }
        function setLoading(active, text) { const overlay = document.getElementById('loader-overlay'); if (active) { overlay.classList.remove('hidden'); requestAnimationFrame(() => overlay.classList.remove('opacity-0')); document.getElementById('loader-text').innerText = text; } else { overlay.classList.add('opacity-0'); setTimeout(() => overlay.classList.add('hidden'), 500); } }
        function openPlayerUI() { const modal = document.getElementById('player-modal'); modal.classList.remove('hidden'); requestAnimationFrame(() => { modal.classList.remove('opacity-0', 'scale-95'); modal.classList.add('opacity-100', 'scale-100'); }); document.body.style.overflow = 'hidden'; }
        function closePlayer() { const modal = document.getElementById('player-modal'); modal.classList.remove('opacity-100', 'scale-100'); modal.classList.add('opacity-0', 'scale-95'); setTimeout(() => { modal.classList.add('hidden'); if (playerInstance) playerInstance.stop(); document.getElementById('iframe-target').innerHTML = ''; }, 700); document.body.style.overflow = ''; }
        function toggleSidebar() { isSidebarOpen = !isSidebarOpen; if (isSidebarOpen) { videoWrapper.classList.remove('w-full'); videoWrapper.classList.add('md:w-3/4'); serverPanel.classList.remove('translate-x-full', 'hidden-force'); serverPanel.classList.add('w-full', 'md:w-1/4'); } else { videoWrapper.classList.remove('md:w-3/4'); videoWrapper.classList.add('w-full'); serverPanel.classList.add('hidden-force'); } }
        function toggleFullscreen() { const elem = document.getElementById('player-modal'); if (!document.fullscreenElement) { if (elem.requestFullscreen) elem.requestFullscreen(); } else { if (document.exitFullscreen) document.exitFullscreen(); } }
        function setLanguageFilter(lang) { currentLanguage = lang; document.querySelectorAll('.lang-flag').forEach(btn => btn.classList.remove('active')); if(lang !== 'all') document.getElementById(`btn-${lang}`).classList.add('active'); updateServerList(); }
    </script>
</body>
</html>
