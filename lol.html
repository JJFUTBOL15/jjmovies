<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <meta name="theme-color" content="#000000">
    <title>JJMOVIES V1.1 | INCINERATOR</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { DEFAULT: '#ff0000', dark: '#cc0000', glow: 'rgba(255, 0, 0, 0.6)' },
                        sys: { black: '#000000', panel: '#050505', border: '#111' },
                        term: { green: '#0f0', red: '#f00' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], tech: ['Chakra Petch', 'monospace'] },
                    animation: {
                        'pulse-fast': 'pulse 0.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'flash': 'flash 0.2s infinite',
                        'scanline': 'scanline 4s linear infinite',
                    },
                    keyframes: {
                        flash: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.8' } },
                        scanline: { '0%': { transform: 'translateY(-100%)' }, '100%': { transform: 'translateY(100%)' } }
                    },
                    boxShadow: { 'neon': '0 0 20px rgba(255, 0, 0, 0.6)' }
                }
            }
        }
    </script>

    <style>
        :root { --app-bg: #000; }
        body { background: var(--app-bg); color: #fff; overflow-x: hidden; font-family: 'Inter', sans-serif; }
        
        /* Grid agresiva */
        .bg-grid {
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; }
        ::-webkit-scrollbar-thumb:hover { background: #ff0000; }

        /* Items */
        .server-item {
            background: #0a0a0a; border: 1px solid #111; transition: all 0.1s;
        }
        .server-item:hover { background: #111; border-color: #333; }
        .server-item.active {
            background: #111;
            border-color: #ff0000;
            box-shadow: inset 0 0 10px rgba(255,0,0,0.2);
        }
        
        /* Cast & Grid */
        .cast-scroll { display: flex; overflow-x: auto; gap: 1rem; padding-bottom: 1rem; }
        .cast-card { flex: 0 0 80px; cursor: pointer; transition: transform 0.2s; }
        .cast-card:hover { transform: translateY(-3px); }
        .cast-img { width: 80px; height: 80px; object-fit: cover; border-radius: 50%; border: 2px solid #222; }
        .cast-card:hover .cast-img { border-color: #ff0000; }
        
        /* Clic Trap (Trampa de Anuncios) */
        .click-trap {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50; cursor: pointer; background: transparent;
        }

        .scanline-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px; pointer-events: none; z-index: 9999; opacity: 0.3;
        }
        .hidden-force { display: none !important; }
    </style>
</head>
<body>

    <div class="scanline-overlay"></div>

    <nav class="fixed top-0 w-full z-50 h-16 border-b border-white/10 bg-black/95 backdrop-blur-md flex justify-between items-center px-6">
        <div class="flex flex-col cursor-pointer" onclick="window.location.reload()">
            <div class="flex items-center gap-2">
                <i class="fas fa-radiation text-brand text-2xl animate-pulse"></i>
                <span class="text-2xl font-black tracking-tighter text-white italic">JJ<span class="text-brand text-neon">MOVIES</span></span>
            </div>
            <div class="flex items-center gap-2 text-[9px] font-tech text-gray-500 uppercase tracking-widest pl-8 -mt-1">
                <span class="text-white">V 1.1</span> <span class="text-brand font-bold">MAX POWER</span>
            </div>
        </div>
        <div class="hidden md:flex items-center gap-2 bg-black border border-brand/50 px-3 py-1 rounded shadow-neon">
            <div class="w-2 h-2 rounded-full bg-red-600 animate-pulse-fast"></div>
            <span class="text-[10px] font-bold font-tech text-red-500 tracking-[0.2em]">BURNING SERVERS</span>
        </div>
    </nav>

    <main class="relative z-10 w-full min-h-screen flex flex-col justify-center bg-grid pt-20 pb-20">
        <div class="absolute inset-0 z-[-1] overflow-hidden fixed">
            <div id="bg-backdrop" class="absolute inset-0 bg-cover bg-center transition-all duration-1000 opacity-0 scale-110 grayscale"></div>
            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/90 to-transparent"></div>
        </div>

        <div id="hero-panel" class="container mx-auto px-6 max-w-6xl opacity-0 translate-y-10 transition-all duration-700">
            
            <div class="flex items-center gap-2 mb-4">
                <span class="px-2 py-0.5 bg-brand text-black text-[10px] font-black font-tech uppercase rounded">ULTRA HD</span>
                <span class="px-2 py-0.5 border border-white/20 text-gray-300 text-[10px] font-bold uppercase rounded">NO ADS</span>
            </div>

            <h1 id="movie-title" class="text-5xl md:text-8xl font-black text-white leading-none uppercase tracking-tighter mb-4 text-shadow-neon">ESPERANDO DATOS...</h1>

            <div class="flex items-center gap-4 text-xs font-bold text-gray-400 mb-6 font-tech uppercase tracking-widest">
                <span id="meta-year" class="text-white">----</span>
                <span class="text-brand">///</span>
                <span id="meta-rating" class="text-white">--</span>
                <span class="text-brand">///</span>
                <span id="meta-duration">-- MIN</span>
            </div>

            <div id="series-controls" class="hidden flex flex-wrap gap-4 mb-8">
                <select id="season-select" class="bg-black border border-white/20 text-white font-bold px-4 py-3 outline-none focus:border-brand appearance-none font-tech text-sm uppercase min-w-[150px]"></select>
                <select id="episode-select" class="bg-black border border-white/20 text-white font-bold px-4 py-3 outline-none focus:border-brand appearance-none font-tech text-sm uppercase min-w-[150px]"></select>
            </div>

            <p id="movie-desc" class="text-gray-400 text-lg max-w-2xl leading-relaxed mb-8 border-l-4 border-brand pl-4 font-light">
                Agrega ?id=... a la URL para iniciar el protocolo de búsqueda masiva.
            </p>

            <button onclick="Core.start()" class="group relative px-12 py-5 bg-brand hover:bg-white text-white hover:text-black font-black text-xl uppercase tracking-widest transition-all duration-200 shadow-neon skew-x-[-10deg] mb-12">
                <div class="skew-x-[10deg] flex items-center gap-3">
                    <i class="fas fa-play"></i> <span>INICIAR</span>
                </div>
            </button>

            <div id="cast-container" class="border-t border-white/10 pt-8 opacity-0">
                <h3 class="text-xs font-bold font-tech uppercase tracking-widest text-gray-500 mb-4">Reparto</h3>
                <div id="cast-list" class="cast-scroll custom-scroll"></div>
            </div>
        </div>
    </main>

    <div id="actor-modal" class="fixed inset-0 z-[150] bg-black/95 backdrop-blur-md hidden opacity-0 transition-all duration-500 overflow-y-auto">
        <div class="container mx-auto px-6 py-12 max-w-5xl">
            <div class="flex justify-between items-start mb-8 sticky top-0 bg-black/90 p-4 border-b border-white/10 z-10">
                <div class="flex items-center gap-4">
                    <img id="actor-profile-img" src="" class="w-16 h-16 rounded-full object-cover border border-brand">
                    <div>
                        <h2 id="actor-name" class="text-2xl font-black text-white uppercase">Actor</h2>
                        <p class="text-[10px] text-gray-500 font-tech uppercase tracking-widest">Filmografía</p>
                    </div>
                </div>
                <button onclick="Core.closeActorModal()" class="text-white hover:text-brand transition-colors"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="actor-movies-grid" class="film-grid pb-20 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        </div>
    </div>

    <div id="player-overlay" class="fixed inset-0 z-[100] bg-black hidden flex flex-col md:flex-row opacity-0 transition-opacity duration-500">
        <div id="video-area" class="relative w-full md:w-[75%] h-[40vh] md:h-full bg-black flex items-center justify-center border-r border-white/10">
            
            <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-center z-20 bg-gradient-to-b from-black to-transparent pointer-events-none">
                <button onclick="Core.close()" class="pointer-events-auto w-8 h-8 flex items-center justify-center bg-black border border-white/20 hover:border-brand text-white transition-all"><i class="fas fa-times"></i></button>
                <div class="pointer-events-auto flex gap-2">
                    <button onclick="Core.toggleSidebar()" class="px-3 py-1 bg-brand text-black text-[10px] font-bold uppercase tracking-widest transition-all hover:bg-white"><i class="fas fa-expand"></i> <span id="toggle-text">Expandir</span></button>
                    <div class="px-3 py-1 bg-black border border-white/20 text-white text-[10px] font-bold uppercase tracking-widest flex items-center gap-2"><span id="playing-server-name">---</span></div>
                </div>
            </div>
            
            <div class="relative w-full h-full bg-black">
                <div id="click-trap" class="click-trap hidden" onclick="Core.handleTrap()"></div>
                
                <iframe id="video-frame" class="w-full h-full border-0 absolute inset-0 z-10" allowfullscreen allow="autoplay; encrypted-media; picture-in-picture"></iframe>
            </div>

            <div id="internal-loader" class="absolute inset-0 bg-black z-20 flex flex-col items-center justify-center hidden">
                <div class="w-12 h-12 border-4 border-brand border-t-transparent rounded-full animate-spin mb-4"></div>
                <div class="text-[10px] font-tech text-brand uppercase tracking-[0.3em] animate-pulse">Desencriptando...</div>
            </div>
        </div>

        <div id="sidebar-area" class="w-full md:w-[25%] h-[60vh] md:h-full bg-[#050505] flex flex-col transition-all duration-500 border-l border-white/5">
            <div class="p-4 border-b border-white/5 bg-[#080808] flex justify-between items-center">
                <div class="flex items-center gap-2"><i class="fas fa-server text-brand"></i><span class="text-xs font-bold font-tech uppercase tracking-widest text-white">Cambiar de Servidor</span></div>
                <span id="total-sources" class="text-[10px] text-gray-500 font-mono">0 FOUND</span>
            </div>
            <div id="server-list" class="flex-1 overflow-y-auto p-2 space-y-1 bg-grid"></div>
            <div class="p-2 bg-black border-t border-white/5 text-[8px] text-center text-gray-600 font-mono uppercase">JJMovies V1.1 • Ultra Secure</div>
        </div>
    </div>

    <div id="global-loader" class="fixed inset-0 z-[200] bg-black hidden flex flex-col items-center justify-center font-mono">
        <i class="fas fa-circle-notch fa-spin text-6xl text-brand mb-6"></i>
        <h2 class="text-2xl font-bold text-white tracking-widest mb-4">BURNING SERVERS...</h2>
        <div class="w-80 h-32 bg-[#050505] border border-brand/50 p-4 text-[10px] text-green-500 overflow-hidden relative font-tech">
            <div class="absolute inset-0 bg-scanline opacity-10 pointer-events-none"></div>
            <div id="terminal-logs" class="flex flex-col gap-1"></div>
        </div>
    </div>

    <script>
        const CFG = {
            API: '936410eebae74f9895643e085cc4a740', 
            // PROXIES DE ATAQUE
            PROXIES: [
                'https://api.codetabs.com/v1/proxy/?quest=',
                'https://corsproxy.io/?',
                'https://api.allorigins.win/raw?url='
            ],
            BASE_TMDB: 'https://api.themoviedb.org/3'
        };

        const Core = {
            state: { id: null, type: 'movie', season: 1, episode: 1, sources: {}, sidebarOpen: true },

            init: async () => {
                const p = new URLSearchParams(location.search);
                const id = p.get('id');
                if(!id) {
                    Core.updateMeta({ title: "JJMOVIES V1.1", overview: "Esperando ID." });
                    document.getElementById('hero-panel').classList.remove('opacity-0', 'translate-y-10');
                    return;
                }
                Core.state.id = id;
                Core.state.season = parseInt(p.get('season') || 1);
                Core.state.episode = parseInt(p.get('episode') || 1);
                if(p.get('season')) Core.state.type = 'tv';
                await Core.fetchTMDB();
            },

            fetchTMDB: async () => {
                try {
                    const { id, type, season, episode } = Core.state;
                    const url = `${CFG.BASE_TMDB}/${type}/${id}?api_key=${CFG.API}&language=es-MX&append_to_response=external_ids,credits`;
                    const res = await fetch(url);
                    const data = await res.json();

                    Core.state.imdb = data.external_ids?.imdb_id;
                    Core.state.totalSeasons = data.number_of_seasons || 0;
                    
                    let meta = { ...data };
                    if(type === 'tv') {
                        const sRes = await fetch(`${CFG.BASE_TMDB}/tv/${id}/season/${season}?api_key=${CFG.API}&language=es-MX`);
                        const sData = await sRes.json();
                        const ep = sData.episodes?.find(e => e.episode_number == episode) || {};
                        meta.backdrop_path = ep.still_path || data.backdrop_path;
                        meta.overview = ep.overview || data.overview;
                        meta.epName = ep.name;
                        Core.renderSelectors();
                    }
                    Core.updateMeta(meta);
                    if(data.credits && data.credits.cast) Core.renderCast(data.credits.cast);

                } catch(e) { console.error(e); }
            },

            updateMeta: (data) => {
                document.getElementById('movie-title').innerText = data.title || data.name;
                document.getElementById('movie-desc').innerText = data.overview || "Sin descripción.";
                document.getElementById('meta-year').innerText = (data.release_date || data.first_air_date || '----').split('-')[0];
                document.getElementById('meta-rating').innerText = data.vote_average?.toFixed(1) || '0.0';
                if(data.backdrop_path) {
                    document.getElementById('bg-backdrop').style.backgroundImage = `url('https://image.tmdb.org/t/p/original${data.backdrop_path}')`;
                    document.getElementById('bg-backdrop').classList.remove('opacity-0');
                }
                if(Core.state.type === 'tv') {
                    document.getElementById('series-controls').classList.remove('hidden');
                    document.getElementById('ep-name-display').innerText = `${data.epName || 'Ep ' + Core.state.episode}`;
                }
                document.getElementById('hero-panel').classList.remove('opacity-0', 'translate-y-10');
            },

            renderSelectors: () => {
                const s = document.getElementById('season-select');
                const e = document.getElementById('episode-select');
                s.innerHTML = ''; e.innerHTML = '';
                for(let i=1; i<=Core.state.totalSeasons; i++) s.innerHTML += `<option class="bg-black" value="${i}" ${i==Core.state.season?'selected':''}>TEMPORADA ${i}</option>`;
                for(let i=1; i<=50; i++) e.innerHTML += `<option class="bg-black" value="${i}" ${i==Core.state.episode?'selected':''}>EPISODIO ${i}</option>`;
                const go = () => window.location.href = `?id=${Core.state.id}&season=${s.value}&episode=${e.value}`;
                s.onchange = () => { e.value = 1; go(); };
                e.onchange = go;
            },

            renderCast: (cast) => {
                const container = document.getElementById('cast-list');
                const wrapper = document.getElementById('cast-container');
                container.innerHTML = '';
                if(!cast || cast.length === 0) return;
                wrapper.classList.remove('opacity-0');
                cast.slice(0, 15).forEach(actor => {
                    if(!actor.profile_path) return;
                    const div = document.createElement('div');
                    div.className = 'cast-card text-center';
                    div.onclick = () => Core.openActorProfile(actor.id, actor.name, actor.profile_path);
                    div.innerHTML = `<img src="https://image.tmdb.org/t/p/w200${actor.profile_path}" class="cast-img mb-2"><p class="text-[9px] font-bold text-gray-300 leading-tight">${actor.name}</p>`;
                    container.appendChild(div);
                });
            },

            openActorProfile: async (personId, name, imgPath) => {
                const modal = document.getElementById('actor-modal');
                const grid = document.getElementById('actor-movies-grid');
                document.getElementById('actor-name').innerText = name;
                document.getElementById('actor-profile-img').src = `https://image.tmdb.org/t/p/w200${imgPath}`;
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">Cargando...</div>';
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
                document.body.style.overflow = 'hidden';
                try {
                    const res = await fetch(`${CFG.BASE_TMDB}/person/${personId}/combined_credits?api_key=${CFG.API}&language=es-MX`);
                    const data = await res.json();
                    const cast = (data.cast || []).filter(c => c.poster_path && c.vote_count > 10).sort((a,b) => b.popularity - a.popularity);
                    grid.innerHTML = '';
                    cast.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'film-card group cursor-pointer';
                        card.onclick = () => window.location.href = `?id=${item.id}${item.media_type==='tv'?'&season=1&episode=1':''}`;
                        card.innerHTML = `<img src="https://image.tmdb.org/t/p/w300${item.poster_path}" class="w-full h-full object-cover transition-transform group-hover:scale-110"><div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-end p-2"><span class="text-[10px] font-bold text-white leading-tight">${item.title || item.name}</span></div>`;
                        grid.appendChild(card);
                    });
                } catch(e) { grid.innerHTML = 'Error.'; }
            },

            closeActorModal: () => {
                const modal = document.getElementById('actor-modal');
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 500);
                document.body.style.overflow = '';
            },

            start: async () => {
                const l = document.getElementById('global-loader');
                const log = document.getElementById('terminal-logs');
                l.classList.remove('hidden');
                const addLog = (txt) => { log.innerHTML += `<span>> ${txt}</span>`; log.scrollTop = log.scrollHeight; };

                Core.state.sources = { 'LAT': [], 'ESP': [], 'ENG': [] };

                // FUERZA BRUTA (PARALELO)
                addLog("Iniciando ataque a servidores...");
                
                const promises = [];
                if(Core.state.imdb) {
                    // VerHD (Fuente del Thunderbolt/Latino)
                    promises.push(Scraper.verHD().then(() => addLog("VerHD escaneado.")));
                    // Embed69 (Fuente masiva)
                    promises.push(Scraper.embed69().then(() => addLog("Embed69 escaneado.")));
                }
                
                // VidSrc siempre va (Backup)
                Core.addSource('ENG', { name: "VidSrc", url: Scraper.getVidSrc(), clean: false, trap: true });
                Core.addSource('ENG', { name: "UEmbed", url: Scraper.getUEmbed(), clean: false, trap: true });

                await Promise.allSettled(promises);

                addLog("Proceso completado.");
                setTimeout(() => {
                    l.classList.add('hidden');
                    Core.openPlayer();
                    Core.renderList();
                    
                    if(Core.state.sources['LAT'].length > 0) Core.play(0, 'LAT');
                    else if(Core.state.sources['ESP'].length > 0) Core.play(0, 'ESP');
                    else Core.play(0, 'ENG');
                }, 500);
            },

            addSource: (lang, src) => {
                if(!Core.state.sources[lang].some(s => s.url === src.url)) Core.state.sources[lang].push(src);
            },

            renderList: () => {
                const c = document.getElementById('server-list');
                c.innerHTML = '';
                let total = 0;
                const sections = [
                    { id: 'LAT', label: 'LATINO', flag: 'https://flagcdn.com/w40/mx.png' },
                    { id: 'ESP', label: 'CASTELLANO', flag: 'https://flagcdn.com/w40/es.png' },
                    { id: 'ENG', label: 'ENGLISH / SUB', flag: 'https://flagcdn.com/w40/us.png' }
                ];
                sections.forEach(sec => {
                    const list = Core.state.sources[sec.id];
                    if(list.length > 0) {
                        total += list.length;
                        const header = document.createElement('div');
                        header.className = 'sticky top-0 bg-[#050505]/95 backdrop-blur z-10 p-3 border-y border-white/5 flex items-center gap-3';
                        header.innerHTML = `<img src="${sec.flag}" class="w-5 h-3 opacity-80 rounded"><span class="text-[10px] font-bold font-tech text-gray-300 tracking-widest">${sec.label}</span>`;
                        c.appendChild(header);
                        list.forEach((src, idx) => {
                            const item = document.createElement('div');
                            item.className = 'server-item p-3 border-b border-white/5 cursor-pointer group flex justify-between items-center';
                            item.onclick = () => Core.play(idx, sec.id);
                            item.dataset.gid = `${sec.id}-${idx}`;
                            const icon = src.clean ? '<i class="fas fa-shield-alt text-green-500 text-xs"></i>' : '<i class="fas fa-radiation text-red-600 text-[10px]"></i>';
                            item.innerHTML = `<div class="flex items-center gap-3"><div class="text-[9px] font-mono text-gray-600">${idx+1}</div><span class="text-xs font-bold text-gray-300 group-hover:text-white transition-colors">${src.name}</span></div>${icon}`;
                            c.appendChild(item);
                        });
                    }
                });
                document.getElementById('total-sources').innerText = `${total} NODES`;
            },

            play: (idx, lang) => {
                const src = Core.state.sources[lang][idx];
                const frame = document.getElementById('video-frame');
                const loader = document.getElementById('internal-loader');
                const trap = document.getElementById('click-trap');
                
                document.querySelectorAll('.server-item').forEach(el => el.classList.remove('active'));
                const activeEl = document.querySelector(`.server-item[data-gid="${lang}-${idx}"]`);
                if(activeEl) activeEl.classList.add('active');
                
                document.getElementById('playing-server-name').innerText = `${lang} • ${src.name}`;
                
                frame.classList.add('hidden');
                loader.classList.remove('hidden');
                
                // ACTIVAR TRAMPA SI ES SUCIO
                if(src.trap || !src.clean) {
                    trap.classList.remove('hidden');
                } else {
                    trap.classList.add('hidden');
                }

                // NO SANDBOX (Para evitar que no cargue)
                frame.removeAttribute('sandbox'); 
                
                setTimeout(() => {
                    frame.src = src.url;
                    frame.onload = () => { loader.classList.add('hidden'); frame.classList.remove('hidden'); };
                    setTimeout(() => { loader.classList.add('hidden'); frame.classList.remove('hidden'); }, 2000);
                }, 200);
            },

            handleTrap: () => {
                const trap = document.getElementById('click-trap');
                console.log("JJMOVIES: Ad click neutralized.");
                trap.classList.add('hidden'); // Dejar pasar clicks reales despues del primero
            },

            openPlayer: () => {
                const ui = document.getElementById('player-overlay');
                ui.classList.remove('hidden');
                setTimeout(() => ui.classList.remove('opacity-0'), 50);
            },

            close: () => {
                const ui = document.getElementById('player-overlay');
                ui.classList.add('opacity-0');
                setTimeout(() => { ui.classList.add('hidden'); document.getElementById('video-frame').src = 'about:blank'; }, 500);
            },

            toggleSidebar: () => {
                const v = document.getElementById('video-area');
                const s = document.getElementById('sidebar-area');
                const txt = document.getElementById('toggle-text');
                Core.state.sidebarOpen = !Core.state.sidebarOpen;
                if(Core.state.sidebarOpen) {
                    v.classList.remove('full-width'); v.classList.add('w-[75%]');
                    s.classList.remove('no-sidebar'); s.classList.add('w-[25%]');
                    txt.innerText = "Expandir";
                } else {
                    v.classList.remove('w-[75%]'); v.classList.add('full-width');
                    s.classList.remove('w-[25%]'); s.classList.add('no-sidebar');
                    txt.innerText = "Cambiar de Servidor";
                }
            }
        };

        const Scraper = {
            // MULTI-PROXY FETCH
            fetchSafe: async (url) => {
                for (let proxy of CFG.PROXIES) {
                    try {
                        const res = await fetch(proxy + encodeURIComponent(url));
                        if(res.ok) return await res.text();
                    } catch(e) {}
                }
                return null; 
            },
            
            base64UrlDecode: (str) => {
                str = str.replace(/-/g, '+').replace(/_/g, '/');
                return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
            },
            decodeJWT: (token) => {
                try { return JSON.parse(Scraper.base64UrlDecode(token.split('.')[1])); } catch { return null; }
            },
            getVidSrc: () => { const { id, type, season, episode } = Core.state; return type==='movie' ? `https://vidsrc.cc/v2/embed/movie/${id}` : `https://vidsrc.cc/v2/embed/tv/${id}/${season}/${episode}`; },
            getUEmbed: () => { const { id, type, season, episode } = Core.state; let u = `https://uembed.xyz/?id=${id}`; if(type==='tv') u+= `&season=${season}&episode=${episode}`; return u; },

            embed69: async () => {
                try {
                    const { imdb, type, season, episode } = Core.state;
                    const slug = type==='tv' ? `${imdb}-${season}x${String(episode).padStart(2,'0')}` : imdb;
                    
                    const html = await Scraper.fetchSafe(`https://embed69.org/f/${slug}/`);
                    if(!html) return;

                    const match = html.match(/let dataLink\s*=\s*(\[[\s\S]*?\]);/);
                    if(match) {
                        const data = JSON.parse(match[1]);
                        data.forEach(item => {
                            let lang = 'ENG';
                            const l = item.video_language || "";
                            if(l.includes('LAT')) lang = 'LAT';
                            else if(l.includes('ESP') || l.includes('CAS')) lang = 'ESP';
                            else if(l.includes('SUB')) lang = 'ENG';

                            item.sortedEmbeds.forEach(embed => {
                                const decoded = Scraper.decodeJWT(embed.link);
                                if(decoded && decoded.link) {
                                    const host = embed.servername.toLowerCase();
                                    let url = decoded.link;
                                    let clean = false;
                                    let name = embed.servername;

                                    if(['voe','streamwish','dood','vidhide','filemoon'].some(h => host.includes(h))) {
                                        const idMatch = url.match(/\/([a-zA-Z0-9]+)$/) || url.match(/\/e\/([a-zA-Z0-9]+)/);
                                        if(idMatch) {
                                            let hCode = 'voe';
                                            if(host.includes('wish')) hCode = 'streamwish';
                                            if(host.includes('dood')) hCode = 'doodstream';
                                            if(host.includes('hide')) hCode = 'vidhide';
                                            Core.addSource(lang, { name: `${name} (Limpio)`, url: `https://unlimplay.com/embed2/?host=${hCode}&id=${idMatch[1]}`, clean: true });
                                            clean = true;
                                        }
                                    }
                                    if(!clean) Core.addSource(lang, { name: name, url: url, clean: false, trap: true });
                                }
                            });
                        });
                    }
                } catch(e) {}
            },

            verHD: async () => {
                try {
                    // ATACAMOS DIRECTO A VERHD PARA EXTRAER LOS LATINOS
                    const html = await Scraper.fetchSafe(`https://verhdlink.cam/movie/${Core.state.imdb}`);
                    if(!html) return;
                    
                    // BUSCAMOS PATRONES DROPLOAD (THUNDERBOLT)
                    const matches = html.matchAll(/dropload\.tv\/e\/([a-zA-Z0-9_-]+)/g);
                    for(const m of matches) {
                        Core.addSource('LAT', { name: "Thunderbolt (Ultra)", url: `https://unlimplay.com/embed2/?host=dropload&id=${m[1]}`, clean: true });
                    }
                    
                    // BUSCAMOS PATRONES VIP
                    const vip = html.matchAll(/streamwish\.to\/e\/([a-zA-Z0-9]+)/g);
                    for(const v of vip) {
                        Core.addSource('LAT', { name: "VIP Server", url: `https://unlimplay.com/embed2/?host=streamwish&id=${v[1]}`, clean: true });
                    }
                } catch(e) {}
            }
        };

        window.onload = Core.init;
    </script>
</body>
</html>
