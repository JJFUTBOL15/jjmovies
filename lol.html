<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <meta name="theme-color" content="#000000">
    <title>JJMOVIES V 2.0.1 | Titan Player</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;600;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { DEFAULT: '#E50914', dark: '#b20710', glow: 'rgba(229, 9, 20, 0.5)' },
                        sys: { black: '#000000', dark: '#050505', panel: '#0a0a0a', border: '#1f1f1f' },
                        lang: { lat: '#fbbf24', esp: '#ef4444', eng: '#3b82f6' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        tech: ['Chakra Petch', 'monospace'],
                    },
                    animation: {
                        'scan': 'scan 2s linear infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'flash': 'flash 3s infinite',
                    },
                    keyframes: {
                        scan: { '0%': { transform: 'translateY(-100%)' }, '100%': { transform: 'translateY(100%)' } },
                        flash: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.3' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* BASE & RESET */
        :root { --app-bg: #000000; }
        body { background-color: var(--app-bg); color: #fff; overflow-x: hidden; font-family: 'Inter', sans-serif; }

        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #E50914; }

        /* EFECTOS DE SECCIÓN */
        .lang-section-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #1f1f1f;
        }

        /* SERVER ITEM */
        .server-item {
            transition: all 0.2s;
            border-left: 2px solid transparent;
            background: #080808;
        }
        .server-item:hover { background: #111; }
        .server-item.active {
            background: #151515;
            border-left-color: #E50914;
        }
        .server-item.active .play-icon { color: #E50914; transform: scale(1.1); }

        /* FLAGS (Simple CSS representations or FontAwesome colors) */
        .flag-icon { width: 16px; height: 12px; display: inline-block; border-radius: 2px; margin-right: 6px; position: relative; top: 1px; }
        .flag-mx { background: linear-gradient(90deg, #006847 33%, #fff 33%, #fff 66%, #CE1126 66%); }
        .flag-es { background: linear-gradient(#AA151B 25%, #F1BF00 25%, #F1BF00 75%, #AA151B 75%); }
        .flag-us { background: repeating-linear-gradient(180deg, #B22234, #B22234 2px, #fff 2px, #fff 4px); position: relative; }
        .flag-us::before { content:''; position: absolute; top:0; left:0; width: 50%; height: 50%; background: #3C3B6E; }

        /* UTILITIES */
        .hidden-force { display: none !important; }
        .font-tech { font-family: 'Chakra Petch', sans-serif; }
        .text-shadow-glow { text-shadow: 0 0 10px rgba(229, 9, 20, 0.7); }
        
        /* AD-BLOCK SHIELD OVERLAY */
        .ad-shield {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5; /* Justo debajo de los controles del usuario pero encima del iframe */
            pointer-events: none; /* Dejamos pasar clicks legitimos, el sandbox hace el resto */
        }
    </style>
</head>
<body>

    <nav class="fixed top-0 w-full z-50 px-6 py-4 flex justify-between items-center bg-black/90 border-b border-white/5 backdrop-blur-md">
        <div class="flex flex-col cursor-pointer group" onclick="window.location.reload()">
            <div class="text-2xl font-black tracking-tighter text-white leading-none">
                JJ<span class="text-brand group-hover:text-white transition-colors">MOVIES</span>
            </div>
            <div class="flex items-center gap-2 mt-1">
                <span class="text-[9px] font-tech text-gray-500 uppercase tracking-[0.2em]">V 2.0.1</span>
                <span class="w-1 h-1 rounded-full bg-brand animate-pulse"></span>
                <span class="text-[9px] font-tech text-brand uppercase tracking-[0.2em] shadow-glow">Ultimate Player</span>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <div class="hidden md:flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse-fast"></div>
                <span class="text-[10px] font-bold font-tech text-green-500 tracking-widest">SERVER READY</span>
            </div>
        </div>
    </nav>

    <main class="relative z-10 container mx-auto px-6 h-screen flex items-center justify-start">
        
        <div class="fixed inset-0 z-[-1] bg-black">
            <div id="bg-backdrop" class="absolute inset-0 bg-cover bg-center opacity-0 transition-opacity duration-1000 scale-105"></div>
            <div class="absolute inset-0 bg-gradient-to-r from-black via-black/90 to-black/40"></div>
            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/80 to-transparent"></div>
        </div>

        <div id="hero-panel" class="max-w-4xl w-full flex flex-col items-start gap-6 opacity-0 translate-y-10 transition-all duration-700">
            
            <div class="flex items-center gap-2 font-tech text-xs tracking-widest">
                <span class="px-2 py-1 bg-white/10 border border-white/10 rounded text-gray-300">N/A</span>
                <span class="px-2 py-1 bg-brand/20 border border-brand/40 text-brand rounded shadow-[0_0_15px_rgba(229,9,20,0.2)]">4K HDR</span>
                <span id="meta-rating" class="px-2 py-1 text-yellow-500"><i class="fas fa-star mr-1"></i> --</span>
                <span id="meta-year" class="text-gray-500">----</span>
            </div>

            <h1 id="movie-title" class="text-5xl md:text-8xl font-black text-white leading-[0.85] tracking-tighter uppercase">
                Cargando...
            </h1>
            
            <div id="ep-info" class="hidden flex items-center gap-3 text-2xl font-light text-gray-300 border-l-4 border-brand pl-4">
                <span id="ep-string">S01 E01</span>
                <span class="w-1 h-1 bg-gray-500 rounded-full"></span>
                <span id="ep-name" class="italic text-gray-400">Title</span>
            </div>

            <div id="series-controls" class="hidden flex flex-wrap gap-4 mt-2">
                <div class="relative group">
                    <select id="season-select" class="appearance-none bg-[#111] border border-[#333] text-white font-bold px-6 py-3 rounded-none outline-none focus:border-brand cursor-pointer uppercase tracking-wider min-w-[150px]"></select>
                    <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-xs text-gray-500"></i>
                </div>
                <div class="relative group">
                    <select id="episode-select" class="appearance-none bg-[#111] border border-[#333] text-white font-bold px-6 py-3 rounded-none outline-none focus:border-brand cursor-pointer uppercase tracking-wider min-w-[150px]"></select>
                    <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-xs text-gray-500"></i>
                </div>
            </div>

            <p id="movie-overview" class="text-gray-400 text-lg max-w-2xl line-clamp-3 font-light leading-relaxed">
                Sistema en espera. Agrega el ID a la URL.
            </p>

            <button onclick="Core.start()" class="group relative px-12 py-5 bg-white text-black font-black uppercase tracking-[0.2em] hover:bg-brand hover:text-white transition-all duration-300 overflow-hidden mt-4">
                <div class="absolute inset-0 w-2 bg-brand transform -skew-x-12 -translate-x-full group-hover:translate-x-full transition-transform duration-500"></div>
                <span class="relative z-10 flex items-center gap-3">
                    <i class="fas fa-play"></i> Reproducir
                </span>
            </button>
        </div>
    </main>

    <div id="player-overlay" class="fixed inset-0 z-[100] bg-black hidden flex flex-col md:flex-row opacity-0 transition-opacity duration-500">
        
        <div class="relative w-full md:w-[75%] h-[40vh] md:h-full bg-black flex items-center justify-center border-r border-[#111]">
            
            <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-center z-20 bg-gradient-to-b from-black/80 to-transparent pointer-events-none">
                <button onclick="Core.close()" class="pointer-events-auto w-10 h-10 flex items-center justify-center bg-white/10 hover:bg-brand text-white rounded-full backdrop-blur-md transition-colors">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="pointer-events-auto flex items-center gap-3 bg-black/60 px-4 py-1.5 rounded-full border border-white/5 backdrop-blur-md">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-red-600 rounded-full animate-pulse"></div>
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Live Stream</span>
                    </div>
                    <span class="w-[1px] h-3 bg-white/10"></span>
                    <span id="active-server-name" class="text-[10px] font-bold text-white uppercase tracking-wider">---</span>
                </div>
            </div>

            <div class="relative w-full h-full">
                <iframe id="video-frame" class="w-full h-full border-0" 
                    allowfullscreen 
                    allow="autoplay; encrypted-media; picture-in-picture"
                    sandbox="allow-forms allow-pointer-lock allow-same-origin allow-scripts allow-top-navigation-by-user-activation">
                </iframe>
                <div id="sandbox-warning" class="hidden absolute bottom-20 left-1/2 -translate-x-1/2 bg-red-900/90 text-white px-4 py-2 rounded text-xs pointer-events-auto flex items-center gap-4">
                    <span><i class="fas fa-exclamation-triangle mr-2"></i>¿No reproduce?</span>
                    <button onclick="Core.disableSandbox()" class="bg-white text-red-900 px-3 py-1 font-bold rounded hover:bg-gray-200">Desactivar Escudo</button>
                </div>
            </div>

            <div id="internal-loader" class="absolute inset-0 bg-black z-10 flex flex-col items-center justify-center hidden">
                <div class="w-12 h-12 border-4 border-brand border-t-transparent rounded-full animate-spin mb-4"></div>
                <p class="text-[10px] font-tech text-brand uppercase tracking-widest animate-flash">Conectando Servidor Seguro...</p>
            </div>
        </div>

        <div class="w-full md:w-[25%] h-[60vh] md:h-full bg-[#050505] flex flex-col">
            <div class="p-5 border-b border-[#1f1f1f] bg-[#080808]">
                <h2 class="text-xs font-black text-white uppercase tracking-[0.2em] flex items-center gap-2">
                    <i class="fas fa-globe-americas text-brand"></i> Global Sources
                </h2>
                <div class="flex justify-between items-center mt-2 text-[10px] text-gray-500 font-mono">
                    <span>Status: <span class="text-green-500">SCANNING COMPLETE</span></span>
                    <span id="total-count">0 Sources</span>
                </div>
            </div>

            <div id="server-container" class="flex-1 overflow-y-auto custom-scroll relative">
                </div>

            <div class="p-3 bg-black border-t border-[#1f1f1f] text-[9px] text-center text-gray-600 font-mono uppercase tracking-widest">
                JJMovies Anti-Ad Protocol Active
            </div>
        </div>
    </div>

    <div id="global-loader" class="fixed inset-0 z-[200] bg-black hidden flex flex-col items-center justify-center">
        <div class="relative w-24 h-24 mb-8">
            <div class="absolute inset-0 border-t-2 border-brand rounded-full animate-spin"></div>
            <div class="absolute inset-4 border-t-2 border-white rounded-full animate-spin-slow"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i class="fas fa-shield-alt text-2xl text-brand/80"></i>
            </div>
        </div>
        <h3 class="text-2xl font-black text-white tracking-tighter mb-2">BUSCANDO SERVERS</h3>
        <div class="flex flex-col items-center gap-1 text-[10px] font-mono text-gray-500 uppercase tracking-widest">
            <span id="load-msg-1" class="text-brand animate-pulse">Connecting to JJMOVIES Database...</span>
            <span id="load-msg-2" class="opacity-0 transition-opacity duration-500">Scanning English Sources...</span>
            <span id="load-msg-3" class="opacity-0 transition-opacity duration-500 delay-100">Scanning Spanish Sources...</span>
        </div>
    </div>

    <script>
        const CFG = {
            API: '936410eebae74f9895643e085cc4a740', // API Key
            PROXY: 'https://api.codetabs.com/v1/proxy/?quest='
        };

        const Core = {
            state: { id: null, type: 'movie', season: 1, episode: 1, sources: {} },

            init: async () => {
                const p = new URLSearchParams(location.search);
                const id = p.get('id');

                if(!id) {
                    Core.updateMetadata({ title: "JJMOVIES V 2.0.1", overview: "Bienvenido al Sistema Ultimate Player. Por favor ingresa un ID." });
                    document.getElementById('hero-panel').classList.remove('opacity-0', 'translate-y-10');
                    return;
                }

                Core.state.id = id;
                Core.state.season = parseInt(p.get('season') || 1);
                Core.state.episode = parseInt(p.get('episode') || 1);
                if(p.get('season')) Core.state.type = 'tv';

                await Core.fetchTMDB();
            },

            fetchTMDB: async () => {
                try {
                    const { id, type, season, episode } = Core.state;
                    const url = `https://api.themoviedb.org/3/${type}/${id}?api_key=${CFG.API}&language=es-MX&append_to_response=external_ids`;
                    const res = await fetch(url);
                    const data = await res.json();

                    Core.state.imdb = data.external_ids?.imdb_id;
                    Core.state.seasonsTotal = data.number_of_seasons || 0;

                    let meta = { ...data };
                    if(type === 'tv') {
                        const sRes = await fetch(`https://api.themoviedb.org/3/tv/${id}/season/${season}?api_key=${CFG.API}&language=es-MX`);
                        const sData = await sRes.json();
                        const ep = sData.episodes?.find(e => e.episode_number == episode) || {};
                        meta.backdrop_path = ep.still_path || data.backdrop_path;
                        meta.overview = ep.overview || data.overview;
                        meta.epString = `S${String(season).padStart(2,'0')} E${String(episode).padStart(2,'0')}`;
                        meta.epName = ep.name;
                        Core.renderSelectors();
                    }
                    Core.updateMetadata(meta);

                } catch(e) { console.error(e); }
            },

            updateMetadata: (data) => {
                document.getElementById('movie-title').innerText = data.title || data.name;
                document.getElementById('movie-overview').innerText = data.overview || "Sin descripción.";
                document.getElementById('meta-rating').innerHTML = `<i class="fas fa-star mr-1"></i> ${data.vote_average?.toFixed(1) || '0.0'}`;
                document.getElementById('meta-year').innerText = (data.release_date || data.first_air_date || '----').split('-')[0];
                
                if(data.backdrop_path) {
                    document.getElementById('bg-backdrop').style.backgroundImage = `url('https://image.tmdb.org/t/p/original${data.backdrop_path}')`;
                    document.getElementById('bg-backdrop').classList.remove('opacity-0');
                }

                if(Core.state.type === 'tv') {
                    document.getElementById('ep-info').classList.remove('hidden');
                    document.getElementById('ep-string').innerText = data.epString;
                    document.getElementById('ep-name').innerText = data.epName;
                    document.getElementById('series-controls').classList.remove('hidden');
                }

                document.getElementById('hero-panel').classList.remove('opacity-0', 'translate-y-10');
            },

            renderSelectors: () => {
                const sSel = document.getElementById('season-select');
                const eSel = document.getElementById('episode-select');
                
                sSel.innerHTML = ''; eSel.innerHTML = '';

                for(let i=1; i<=Core.state.seasonsTotal; i++) {
                    sSel.innerHTML += `<option value="${i}" ${i==Core.state.season?'selected':''}>SEASON ${i}</option>`;
                }
                // Simulación 30 episodios (para no hacer otro fetch)
                for(let i=1; i<=30; i++) {
                    eSel.innerHTML += `<option value="${i}" ${i==Core.state.episode?'selected':''}>EPISODE ${i}</option>`;
                }

                sSel.onchange = (e) => window.location.href = `?id=${Core.state.id}&season=${e.target.value}&episode=1`;
                eSel.onchange = (e) => window.location.href = `?id=${Core.state.id}&season=${Core.state.season}&episode=${e.target.value}`;
            },

            // --- ENGINE START ---
            start: async () => {
                const loader = document.getElementById('global-loader');
                loader.classList.remove('hidden');
                
                // Animation simulation
                setTimeout(() => document.getElementById('load-msg-2').classList.remove('opacity-0'), 500);
                setTimeout(() => document.getElementById('load-msg-3').classList.remove('opacity-0'), 1200);

                // Reset Sources
                Core.state.sources = { 'LATINO': [], 'CASTELLANO': [], 'ENGLISH': [] };

                // 1. Scrape Latino/Castellano (Embed69 + Unlimplay Logic)
                if(Core.state.imdb) {
                    await Scraper.embed69();
                    if(Core.state.type === 'movie') await Scraper.verHD();
                }

                // 2. Backup English
                Core.addSource('ENGLISH', { name: "VidSrc Cloud", url: Scraper.getVidSrc(), quality: "HD", isClean: false });
                Core.addSource('ENGLISH', { name: "UEmbed API", url: Scraper.getUEmbed(), quality: "HD", isClean: false });
                
                // 3. Unlimplay Direct Logic (User request)
                // Checar si hay ID especifico (Placeholder logic)
                
                loader.classList.add('hidden');
                Core.openPlayer();
                Core.renderList();
                
                // AUTOPLAY: Play first available source (Priority: Latino > Castellano > English)
                if(Core.state.sources['LATINO'].length > 0) Core.playSource('LATINO', 0);
                else if(Core.state.sources['CASTELLANO'].length > 0) Core.playSource('CASTELLANO', 0);
                else if(Core.state.sources['ENGLISH'].length > 0) Core.playSource('ENGLISH', 0);
            },

            addSource: (lang, src) => {
                // De-duplicate
                if(!Core.state.sources[lang].some(s => s.url === src.url)) {
                    Core.state.sources[lang].push(src);
                }
            },

            renderList: () => {
                const c = document.getElementById('server-container');
                c.innerHTML = '';
                let total = 0;

                const groups = [
                    { id: 'LATINO', label: 'LATINO', flag: 'flag-mx', color: 'text-lang-lat' },
                    { id: 'CASTELLANO', label: 'CASTELLANO', flag: 'flag-es', color: 'text-lang-esp' },
                    { id: 'ENGLISH', label: 'ENGLISH / SUB', flag: 'flag-us', color: 'text-lang-eng' }
                ];

                groups.forEach(g => {
                    const list = Core.state.sources[g.id];
                    if(list.length > 0) {
                        total += list.length;
                        // Section Header
                        const header = document.createElement('div');
                        header.className = 'lang-section-header p-3 text-[10px] font-bold text-gray-400 flex items-center gap-2';
                        header.innerHTML = `<span class="flag-icon ${g.flag}"></span> ${g.label} (${list.length})`;
                        c.appendChild(header);

                        // Items
                        list.forEach((src, idx) => {
                            const item = document.createElement('div');
                            item.className = 'server-item p-4 border-b border-[#111] cursor-pointer group flex justify-between items-center';
                            item.innerHTML = `
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-play play-icon text-gray-600 text-xs transition-colors group-hover:text-white"></i>
                                    <div class="flex flex-col">
                                        <span class="text-sm font-bold text-gray-200 group-hover:text-white transition-colors">${src.name}</span>
                                        <span class="text-[9px] text-gray-600 font-mono uppercase">${src.quality || 'HD'} • ${src.isClean ? 'NO ADS' : 'ADS'}</span>
                                    </div>
                                </div>
                                ${src.isClean ? '<i class="fas fa-shield-alt text-green-500 text-xs" title="Limpio"></i>' : ''}
                            `;
                            item.onclick = () => Core.playSource(g.id, idx);
                            // Store ref for active state toggling
                            item.dataset.gid = g.id;
                            item.dataset.idx = idx;
                            c.appendChild(item);
                        });
                    }
                });

                document.getElementById('total-count').innerText = `${total} Sources`;
            },

            openPlayer: () => {
                const ui = document.getElementById('player-overlay');
                ui.classList.remove('hidden');
                setTimeout(() => ui.classList.remove('opacity-0'), 50);
            },

            close: () => {
                const ui = document.getElementById('player-overlay');
                ui.classList.add('opacity-0');
                setTimeout(() => {
                    ui.classList.add('hidden');
                    document.getElementById('video-frame').src = 'about:blank';
                    // Re-enable sandbox if it was disabled
                    document.getElementById('video-frame').setAttribute('sandbox', 'allow-forms allow-pointer-lock allow-same-origin allow-scripts allow-top-navigation-by-user-activation');
                    document.getElementById('sandbox-warning').classList.add('hidden');
                }, 500);
            },

            playSource: (groupId, idx) => {
                const src = Core.state.sources[groupId][idx];
                const iframe = document.getElementById('video-frame');
                const loader = document.getElementById('internal-loader');
                
                // Update Active UI
                document.querySelectorAll('.server-item').forEach(el => el.classList.remove('active'));
                const activeItem = document.querySelector(`.server-item[data-gid="${groupId}"][data-idx="${idx}"]`);
                if(activeItem) activeItem.classList.add('active');

                document.getElementById('active-server-name').innerText = `${groupId} • ${src.name}`;

                // Load Logic
                iframe.classList.add('hidden');
                loader.classList.remove('hidden');
                
                // SANDBOX LOGIC:
                // Si el server es "Limpio" (Unlimplay), es seguro. Si no, activamos el aviso de sandbox por si falla.
                if(!src.isClean) {
                     // Esperar unos segundos, si no carga, mostrar el boton de "Desactivar Escudo"
                     setTimeout(() => {
                         if(!iframe.classList.contains('hidden')) { // Si ya se mostró el iframe pero quizas esta bloqueado
                            document.getElementById('sandbox-warning').classList.remove('hidden');
                         }
                     }, 5000);
                } else {
                    document.getElementById('sandbox-warning').classList.add('hidden');
                }

                setTimeout(() => {
                    iframe.src = src.url;
                    iframe.onload = () => {
                        loader.classList.add('hidden');
                        iframe.classList.remove('hidden');
                    };
                }, 300);
            },

            disableSandbox: () => {
                const iframe = document.getElementById('video-frame');
                const url = iframe.src;
                iframe.removeAttribute('sandbox');
                iframe.src = url; // Reload
                document.getElementById('sandbox-warning').classList.add('hidden');
                alert("Escudo desactivado. Cuidado con las ventanas emergentes.");
            }
        };

        // ====================================================================================
        // SCRAPER MODULE
        // ====================================================================================
        const Scraper = {
            // Helpers
            base64UrlDecode: (str) => {
                str = str.replace(/-/g, '+').replace(/_/g, '/');
                return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
            },
            decodeJWT: (token) => {
                try { return JSON.parse(Scraper.base64UrlDecode(token.split('.')[1])); } catch { return null; }
            },

            // Generators
            getVidSrc: () => {
                const { id, type, season, episode } = Core.state;
                return type === 'movie' ? `https://vidsrc.cc/v2/embed/movie/${id}` : `https://vidsrc.cc/v2/embed/tv/${id}/${season}/${episode}`;
            },
            getUEmbed: () => {
                const { id, type, season, episode } = Core.state;
                let u = `https://uembed.xyz/?id=${id}`;
                if(type === 'tv') u += `&season=${season}&episode=${episode}`;
                return u;
            },

            // Main Scrapers
            embed69: async () => {
                try {
                    const { imdb, type, season, episode } = Core.state;
                    const slug = type === 'tv' ? `${imdb}-${season}x${String(episode).padStart(2,'0')}` : imdb;
                    const res = await fetch(CFG.PROXY + encodeURIComponent(`https://embed69.org/f/${slug}/`));
                    const html = await res.text();
                    const match = html.match(/let dataLink\s*=\s*(\[[\s\S]*?\]);/);
                    
                    if(match) {
                        const data = JSON.parse(match[1]);
                        data.forEach(item => {
                            let group = 'ENGLISH';
                            const l = item.video_language || "";
                            if(l.includes('LAT')) group = 'LATINO';
                            else if(l.includes('ESP') || l.includes('CAS')) group = 'CASTELLANO';
                            else if(l.includes('SUB')) group = 'ENGLISH'; // Subs usually go with English Audio

                            item.sortedEmbeds.forEach(embed => {
                                const decoded = Scraper.decodeJWT(embed.link);
                                if(decoded && decoded.link) {
                                    const host = embed.servername.toLowerCase();
                                    let url = decoded.link;
                                    let isClean = false;
                                    let name = embed.servername;

                                    // UNLIMPLAY CONVERSION (AD-BLOCK STRATEGY)
                                    // Detectamos voe, streamwish, etc y los convertimos a unlimplay
                                    if(['voe', 'streamwish', 'dood', 'vidhide', 'filemoon'].some(h => host.includes(h))) {
                                        const idMatch = url.match(/\/([a-zA-Z0-9]+)$/) || url.match(/\/e\/([a-zA-Z0-9]+)/);
                                        if(idMatch) {
                                            let hCode = 'voe';
                                            if(host.includes('wish')) hCode = 'streamwish';
                                            if(host.includes('dood')) hCode = 'doodstream';
                                            if(host.includes('hide')) hCode = 'vidhide';
                                            
                                            // Agregar Versión Limpia
                                            Core.addSource(group, {
                                                name: `Unlimplay (${name})`,
                                                url: `https://unlimplay.com/embed2/?host=${hCode}&id=${idMatch[1]}`,
                                                quality: "HD",
                                                isClean: true
                                            });
                                            isClean = true;
                                        }
                                    }
                                    
                                    // Agregar versión original (Solo si no pudimos limpiarla, o como respaldo)
                                    // Si se limpio, no agregamos la sucia para evitar basura visual, o la ponemos al final
                                    if(!isClean) {
                                        Core.addSource(group, { name: name, url: url, quality: "HD", isClean: false });
                                    }
                                }
                            });
                        });
                    }
                } catch(e) { console.log(e); }
            },

            verHD: async () => {
                try {
                    const res = await fetch(CFG.PROXY + encodeURIComponent(`https://verhdlink.cam/movie/${Core.state.imdb}`));
                    const txt = await res.text();
                    const matches = txt.matchAll(/dropload\.tv\/e\/([a-zA-Z0-9_-]+)/g);
                    for(const m of matches) {
                        Core.addSource('LATINO', {
                            name: "Thunderbolt (Unlimplay)",
                            url: `https://unlimplay.com/embed2/?host=dropload&id=${m[1]}`,
                            quality: "1080p",
                            isClean: true
                        });
                    }
                } catch(e) {}
            }
        };

        window.onload = Core.init;
    </script>
</body>
</html>
