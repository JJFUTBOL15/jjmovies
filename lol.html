<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <meta name="theme-color" content="#000000">
    <title>JJMOVIES | TITAN V4 - MILITARY GRADE</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700&family=Rajdhani:wght@300;500;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { DEFAULT: '#E50914', dark: '#8a040b', neon: '#ff1f26' },
                        sys: { black: '#020202', panel: '#0a0a0a', border: '#1a1a1a', text: '#888' },
                        term: { green: '#00ff41', red: '#ff0033', blue: '#00ccff', amber: '#ffb300' }
                    },
                    fontFamily: {
                        sans: ['Rajdhani', 'sans-serif'],
                        tech: ['Chakra Petch', 'monospace'],
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'flash': 'flash 2s infinite',
                        'scanline': 'scanline 8s linear infinite',
                        'matrix': 'matrix 20s linear infinite',
                        'blink': 'blink 1s step-end infinite',
                        'shield-pulse': 'shieldPulse 3s infinite',
                    },
                    keyframes: {
                        flash: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.5' } },
                        scanline: { '0%': { transform: 'translateY(-100%)' }, '100%': { transform: 'translateY(100%)' } },
                        blink: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0' } },
                        shieldPulse: { '0%, 100%': { boxShadow: '0 0 10px rgba(0, 255, 65, 0.2)' }, '50%': { boxShadow: '0 0 25px rgba(0, 255, 65, 0.6)' } }
                    },
                    boxShadow: {
                        'neon': '0 0 20px rgba(229, 9, 20, 0.6)',
                        'screen': 'inset 0 0 50px rgba(0,0,0,0.9)',
                        'term': '0 0 10px rgba(0, 255, 65, 0.2)'
                    }
                }
            }
        }
    </script>

    <style>
        /* ESTILOS BASE */
        :root { --app-bg: #000; --grid-color: rgba(255, 255, 255, 0.03); }
        body { background-color: var(--app-bg); color: #fff; overflow-x: hidden; font-family: 'Rajdhani', sans-serif; }
        
        /* FONDO TECNOLÓGICO */
        .bg-grid {
            background-size: 40px 40px;
            background-image: linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
                              linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
        }

        /* SCROLLBAR TÁCTICO */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border: 1px solid #000; }
        ::-webkit-scrollbar-thumb:hover { background: #E50914; }

        /* EFECTOS DE TEXTO */
        .text-neon { text-shadow: 0 0 10px rgba(229, 9, 20, 0.8); }
        .text-term { text-shadow: 0 0 5px rgba(0, 255, 65, 0.5); }
        
        /* SERVER LIST ITEM */
        .server-item {
            position: relative;
            background: rgba(255,255,255,0.02);
            border-left: 2px solid transparent;
            transition: all 0.2s;
        }
        .server-item:hover { background: rgba(255,255,255,0.05); }
        .server-item.active {
            background: linear-gradient(90deg, rgba(229,9,20,0.1) 0%, transparent 100%);
            border-left-color: #E50914;
        }
        .server-item.active .status-dot { background: #00ff41; box-shadow: 0 0 8px #00ff41; }

        /* UTILS */
        .hidden-force { display: none !important; }
        .full-width { width: 100% !important; }
        .no-sidebar { width: 0% !important; padding: 0 !important; overflow: hidden; opacity: 0; }

        /* MONITOR SCANLINE EFFECT */
        .scanline-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.15;
        }
        
        /* SHIELD OVERLAY */
        .click-shield {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20;
            cursor: pointer;
            background: transparent;
        }
    </style>
</head>
<body class="selection:bg-brand selection:text-white">

    <div class="scanline-overlay"></div>

    <nav class="fixed top-0 w-full z-50 h-16 border-b border-white/5 bg-black/95 backdrop-blur-md flex justify-between items-center px-6">
        <div class="flex flex-col cursor-pointer group" onclick="window.location.reload()">
            <div class="flex items-center gap-2">
                <i class="fas fa-biohazard text-brand text-2xl animate-pulse-fast"></i>
                <span class="text-3xl font-black tracking-tighter text-white italic">
                    JJ<span class="text-brand text-neon">MOVIES</span>
                </span>
            </div>
            <div class="flex items-center gap-2 text-[10px] font-tech text-gray-500 uppercase tracking-widest pl-8 -mt-1">
                <span>Sys.Ver 4.0</span>
                <span class="text-brand">MILITARY GRADE</span>
            </div>
        </div>

        <div class="hidden md:flex items-center gap-6">
            <div class="flex flex-col items-end">
                <div class="text-[9px] font-tech text-gray-500 uppercase">Database Status</div>
                <div class="flex items-center gap-2">
                    <span id="fake-updater" class="text-[10px] text-brand font-bold animate-blink">UPDATING PROTOCOLS...</span>
                    <i class="fas fa-database text-xs text-gray-600"></i>
                </div>
            </div>

            <div class="h-6 w-[1px] bg-white/10"></div>

            <div class="flex items-center gap-2 bg-white/5 px-3 py-1 rounded border border-white/10 shadow-neon">
                <div class="relative w-2 h-2">
                    <span class="absolute inline-flex h-full w-full rounded-full bg-term-green opacity-75 animate-ping"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-term-green"></span>
                </div>
                <span class="text-[10px] font-bold font-tech text-term-green tracking-[0.2em]">SYSTEM SECURE</span>
            </div>
        </div>
    </nav>

    <main class="relative z-10 w-full h-screen flex items-center bg-grid">
        
        <div class="absolute inset-0 z-[-1] overflow-hidden">
            <div id="bg-backdrop" class="absolute inset-0 bg-cover bg-center transition-all duration-1000 opacity-0 scale-110"></div>
            <div class="absolute inset-0 bg-gradient-to-r from-black via-black/95 to-transparent"></div>
            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/80 to-transparent"></div>
        </div>

        <div id="hero-panel" class="container mx-auto px-6 max-w-6xl opacity-0 translate-y-10 transition-all duration-700">
            
            <div class="flex items-center gap-3 mb-4">
                <div class="px-2 py-0.5 border border-brand/50 bg-brand/10 text-brand text-[10px] font-bold font-tech uppercase tracking-widest rounded">
                    Titan Core
                </div>
                <div class="px-2 py-0.5 border border-white/10 bg-white/5 text-gray-400 text-[10px] font-bold font-tech uppercase tracking-widest rounded">
                    4K HDR
                </div>
                <div class="px-2 py-0.5 border border-term-green/30 bg-term-green/10 text-term-green text-[10px] font-bold font-tech uppercase tracking-widest rounded flex items-center gap-1 animate-shield-pulse">
                    <i class="fas fa-shield-alt"></i> Ad-Block Active
                </div>
            </div>

            <h1 id="movie-title" class="text-6xl md:text-8xl font-black text-white leading-none uppercase tracking-tighter mb-4 text-shadow-glow">
                INITIATING...
            </h1>

            <div class="flex items-center gap-4 text-sm font-bold text-gray-400 mb-6 font-tech">
                <span id="meta-year" class="text-white">----</span>
                <span>•</span>
                <span id="meta-rating" class="text-yellow-500"><i class="fas fa-star"></i> --</span>
                <span>•</span>
                <span id="meta-duration">-- min</span>
            </div>

            <div id="series-controls" class="hidden flex flex-wrap gap-4 mb-8 p-4 border border-white/5 bg-white/5 rounded-lg backdrop-blur-sm max-w-2xl">
                <div class="w-full text-[10px] text-gray-500 font-tech uppercase tracking-widest mb-1 flex justify-between">
                    <span>Configuración de Episodio</span>
                    <span id="ep-name-display" class="text-brand">Loading...</span>
                </div>
                
                <div class="relative group flex-1">
                    <select id="season-select" class="w-full bg-black border border-white/20 text-white font-bold px-4 py-3 outline-none focus:border-brand transition-colors appearance-none font-tech text-sm uppercase"></select>
                    <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-600"></i>
                </div>
                
                <div class="relative group flex-1">
                    <select id="episode-select" class="w-full bg-black border border-white/20 text-white font-bold px-4 py-3 outline-none focus:border-brand transition-colors appearance-none font-tech text-sm uppercase"></select>
                    <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-600"></i>
                </div>
            </div>

            <p id="movie-desc" class="text-gray-400 text-lg max-w-2xl leading-relaxed mb-8 border-l-2 border-brand pl-4 font-light">
                Esperando datos de entrada. Por favor verifica el ID en la URL.
            </p>

            <button onclick="Core.start()" class="group relative px-10 py-5 bg-brand hover:bg-white text-white hover:text-brand font-black text-xl uppercase tracking-widest transition-all duration-300 shadow-neon overflow-hidden skew-x-[-10deg]">
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/40 to-transparent -translate-x-full group-hover:animate-[shimmer_1s_infinite]"></div>
                <div class="skew-x-[10deg] flex items-center gap-3">
                    <i class="fas fa-play text-2xl"></i>
                    <span>EJECUTAR SISTEMA</span>
                </div>
            </button>

        </div>
    </main>

    <div id="player-overlay" class="fixed inset-0 z-[100] bg-black hidden flex flex-col md:flex-row opacity-0 transition-opacity duration-500">
        
        <div id="video-area" class="relative w-full md:w-[75%] h-[40vh] md:h-full bg-black flex items-center justify-center border-r border-white/10 transition-all duration-500">
            
            <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-center z-20 bg-gradient-to-b from-black/90 to-transparent pointer-events-none">
                <button onclick="Core.close()" class="pointer-events-auto w-10 h-10 rounded bg-white/5 hover:bg-brand border border-white/10 text-white flex items-center justify-center transition-all">
                    <i class="fas fa-times"></i>
                </button>

                <div class="pointer-events-auto flex gap-2">
                    <button onclick="Core.toggleSidebar()" class="px-4 py-1.5 bg-brand text-white text-[10px] font-bold uppercase tracking-widest rounded border border-brand hover:bg-white hover:text-brand transition-all flex items-center gap-2">
                        <i class="fas fa-expand"></i> <span id="toggle-text">Expandir</span>
                    </button>
                    
                    <div class="px-4 py-1.5 bg-black/80 text-gray-300 text-[10px] font-bold uppercase tracking-widest rounded border border-white/10 flex items-center gap-2">
                        <span id="playing-server-name">---</span>
                        <div id="secure-indicator" class="hidden flex items-center gap-1 text-term-green">
                            <i class="fas fa-lock text-[8px]"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="relative w-full h-full">
                <div id="click-shield" class="hidden click-shield" onclick="Core.removeShield()"></div>
                
                <iframe id="video-frame" class="w-full h-full border-0" 
                    allowfullscreen 
                    allow="autoplay; encrypted-media; picture-in-picture">
                </iframe>
            </div>

            <div id="internal-loader" class="absolute inset-0 bg-black z-10 flex flex-col items-center justify-center hidden">
                <div class="relative mb-4">
                    <div class="absolute inset-0 bg-brand/20 blur-xl rounded-full animate-pulse"></div>
                    <i class="fas fa-circle-notch fa-spin text-4xl text-brand relative z-10"></i>
                </div>
                <div class="text-[10px] font-tech text-brand uppercase tracking-[0.3em] animate-pulse">Estableciendo Conexión Segura...</div>
                <div class="text-[9px] text-gray-600 mt-2 font-mono">ENCRYPTING DATA STREAM</div>
            </div>

        </div>

        <div id="sidebar-area" class="w-full md:w-[25%] h-[60vh] md:h-full bg-[#050505] flex flex-col transition-all duration-500 overflow-hidden border-l border-white/5 shadow-[-20px_0_50px_rgba(0,0,0,0.5)]">
            
            <div class="p-4 border-b border-white/5 bg-[#080808] flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i class="fas fa-server text-brand"></i>
                    <span class="text-xs font-bold font-tech uppercase tracking-widest text-white">Cambiar de Servidor</span>
                </div>
                <span id="total-sources" class="text-[10px] text-gray-500 font-mono">0 NODES</span>
            </div>

            <div id="server-list" class="flex-1 overflow-y-auto custom-scroll relative bg-grid">
                </div>

            <div class="p-3 bg-black border-t border-white/5 text-[8px] text-center text-gray-600 font-mono uppercase flex justify-between px-6">
                <span>JJMovies v3.0</span>
                <span class="text-term-green flex items-center gap-1"><i class="fas fa-shield-alt"></i> Protected</span>
            </div>
        </div>

    </div>

    <div id="global-loader" class="fixed inset-0 z-[200] bg-black hidden flex flex-col items-center justify-center font-mono">
        <i class="fas fa-fingerprint text-6xl text-brand mb-6 animate-pulse"></i>
        <h2 class="text-2xl font-bold text-white tracking-widest mb-4">ACCESSING MAINFRAME</h2>
        
        <div class="w-80 h-32 bg-[#0a0a0a] border border-brand/30 rounded p-4 text-[10px] text-term-green overflow-hidden relative shadow-term">
            <div class="absolute inset-0 bg-scanline opacity-10 pointer-events-none"></div>
            <div id="terminal-logs" class="flex flex-col gap-1">
                <span>> Initializing protocol v4.0...</span>
                <span>> Bypassing region lock... <span class="text-brand">OK</span></span>
            </div>
        </div>
    </div>

    <script>
        const CFG = {
            API: '936410eebae74f9895643e085cc4a740', 
            PROXY: 'https://api.codetabs.com/v1/proxy/?quest='
        };

        const Core = {
            state: { id: null, type: 'movie', season: 1, episode: 1, sources: {}, sidebarOpen: true },

            init: async () => {
                const p = new URLSearchParams(location.search);
                const id = p.get('id');
                if(!id) {
                    Core.updateMeta({ title: "SYSTEM IDLE", overview: "Esperando comando de entrada. Inserta ID." });
                    document.getElementById('hero-panel').classList.remove('opacity-0', 'translate-y-10');
                    return;
                }
                Core.state.id = id;
                Core.state.season = parseInt(p.get('season') || 1);
                Core.state.episode = parseInt(p.get('episode') || 1);
                if(p.get('season')) Core.state.type = 'tv';
                await Core.fetchTMDB();
            },

            fetchTMDB: async () => {
                try {
                    const { id, type, season, episode } = Core.state;
                    const url = `https://api.themoviedb.org/3/${type}/${id}?api_key=${CFG.API}&language=es-MX&append_to_response=external_ids`;
                    const res = await fetch(url);
                    const data = await res.json();

                    Core.state.imdb = data.external_ids?.imdb_id;
                    Core.state.totalSeasons = data.number_of_seasons || 0;
                    
                    let meta = { ...data };
                    if(type === 'tv') {
                        const sRes = await fetch(`https://api.themoviedb.org/3/tv/${id}/season/${season}?api_key=${CFG.API}&language=es-MX`);
                        const sData = await sRes.json();
                        const ep = sData.episodes?.find(e => e.episode_number == episode) || {};
                        meta.backdrop_path = ep.still_path || data.backdrop_path;
                        meta.overview = ep.overview || data.overview;
                        meta.epName = ep.name;
                        Core.renderSelectors();
                    }
                    Core.updateMeta(meta);
                } catch(e) { console.error(e); }
            },

            updateMeta: (data) => {
                document.getElementById('movie-title').innerText = data.title || data.name;
                document.getElementById('movie-desc').innerText = data.overview || "No data.";
                document.getElementById('meta-year').innerText = (data.release_date || data.first_air_date || '----').split('-')[0];
                document.getElementById('meta-rating').innerHTML = `<i class="fas fa-star text-yellow-500 mr-1"></i> ${data.vote_average?.toFixed(1) || '0.0'}`;
                
                if(data.backdrop_path) {
                    document.getElementById('bg-backdrop').style.backgroundImage = `url('https://image.tmdb.org/t/p/original${data.backdrop_path}')`;
                    document.getElementById('bg-backdrop').classList.remove('opacity-0');
                }
                if(Core.state.type === 'tv') {
                    document.getElementById('series-controls').classList.remove('hidden');
                    document.getElementById('ep-name-display').innerText = `${data.epName || 'Episode ' + Core.state.episode}`;
                }
                document.getElementById('hero-panel').classList.remove('opacity-0', 'translate-y-10');
            },

            renderSelectors: () => {
                const s = document.getElementById('season-select');
                const e = document.getElementById('episode-select');
                s.innerHTML = ''; e.innerHTML = '';
                for(let i=1; i<=Core.state.totalSeasons; i++) s.innerHTML += `<option value="${i}" ${i==Core.state.season?'selected':''}>TEMPORADA ${i}</option>`;
                for(let i=1; i<=50; i++) e.innerHTML += `<option value="${i}" ${i==Core.state.episode?'selected':''}>EPISODIO ${i}</option>`;
                
                const reload = () => window.location.href = `?id=${Core.state.id}&season=${s.value}&episode=${e.value}`;
                s.onchange = () => { e.value = 1; reload(); };
                e.onchange = reload;
            },

            // --- MOTOR DE ARRANQUE ---
            start: async () => {
                const l = document.getElementById('global-loader');
                const log = document.getElementById('terminal-logs');
                l.classList.remove('hidden');
                
                const addLog = (txt) => {
                    log.innerHTML += `<span>> ${txt}</span>`;
                    log.scrollTop = log.scrollHeight;
                };

                Core.state.sources = { 'LAT': [], 'ESP': [], 'ENG': [] };

                addLog("Scanning Embed69 Network...");
                if(Core.state.imdb) await Scraper.embed69();
                
                addLog("Checking VidSrc Backup...");
                // Aquí aplicamos el "Military Block" por defecto
                Core.addSource('ENG', { name: "VidSrc (Backup)", url: Scraper.getVidSrc(), clean: false, forceSandbox: true });
                Core.addSource('ENG', { name: "UEmbed (Backup)", url: Scraper.getUEmbed(), clean: false, forceSandbox: true });

                addLog("Decryption Complete.");
                setTimeout(() => {
                    l.classList.add('hidden');
                    Core.openPlayer();
                    Core.renderList();
                    
                    // AUTOPLAY: Prioridad Latino -> Castellano -> Ingles
                    if(Core.state.sources['LAT'].length > 0) Core.play(0, 'LAT');
                    else if(Core.state.sources['ESP'].length > 0) Core.play(0, 'ESP');
                    else Core.play(0, 'ENG');

                }, 800);
            },

            addSource: (lang, src) => {
                if(!Core.state.sources[lang].some(s => s.url === src.url)) {
                    Core.state.sources[lang].push(src);
                }
            },

            renderList: () => {
                const c = document.getElementById('server-list');
                c.innerHTML = '';
                let total = 0;
                
                const sections = [
                    { id: 'LAT', label: 'LATINO', flag: 'https://flagcdn.com/w40/mx.png' },
                    { id: 'ESP', label: 'CASTELLANO', flag: 'https://flagcdn.com/w40/es.png' },
                    { id: 'ENG', label: 'ENGLISH / SUB', flag: 'https://flagcdn.com/w40/us.png' }
                ];

                sections.forEach(sec => {
                    const list = Core.state.sources[sec.id];
                    if(list.length > 0) {
                        total += list.length;
                        
                        // Header Sección
                        const header = document.createElement('div');
                        header.className = 'sticky top-0 bg-[#050505]/95 backdrop-blur z-10 p-3 border-y border-white/5 flex items-center gap-3';
                        header.innerHTML = `
                            <img src="${sec.flag}" class="w-5 h-3 rounded shadow-sm opacity-80">
                            <span class="text-[10px] font-bold font-tech text-gray-300 tracking-widest">${sec.label}</span>
                            <span class="text-[9px] bg-white/10 px-1.5 rounded text-gray-500">${list.length}</span>
                        `;
                        c.appendChild(header);

                        // Items
                        list.forEach((src, idx) => {
                            const item = document.createElement('div');
                            item.className = 'server-item p-4 border-b border-white/5 cursor-pointer group flex justify-between items-center';
                            item.onclick = () => Core.play(idx, sec.id);
                            item.dataset.gid = `${sec.id}-${idx}`;

                            const shield = src.clean 
                                ? `<i class="fas fa-shield-alt text-term-green text-xs" title="Limpio"></i>` 
                                : `<i class="fas fa-lock text-gray-600 text-[10px]" title="Sandbox Activo"></i>`;

                            item.innerHTML = `
                                <div class="flex items-center gap-3">
                                    <div class="status-dot w-1.5 h-1.5 rounded-full bg-gray-700 transition-all"></div>
                                    <div class="flex flex-col">
                                        <span class="text-xs font-bold text-gray-300 group-hover:text-white transition-colors">${src.name}</span>
                                        <span class="text-[9px] text-gray-600 font-mono uppercase">Server ${idx+1}</span>
                                    </div>
                                </div>
                                ${shield}
                            `;
                            c.appendChild(item);
                        });
                    }
                });
                
                document.getElementById('total-sources').innerText = `${total} NODES`;
            },

            play: (idx, lang) => {
                const src = Core.state.sources[lang][idx];
                const frame = document.getElementById('video-frame');
                const loader = document.getElementById('internal-loader');
                const alertBox = document.getElementById('sandbox-alert');
                
                // UI States
                document.querySelectorAll('.server-item').forEach(el => el.classList.remove('active'));
                const activeEl = document.querySelector(`.server-item[data-gid="${lang}-${idx}"]`);
                if(activeEl) activeEl.classList.add('active');

                document.getElementById('playing-server-name').innerText = `${lang} • ${src.name}`;
                if(src.clean) document.getElementById('secure-indicator').classList.remove('hidden');
                else document.getElementById('secure-indicator').classList.add('hidden');

                // Reset
                frame.classList.add('hidden');
                alertBox.classList.add('hidden');
                loader.classList.remove('hidden');
                
                // LOGICA MILITAR (SANDBOX)
                // Si el servidor requiere fuerza bruta (forceSandbox) o NO es limpio, le aplicamos el candado.
                if(src.forceSandbox || !src.clean) {
                    frame.setAttribute('sandbox', 'allow-forms allow-pointer-lock allow-same-origin allow-scripts allow-top-navigation-by-user-activation'); // SIN allow-popups
                    
                    // Preparamos la alerta por si falla
                    setTimeout(() => {
                        if(!frame.classList.contains('hidden')) {
                             alertBox.classList.remove('hidden');
                        }
                    }, 5000); // Aparece a los 5s si el usuario sigue ahí (posiblemente viendo pantalla negra)
                } else {
                    frame.removeAttribute('sandbox'); // Servidores limpios van sin restricciones
                }

                setTimeout(() => {
                    frame.src = src.url;
                    frame.onload = () => {
                        loader.classList.add('hidden');
                        frame.classList.remove('hidden');
                    };
                }, 300);
            },

            disableSandbox: () => {
                const frame = document.getElementById('video-frame');
                const currentUrl = frame.src;
                const loader = document.getElementById('internal-loader');
                
                document.getElementById('sandbox-alert').classList.add('hidden');
                frame.classList.add('hidden');
                loader.classList.remove('hidden');
                
                // Quitamos el candado y recargamos
                frame.removeAttribute('sandbox');
                frame.src = currentUrl;
            },

            openPlayer: () => {
                const ui = document.getElementById('player-overlay');
                ui.classList.remove('hidden');
                setTimeout(() => ui.classList.remove('opacity-0'), 50);
            },

            close: () => {
                const ui = document.getElementById('player-overlay');
                ui.classList.add('opacity-0');
                setTimeout(() => {
                    ui.classList.add('hidden');
                    document.getElementById('video-frame').src = 'about:blank';
                }, 500);
            },

            toggleSidebar: () => {
                const v = document.getElementById('video-area');
                const s = document.getElementById('sidebar-area');
                const txt = document.getElementById('toggle-text');
                
                Core.state.sidebarOpen = !Core.state.sidebarOpen;
                
                if(Core.state.sidebarOpen) {
                    v.classList.remove('full-width');
                    v.classList.add('w-[75%]');
                    s.classList.remove('no-sidebar');
                    s.classList.add('w-[25%]');
                    txt.innerText = "Expandir";
                } else {
                    v.classList.remove('w-[75%]');
                    v.classList.add('full-width');
                    s.classList.remove('w-[25%]');
                    s.classList.add('no-sidebar');
                    txt.innerText = "Cambiar de Servidor";
                }
            }
        };

        const Scraper = {
            base64UrlDecode: (str) => {
                str = str.replace(/-/g, '+').replace(/_/g, '/');
                return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
            },
            decodeJWT: (token) => {
                try { return JSON.parse(Scraper.base64UrlDecode(token.split('.')[1])); } catch { return null; }
            },
            
            getVidSrc: () => {
                const { id, type, season, episode } = Core.state;
                return type==='movie' ? `https://vidsrc.cc/v2/embed/movie/${id}` : `https://vidsrc.cc/v2/embed/tv/${id}/${season}/${episode}`;
            },
            getUEmbed: () => {
                const { id, type, season, episode } = Core.state;
                let u = `https://uembed.xyz/?id=${id}`;
                if(type==='tv') u+= `&season=${season}&episode=${episode}`;
                return u;
            },

            embed69: async () => {
                try {
                    const { imdb, type, season, episode } = Core.state;
                    const slug = type==='tv' ? `${imdb}-${season}x${String(episode).padStart(2,'0')}` : imdb;
                    const res = await fetch(CFG.PROXY + encodeURIComponent(`https://embed69.org/f/${slug}/`));
                    const html = await res.text();
                    const match = html.match(/let dataLink\s*=\s*(\[[\s\S]*?\]);/);
                    
                    if(match) {
                        const data = JSON.parse(match[1]);
                        data.forEach(item => {
                            let lang = 'ENG';
                            const l = item.video_language || "";
                            if(l.includes('LAT')) lang = 'LAT';
                            else if(l.includes('ESP') || l.includes('CAS')) lang = 'ESP';
                            else if(l.includes('SUB')) lang = 'ENG';

                            item.sortedEmbeds.forEach(embed => {
                                const decoded = Scraper.decodeJWT(embed.link);
                                if(decoded && decoded.link) {
                                    const host = embed.servername.toLowerCase();
                                    let url = decoded.link;
                                    let clean = false;
                                    let name = embed.servername;

                                    // UNLIMPLAY CONVERSION
                                    if(['voe','streamwish','dood','vidhide','filemoon'].some(h => host.includes(h))) {
                                        const idMatch = url.match(/\/([a-zA-Z0-9]+)$/) || url.match(/\/e\/([a-zA-Z0-9]+)/);
                                        if(idMatch) {
                                            let hCode = 'voe';
                                            if(host.includes('wish')) hCode = 'streamwish';
                                            if(host.includes('dood')) hCode = 'doodstream';
                                            if(host.includes('hide')) hCode = 'vidhide';
                                            
                                            Core.addSource(lang, {
                                                name: `${name} (Limpio)`,
                                                url: `https://unlimplay.com/embed2/?host=${hCode}&id=${idMatch[1]}`,
                                                clean: true
                                            });
                                            clean = true;
                                        }
                                    }
                                    
                                    if(!clean) {
                                        Core.addSource(lang, { name: name, url: url, clean: false, forceSandbox: false });
                                    }
                                }
                            });
                        });
                    }
                } catch(e) {}
            }
        };

        window.onload = Core.init;
    </script>
</body>
</html>
