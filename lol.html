<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <meta name="theme-color" content="#000000">
    <title>JJMOVIES V3.0 | LATINO HUNTER</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700&family=Rajdhani:wght@300;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { DEFAULT: '#E50914', dark: '#b20710', glow: 'rgba(229, 9, 20, 0.6)' },
                        sys: { bg: '#000000', surface: '#0a0a0a', border: '#1f1f1f' },
                        lang: { lat: '#fbbf24', esp: '#ef4444', sub: '#3b82f6' }
                    },
                    fontFamily: { sans: ['Rajdhani', 'sans-serif'], tech: ['Chakra Petch', 'monospace'] },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'scanline': 'scanline 8s linear infinite',
                    },
                    keyframes: {
                        scanline: { '0%': { transform: 'translateY(-100%)' }, '100%': { transform: 'translateY(100%)' } }
                    },
                    boxShadow: { 'neon': '0 0 30px rgba(229, 9, 20, 0.4)' }
                }
            }
        }
    </script>

    <style>
        :root { --app-bg: #000; }
        body { background: var(--app-bg); color: #fff; overflow-x: hidden; font-family: 'Rajdhani', sans-serif; }
        .bg-grid { background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px); background-size: 40px 40px; }
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-track { background: #000; } ::-webkit-scrollbar-thumb { background: #333; } ::-webkit-scrollbar-thumb:hover { background: #E50914; }
        .server-item { background: rgba(255,255,255,0.02); border-left: 3px solid transparent; transition: all 0.2s; }
        .server-item:hover { background: rgba(255,255,255,0.05); }
        .server-item.active { background: linear-gradient(90deg, rgba(229,9,20,0.15) 0%, transparent 100%); border-left-color: #E50914; }
        .tab-btn { border-bottom: 2px solid transparent; opacity: 0.6; transition: all 0.3s; }
        .tab-btn.active { border-bottom-color: #E50914; opacity: 1; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
        .click-shield { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; cursor: pointer; background: transparent; }
        .scanline-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(0,0,0,0.1) 50%); background-size: 100% 4px; pointer-events: none; z-index: 9999; opacity: 0.1; }
        .hidden-force { display: none !important; }
    </style>
</head>
<body class="selection:bg-brand selection:text-white">

    <div class="scanline-overlay"></div>

    <nav class="fixed top-0 w-full z-50 h-16 border-b border-white/5 bg-black/95 backdrop-blur-md flex justify-between items-center px-6">
        <div class="flex flex-col cursor-pointer" onclick="window.location.reload()">
            <div class="flex items-center gap-2">
                <i class="fas fa-biohazard text-brand text-2xl animate-pulse-fast"></i>
                <span class="text-3xl font-black tracking-tighter text-white italic">JJ<span class="text-brand">MOVIES</span></span>
            </div>
            <div class="flex items-center gap-2 text-[10px] font-tech text-gray-500 uppercase tracking-widest pl-8 -mt-1">
                <span>V 3.0</span> <span class="text-brand font-bold">LATINO HUNTER</span>
            </div>
        </div>
        <div class="hidden md:flex items-center gap-2 bg-white/5 px-3 py-1 rounded border border-white/10 shadow-neon">
            <div class="w-2 h-2 rounded-full bg-term-green animate-pulse"></div>
            <span class="text-[10px] font-bold font-tech text-term-green tracking-[0.2em]">SYSTEM READY</span>
        </div>
    </nav>

    <main class="relative z-10 w-full min-h-screen flex flex-col justify-center bg-grid pt-20 pb-20">
        <div class="absolute inset-0 z-[-1] overflow-hidden fixed">
            <div id="bg-backdrop" class="absolute inset-0 bg-cover bg-center transition-all duration-1000 opacity-0 scale-110"></div>
            <div class="absolute inset-0 bg-gradient-to-r from-black via-black/95 to-transparent"></div>
            <div class="absolute inset-0 bg-gradient-to-t from-black via-black/80 to-transparent"></div>
        </div>

        <div id="hero-panel" class="container mx-auto px-6 max-w-6xl opacity-0 translate-y-10 transition-all duration-700">
            <div class="flex items-center gap-3 mb-4">
                <div class="px-2 py-0.5 border border-brand/50 bg-brand/10 text-brand text-[10px] font-bold font-tech uppercase tracking-widest rounded">JJMovies</div>
                <div class="px-2 py-0.5 border border-term-green/30 text-term-green text-[10px] font-bold font-tech uppercase tracking-widest rounded flex items-center gap-1"><i class="fas fa-shield-alt"></i> Safe</div>
            </div>

            <h1 id="movie-title" class="text-5xl md:text-8xl font-black text-white leading-none uppercase tracking-tighter mb-4">ESPERANDO ID...</h1>

            <div class="flex items-center gap-4 text-sm font-bold text-gray-400 mb-6 font-tech">
                <span id="meta-year" class="text-white">----</span>
                <span>â€¢</span>
                <span id="meta-rating" class="text-yellow-500"><i class="fas fa-star"></i> --</span>
                <span>â€¢</span>
                <span id="meta-duration">-- min</span>
            </div>

            <div id="series-controls" class="hidden flex flex-wrap gap-4 mb-8 p-4 border border-white/5 bg-white/5 rounded-lg max-w-2xl">
                <div class="w-full text-[10px] text-gray-500 font-tech uppercase tracking-widest mb-1 flex justify-between">
                    <span>Selector</span> <span id="ep-name-display" class="text-brand">Loading...</span>
                </div>
                <div class="relative group flex-1">
                    <select id="season-select" class="w-full bg-black border border-white/20 text-white font-bold px-4 py-3 outline-none focus:border-brand appearance-none font-tech text-sm uppercase"></select>
                    <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-600"></i>
                </div>
                <div class="relative group flex-1">
                    <select id="episode-select" class="w-full bg-black border border-white/20 text-white font-bold px-4 py-3 outline-none focus:border-brand appearance-none font-tech text-sm uppercase"></select>
                    <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-600"></i>
                </div>
            </div>

            <p id="movie-desc" class="text-gray-400 text-lg max-w-2xl leading-relaxed mb-8 border-l-2 border-brand pl-4 font-light">
                Agrega ?id=... a la URL para iniciar el rastreo.
            </p>

            <button onclick="Core.start()" class="group relative px-10 py-5 bg-brand hover:bg-white text-white hover:text-brand font-black text-xl uppercase tracking-widest transition-all duration-300 shadow-neon overflow-hidden skew-x-[-10deg] mb-12">
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/40 to-transparent -translate-x-full group-hover:animate-[shimmer_1s_infinite]"></div>
                <div class="skew-x-[10deg] flex items-center gap-3"><i class="fas fa-search"></i> <span>INICIAR BÃšSQUEDA</span></div>
            </button>

            <div id="cast-container" class="border-t border-white/10 pt-8 opacity-0 transition-opacity duration-1000">
                <h3 class="text-sm font-bold font-tech uppercase tracking-widest text-gray-400 mb-4">Reparto Principal</h3>
                <div id="cast-list" class="cast-scroll custom-scroll"></div>
            </div>
        </div>
    </main>

    <div id="actor-modal" class="fixed inset-0 z-[150] bg-black/95 backdrop-blur-xl hidden opacity-0 transition-all duration-500 overflow-y-auto">
        <div class="container mx-auto px-6 py-12 max-w-5xl">
            <div class="flex justify-between items-start mb-8 sticky top-0 bg-black/90 p-4 border-b border-white/10 z-10 backdrop-blur">
                <div class="flex items-center gap-6">
                    <img id="actor-profile-img" src="" class="w-20 h-20 rounded-full object-cover border-2 border-brand shadow-neon">
                    <div>
                        <h2 id="actor-name" class="text-3xl font-black text-white uppercase tracking-tighter">Actor</h2>
                        <p class="text-xs text-brand font-tech uppercase tracking-widest mt-1">FilmografÃ­a</p>
                    </div>
                </div>
                <button onclick="Core.closeActorModal()" class="w-10 h-10 rounded-full bg-white/10 hover:bg-white text-white hover:text-black flex items-center justify-center transition-all"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="actor-movies-grid" class="film-grid pb-20"></div>
        </div>
    </div>

    <div id="player-overlay" class="fixed inset-0 z-[100] bg-black hidden flex flex-col md:flex-row opacity-0 transition-opacity duration-500">
        <div id="video-area" class="relative w-full md:w-[75%] h-[40vh] md:h-full bg-black flex items-center justify-center border-r border-white/10 transition-all duration-500">
            <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-center z-20 bg-gradient-to-b from-black/90 to-transparent pointer-events-none">
                <button onclick="Core.close()" class="pointer-events-auto w-10 h-10 rounded bg-white/5 hover:bg-brand border border-white/10 text-white flex items-center justify-center transition-all"><i class="fas fa-times"></i></button>
                <div class="pointer-events-auto flex gap-2">
                    <button onclick="Core.toggleSidebar()" class="px-4 py-1.5 bg-brand text-white text-[10px] font-bold uppercase tracking-widest rounded border border-brand hover:bg-white hover:text-brand transition-all flex items-center gap-2"><i class="fas fa-expand"></i> <span id="toggle-text">Expandir</span></button>
                    <div class="px-4 py-1.5 bg-black/80 text-gray-300 text-[10px] font-bold uppercase tracking-widest rounded border border-white/10 flex items-center gap-2"><span id="playing-server-name">---</span></div>
                </div>
            </div>
            <div class="relative w-full h-full bg-black">
                <div id="click-shield" class="click-shield hidden" onclick="Core.removeShield()"></div>
                <iframe id="video-frame" class="w-full h-full border-0 absolute inset-0 z-10" allowfullscreen allow="autoplay; encrypted-media; picture-in-picture"></iframe>
            </div>
            <div id="internal-loader" class="absolute inset-0 bg-black z-20 flex flex-col items-center justify-center hidden">
                <div class="w-12 h-12 border-4 border-brand border-t-transparent rounded-full animate-spin mb-4"></div>
                <div class="text-[10px] font-tech text-brand uppercase tracking-[0.3em] animate-pulse">Conectando...</div>
            </div>
        </div>

        <div id="sidebar-area" class="w-full md:w-[25%] h-[60vh] md:h-full bg-[#050505] flex flex-col transition-all duration-500 overflow-hidden border-l border-white/5">
            <div class="p-4 border-b border-white/5 bg-[#080808]">
                <h3 class="text-xs font-bold font-tech uppercase tracking-widest text-white mb-3 flex items-center gap-2"><i class="fas fa-globe text-brand"></i> Idioma</h3>
                <div class="flex border-b border-white/10 mb-2">
                    <button onclick="Core.switchTab('LAT')" id="tab-LAT" class="tab-btn flex-1 py-2 text-[10px] font-bold uppercase tracking-widest hover:bg-white/5 active">ðŸ‡²ðŸ‡½ Latino</button>
                    <button onclick="Core.switchTab('ESP')" id="tab-ESP" class="tab-btn flex-1 py-2 text-[10px] font-bold uppercase tracking-widest hover:bg-white/5">ðŸ‡ªðŸ‡¸ Castellano</button>
                    <button onclick="Core.switchTab('ENG')" id="tab-ENG" class="tab-btn flex-1 py-2 text-[10px] font-bold uppercase tracking-widest hover:bg-white/5">ðŸ‡ºðŸ‡¸ Sub/Ing</button>
                </div>
                <div class="flex justify-between items-center text-[9px] text-gray-500 font-mono mt-2"><span>Resultados:</span><span id="total-sources" class="text-white font-bold">0</span></div>
            </div>
            <div id="server-list" class="flex-1 overflow-y-auto custom-scroll relative bg-grid"></div>
            <div class="p-3 bg-black border-t border-white/5 text-[8px] text-center text-gray-600 font-mono uppercase flex justify-between px-6"><span>JJMovies v3.0</span><span class="text-term-green flex items-center gap-1"><i class="fas fa-shield-alt"></i> Protected</span></div>
        </div>
    </div>

    <div id="global-loader" class="fixed inset-0 z-[200] bg-black hidden flex flex-col items-center justify-center font-mono">
        <i class="fas fa-satellite-dish text-6xl text-brand mb-6 animate-pulse"></i>
        <h2 class="text-2xl font-bold text-white tracking-widest mb-4">SEARCHING NETWORKS</h2>
        <div class="w-80 h-32 bg-[#0a0a0a] border border-brand/30 rounded p-4 text-[10px] text-term-green overflow-hidden relative shadow-neon">
            <div class="absolute inset-0 bg-scanline opacity-10 pointer-events-none"></div>
            <div id="terminal-logs" class="flex flex-col gap-1"></div>
        </div>
    </div>

    <script>
        const CFG = {
            API: '936410eebae74f9895643e085cc4a740', 
            // LISTA DE PROXIES ROTATIVOS (El Secreto)
            // Si uno falla, el cÃ³digo prueba el siguiente automaticamente.
            PROXIES: [
                'https://corsproxy.io/?',
                'https://api.codetabs.com/v1/proxy/?quest=',
                'https://api.allorigins.win/raw?url=',
                'https://thingproxy.freeboard.io/fetch/'
            ],
            BASE_TMDB: 'https://api.themoviedb.org/3'
        };

        const Core = {
            state: { id: null, type: 'movie', season: 1, episode: 1, sources: { 'LAT':[], 'ESP':[], 'ENG':[] }, currentTab: 'LAT', sidebarOpen: true },

            init: async () => {
                const p = new URLSearchParams(location.search);
                const id = p.get('id');
                if(!id) {
                    Core.updateMeta({ title: "JJMOVIES V3.0", overview: "Esperando ID." });
                    document.getElementById('hero-panel').classList.remove('opacity-0', 'translate-y-10');
                    return;
                }
                Core.state.id = id;
                Core.state.season = parseInt(p.get('season') || 1);
                Core.state.episode = parseInt(p.get('episode') || 1);
                if(p.get('season')) Core.state.type = 'tv';
                await Core.fetchTMDB();
            },

            fetchTMDB: async () => {
                try {
                    const { id, type, season, episode } = Core.state;
                    const url = `${CFG.BASE_TMDB}/${type}/${id}?api_key=${CFG.API}&language=es-MX&append_to_response=external_ids,credits`;
                    const res = await fetch(url);
                    const data = await res.json();

                    Core.state.imdb = data.external_ids?.imdb_id;
                    Core.state.totalSeasons = data.number_of_seasons || 0;
                    
                    let meta = { ...data };
                    if(type === 'tv') {
                        const sRes = await fetch(`${CFG.BASE_TMDB}/tv/${id}/season/${season}?api_key=${CFG.API}&language=es-MX`);
                        const sData = await sRes.json();
                        const ep = sData.episodes?.find(e => e.episode_number == episode) || {};
                        meta.backdrop_path = ep.still_path || data.backdrop_path;
                        meta.overview = ep.overview || data.overview;
                        meta.epName = ep.name;
                        Core.renderSelectors();
                    }
                    Core.updateMeta(meta);
                    if(data.credits && data.credits.cast) Core.renderCast(data.credits.cast);

                } catch(e) { console.error(e); }
            },

            updateMeta: (data) => {
                document.getElementById('movie-title').innerText = data.title || data.name;
                document.getElementById('movie-desc').innerText = data.overview || "No data.";
                document.getElementById('meta-year').innerText = (data.release_date || data.first_air_date || '----').split('-')[0];
                document.getElementById('meta-rating').innerText = data.vote_average?.toFixed(1) || '0.0';
                if(data.backdrop_path) {
                    document.getElementById('bg-backdrop').style.backgroundImage = `url('https://image.tmdb.org/t/p/original${data.backdrop_path}')`;
                    document.getElementById('bg-backdrop').classList.remove('opacity-0');
                }
                if(Core.state.type === 'tv') {
                    document.getElementById('series-controls').classList.remove('hidden');
                    document.getElementById('ep-name-display').innerText = `${data.epName || 'Ep ' + Core.state.episode}`;
                }
                document.getElementById('hero-panel').classList.remove('opacity-0', 'translate-y-10');
            },

            renderSelectors: () => {
                const s = document.getElementById('season-select');
                const e = document.getElementById('episode-select');
                s.innerHTML = ''; e.innerHTML = '';
                for(let i=1; i<=Core.state.totalSeasons; i++) s.innerHTML += `<option class="bg-black" value="${i}" ${i==Core.state.season?'selected':''}>TEMPORADA ${i}</option>`;
                for(let i=1; i<=50; i++) e.innerHTML += `<option class="bg-black" value="${i}" ${i==Core.state.episode?'selected':''}>EPISODIO ${i}</option>`;
                const go = () => window.location.href = `?id=${Core.state.id}&season=${s.value}&episode=${e.value}`;
                s.onchange = () => { e.value = 1; go(); };
                e.onchange = go;
            },

            renderCast: (cast) => {
                const container = document.getElementById('cast-list');
                const wrapper = document.getElementById('cast-container');
                container.innerHTML = '';
                if(!cast || cast.length === 0) return;
                wrapper.classList.remove('opacity-0');
                cast.slice(0, 15).forEach(actor => {
                    if(!actor.profile_path) return;
                    const div = document.createElement('div');
                    div.className = 'cast-card text-center';
                    div.onclick = () => Core.openActorProfile(actor.id, actor.name, actor.profile_path);
                    div.innerHTML = `<img src="https://image.tmdb.org/t/p/w200${actor.profile_path}" class="cast-img mb-2"><p class="text-[10px] font-bold text-gray-300 leading-tight">${actor.name}</p>`;
                    container.appendChild(div);
                });
            },

            openActorProfile: async (personId, name, imgPath) => {
                const modal = document.getElementById('actor-modal');
                const grid = document.getElementById('actor-movies-grid');
                document.getElementById('actor-name').innerText = name;
                document.getElementById('actor-profile-img').src = `https://image.tmdb.org/t/p/w200${imgPath}`;
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">Cargando...</div>';
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
                document.body.style.overflow = 'hidden';
                try {
                    const res = await fetch(`${CFG.BASE_TMDB}/person/${personId}/combined_credits?api_key=${CFG.API}&language=es-MX`);
                    const data = await res.json();
                    const cast = (data.cast || []).filter(c => c.poster_path && c.vote_count > 10).sort((a,b) => b.popularity - a.popularity);
                    grid.innerHTML = '';
                    cast.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'film-card group cursor-pointer';
                        card.onclick = () => window.location.href = `?id=${item.id}${item.media_type==='tv'?'&season=1&episode=1':''}`;
                        card.innerHTML = `<img src="https://image.tmdb.org/t/p/w300${item.poster_path}" class="w-full h-full object-cover transition-transform group-hover:scale-110"><div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-end p-2"><span class="text-[10px] font-bold text-white leading-tight">${item.title || item.name}</span></div>`;
                        grid.appendChild(card);
                    });
                } catch(e) { grid.innerHTML = 'Error.'; }
            },

            closeActorModal: () => {
                const modal = document.getElementById('actor-modal');
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 500);
                document.body.style.overflow = '';
            },

            start: async () => {
                const l = document.getElementById('global-loader');
                const log = document.getElementById('terminal-logs');
                l.classList.remove('hidden');
                const addLog = (txt) => { log.innerHTML += `<span>> ${txt}</span>`; log.scrollTop = log.scrollHeight; };

                Core.state.sources = { 'LAT': [], 'ESP': [], 'ENG': [] };

                addLog("Iniciando Rastreo Multi-Proxy...");
                const tasks = [];
                
                if(Core.state.imdb) {
                    tasks.push(Scraper.verHD().then(() => addLog("VerHD Escaneado.")));
                    tasks.push(Scraper.embed69().then(() => addLog("Embed69 Escaneado.")));
                }
                
                Core.addSource('ENG', { name: "VidSrc", url: Scraper.getVidSrc(), clean: false, shield: true });
                Core.addSource('ENG', { name: "UEmbed", url: Scraper.getUEmbed(), clean: false, shield: true });

                await Promise.allSettled(tasks);

                addLog("Resultados listos.");
                setTimeout(() => {
                    l.classList.add('hidden');
                    Core.openPlayer();
                    
                    // Auto-select tab
                    if(Core.state.sources['LAT'].length > 0) Core.switchTab('LAT');
                    else if(Core.state.sources['ESP'].length > 0) Core.switchTab('ESP');
                    else Core.switchTab('ENG');

                    // Auto-Play
                    const currentList = Core.state.sources[Core.state.currentTab];
                    if(currentList.length > 0) Core.play(0);

                }, 800);
            },

            addSource: (lang, src) => {
                // Ensure proper category
                let targetLang = 'ENG';
                if(lang.toLowerCase().includes('lat')) targetLang = 'LAT';
                else if(lang.toLowerCase().includes('esp') || lang.toLowerCase().includes('cas')) targetLang = 'ESP';
                
                // Avoid duplicates
                if(!Core.state.sources[targetLang].some(s => s.url === src.url)) {
                    Core.state.sources[targetLang].push(src);
                }
            },

            switchTab: (tab) => {
                Core.state.currentTab = tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.getElementById(`tab-${tab}`).classList.add('active');
                Core.renderList();
            },

            renderList: () => {
                const c = document.getElementById('server-list');
                c.innerHTML = '';
                const list = Core.state.sources[Core.state.currentTab];
                
                document.getElementById('total-sources').innerText = `${list.length} NODES`;

                if(list.length === 0) {
                    c.innerHTML = '<div class="text-center text-gray-500 mt-10 text-xs">Sin servidores en este idioma.</div>';
                    return;
                }

                // Prioritize Clean
                list.sort((a,b) => (a.clean === b.clean) ? 0 : a.clean ? -1 : 1);

                list.forEach((src, idx) => {
                    const item = document.createElement('div');
                    item.className = 'server-item p-3 border-b border-white/5 cursor-pointer group flex justify-between items-center';
                    item.onclick = () => Core.play(idx);
                    item.dataset.idx = idx;
                    
                    const icon = src.clean 
                        ? '<i class="fas fa-shield-alt text-term-green text-xs" title="Limpio"></i>' 
                        : '<i class="fas fa-external-link-alt text-gray-600 text-[10px]" title="Posibles Ads"></i>';
                    
                    item.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="text-[9px] font-mono text-gray-600">${idx+1}</div>
                            <span class="text-xs font-bold text-gray-300 group-hover:text-white transition-colors">${src.name}</span>
                        </div>
                        ${icon}
                    `;
                    c.appendChild(item);
                });
            },

            play: (idx) => {
                const list = Core.state.sources[Core.state.currentTab];
                const src = list[idx];
                const frame = document.getElementById('video-frame');
                const loader = document.getElementById('internal-loader');
                const shield = document.getElementById('click-shield');
                
                document.querySelectorAll('.server-item').forEach(el => el.classList.remove('active'));
                const activeEl = document.querySelector(`.server-item[data-idx="${idx}"]`);
                if(activeEl) activeEl.classList.add('active');
                
                document.getElementById('playing-server-name').innerText = src.name;
                
                frame.classList.add('hidden');
                loader.classList.remove('hidden');
                
                if(src.shield || !src.clean) {
                    shield.classList.remove('hidden');
                } else {
                    shield.classList.add('hidden');
                }

                frame.removeAttribute('sandbox'); 
                
                setTimeout(() => {
                    frame.src = src.url;
                    frame.onload = () => { loader.classList.add('hidden'); frame.classList.remove('hidden'); };
                    setTimeout(() => { loader.classList.add('hidden'); frame.classList.remove('hidden'); }, 2000);
                }, 200);
            },

            removeShield: () => {
                document.getElementById('click-shield').classList.add('hidden');
                console.log("Shield removed.");
            },

            openPlayer: () => {
                const ui = document.getElementById('player-overlay');
                ui.classList.remove('hidden');
                setTimeout(() => ui.classList.remove('opacity-0'), 50);
            },

            close: () => {
                const ui = document.getElementById('player-overlay');
                ui.classList.add('opacity-0');
                setTimeout(() => { ui.classList.add('hidden'); document.getElementById('video-frame').src = 'about:blank'; }, 500);
            },

            toggleSidebar: () => {
                const v = document.getElementById('video-area');
                const s = document.getElementById('sidebar-area');
                const txt = document.getElementById('toggle-text');
                Core.state.sidebarOpen = !Core.state.sidebarOpen;
                if(Core.state.sidebarOpen) {
                    v.classList.remove('full-width'); v.classList.add('w-[75%]');
                    s.classList.remove('no-sidebar'); s.classList.add('w-[25%]');
                    txt.innerText = "Expandir";
                } else {
                    v.classList.remove('w-[75%]'); v.classList.add('full-width');
                    s.classList.remove('w-[25%]'); s.classList.add('no-sidebar');
                    txt.innerText = "Cambiar de Servidor";
                }
            }
        };

        const Scraper = {
            // FUNCIÃ“N MÃGICA: PROBAR MÃšLTIPLES PROXIES HASTA QUE UNO FUNCIONE
            fetchSafe: async (url) => {
                for (let proxy of CFG.PROXIES) {
                    try {
                        const res = await fetch(proxy + encodeURIComponent(url));
                        if(res.ok) return await res.text();
                    } catch(e) {}
                }
                return null; 
            },
            base64UrlDecode: (str) => {
                str = str.replace(/-/g, '+').replace(/_/g, '/');
                return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
            },
            decodeJWT: (token) => {
                try { return JSON.parse(Scraper.base64UrlDecode(token.split('.')[1])); } catch { return null; }
            },
            getVidSrc: () => { const { id, type, season, episode } = Core.state; return type==='movie' ? `https://vidsrc.cc/v2/embed/movie/${id}` : `https://vidsrc.cc/v2/embed/tv/${id}/${season}/${episode}`; },
            getUEmbed: () => { const { id, type, season, episode } = Core.state; let u = `https://uembed.xyz/?id=${id}`; if(type==='tv') u+= `&season=${season}&episode=${episode}`; return u; },

            embed69: async () => {
                try {
                    const { imdb, type, season, episode } = Core.state;
                    const slug = type==='tv' ? `${imdb}-${season}x${String(episode).padStart(2,'0')}` : imdb;
                    const html = await Scraper.fetchSafe(`https://embed69.org/f/${slug}/`);
                    if(!html) return;

                    const match = html.match(/let dataLink\s*=\s*(\[[\s\S]*?\]);/);
                    if(match) {
                        const data = JSON.parse(match[1]);
                        data.forEach(item => {
                            let lang = item.video_language || 'ENG';
                            item.sortedEmbeds.forEach(embed => {
                                const decoded = Scraper.decodeJWT(embed.link);
                                if(decoded && decoded.link) {
                                    const host = embed.servername.toLowerCase();
                                    let url = decoded.link;
                                    let clean = false;
                                    let name = embed.servername;

                                    if(['voe','streamwish','dood','vidhide','filemoon'].some(h => host.includes(h))) {
                                        const idMatch = url.match(/\/([a-zA-Z0-9]+)$/) || url.match(/\/e\/([a-zA-Z0-9]+)/);
                                        if(idMatch) {
                                            let hCode = 'voe';
                                            if(host.includes('wish')) hCode = 'streamwish';
                                            if(host.includes('dood')) hCode = 'doodstream';
                                            if(host.includes('hide')) hCode = 'vidhide';
                                            Core.addSource(lang, { name: `${name} (Limpio)`, url: `https://unlimplay.com/embed2/?host=${hCode}&id=${idMatch[1]}`, clean: true });
                                            clean = true;
                                        }
                                    }
                                    if(!clean) Core.addSource(lang, { name: name, url: url, clean: false, shield: true });
                                }
                            });
                        });
                    }
                } catch(e) {}
            },

            verHD: async () => {
                try {
                    const html = await Scraper.fetchSafe(`https://verhdlink.cam/movie/${Core.state.imdb}`);
                    if(!html) return;
                    
                    const matches = html.matchAll(/dropload\.tv\/e\/([a-zA-Z0-9_-]+)/g);
                    for(const m of matches) {
                        Core.addSource('LAT', { name: "Thunderbolt (Ultra)", url: `https://unlimplay.com/embed2/?host=dropload&id=${m[1]}`, clean: true });
                    }
                    const vip = html.matchAll(/streamwish\.to\/e\/([a-zA-Z0-9]+)/g);
                    for(const v of vip) {
                        Core.addSource('LAT', { name: "VIP Server", url: `https://unlimplay.com/embed2/?host=streamwish&id=${v[1]}`, clean: true });
                    }
                } catch(e) {}
            }
        };

        window.onload = Core.init;
    </script>
</body>
</html>
